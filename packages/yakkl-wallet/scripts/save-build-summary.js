#!/usr/bin/env node

/**
 * Save Build Summary Script
 * Saves build summaries to docs/build directory with timestamp
 * 
 * Usage: node scripts/save-build-summary.js "title" "content"
 * Or programmatically: saveBuildSummary(title, content)
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

function getESTTimestamp() {
  const now = new Date();
  // Convert to EST/EDT
  const estDate = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
  
  const year = estDate.getFullYear();
  const month = String(estDate.getMonth() + 1).padStart(2, '0');
  const day = String(estDate.getDate()).padStart(2, '0');
  const hours = String(estDate.getHours()).padStart(2, '0');
  const minutes = String(estDate.getMinutes()).padStart(2, '0');
  const seconds = String(estDate.getSeconds()).padStart(2, '0');
  
  return {
    date: `${year}-${month}-${day}`,
    time: `${hours}:${minutes}:${seconds}`,
    filename: `${year}-${month}-${day}_${hours}-${minutes}-${seconds}`
  };
}

function saveBuildSummary(title, content) {
  const timestamp = getESTTimestamp();
  const docsDir = path.join(__dirname, '..', 'docs', 'build');
  
  // Ensure directory exists
  if (!fs.existsSync(docsDir)) {
    fs.mkdirSync(docsDir, { recursive: true });
  }
  
  // Sanitize title for filename
  const safeTitle = title.toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '')
    .substring(0, 50);
  
  const filename = `${timestamp.filename}_${safeTitle}.md`;
  const filepath = path.join(docsDir, filename);
  
  // Prepare content with header
  const fullContent = `# Build Summary Report
**Date:** ${timestamp.date}  
**Time:** ${timestamp.time} EST  
**Title:** ${title}  

${content}

---
*This summary was automatically generated by the build system.*`;
  
  // Write file
  fs.writeFileSync(filepath, fullContent, 'utf8');
  console.log(`âœ… Build summary saved to: docs/build/${filename}`);
  
  return filepath;
}

// CLI usage
const args = process.argv.slice(2);

if (args.length < 2) {
  console.error('Usage: node save-build-summary.js "title" "content"');
  process.exit(1);
}

const [title, content] = args;
saveBuildSummary(title, content);

export { saveBuildSummary, getESTTimestamp };