{"version":3,"file":"_page.svelte.js","sources":["../../../../../../../../../src/routes/(dapp)/dapp/popups/permissions/+page.svelte"],"sourcesContent":["<script lang=\"ts\">\n\timport { browser_ext, browserSvelte } from '$lib/common/environment';\n\timport { page } from '$app/state';\n\timport {\n\t\tgetYakklCurrentlySelected,\n\t\tgetMiscStore,\n\t\tyakklDappConnectRequestStore,\n\t\tgetSettings\n\t} from '$lib/common/stores';\n\timport { type YakklCurrentlySelected } from '$lib/common';\n\timport { DEFAULT_TITLE, YAKKL_DAPP } from '$lib/common/constants';\n\timport { onMount } from 'svelte';\n\timport { log } from '$lib/common/logger-wrapper';\n\timport type { Runtime } from 'webextension-polyfill';\n\timport type { JsonRpcResponse, SessionInfo } from '$lib/common/interfaces';\n\timport type { BackgroundPendingRequest } from '$lib/extensions/chrome/background';\n\timport Confirmation from '$lib/components/Confirmation.svelte';\n\timport { requestSigning } from '$lib/extensions/chrome/signingClient';\n\timport Copyright from '$lib/components/Copyright.svelte';\n\timport Warning from '$lib/components/Warning.svelte';\n\timport Failed from '$lib/components/Failed.svelte';\n\timport {\n\t\tcreatePortManagerWithStream,\n\t\tPortManagerWithStream\n\t} from '$lib/managers/PortManagerWithStream';\n\timport type { PortDuplexStream } from '$lib/managers/PortStreamManager';\n\timport { sessionToken, verifySessionToken } from '$lib/common/auth/session';\n\timport { safeLogout } from '$lib/common/safeNavigate';\n\n\ttype RuntimePort = Runtime.Port | undefined;\n\n\tlet currentlySelected: YakklCurrentlySelected;\n\tlet yakklMiscStore: string;\n\n\tlet showConfirm = $state(false);\n\tlet showSuccess = $state(false);\n\tlet showFailure = $state(false);\n\tlet errorValue = $state('No domain/site name was found. Access to YAKKL® is denied.');\n\n\tlet domain: string = $state('');\n\tlet domainLogo: string = $state('');\n\tlet domainTitle: string = $state('');\n\tlet title: string = $state(DEFAULT_TITLE);\n\tlet request: BackgroundPendingRequest;\n\tlet method: string;\n\tlet requestId: string | null;\n\tlet message: any = $state(''); // This gets passed letting the user know what the intent is\n\tlet address: string = $state('');\n\n\tlet params: any[] = $state([]);\n\n\tlet permissions: any[] = $state([]);\n\tlet messageValue; // Used to display non-hex data that matches transaction or message\n\tlet pass = false;\n\n\tlet portManager: PortManagerWithStream | null = null;\n\tlet stream: PortDuplexStream | null = null;\n\n\tif (browserSvelte) {\n\t\ttry {\n\t\t\trequestId = page.url.searchParams.get('requestId');\n\t\t\tmethod = (page.url.searchParams.get('method') as string) ?? '';\n\t\t\t$yakklDappConnectRequestStore = requestId as string; // NOT SURE IF THIS IS NEEDED here\n\n\t\t\tif (requestId) {\n\t\t\t\tpass = true;\n\t\t\t}\n\t\t\t// NOTE: The internal check now makes sure the requestId is valid\n\t\t} catch (e) {\n\t\t\tlog.error(e);\n\t\t\thandleReject('No requestId or method was found. Access to YAKKL® is denied.');\n\t\t}\n\t}\n\n\t// We no longer need to do get_params since we can access the request data directly\n\tasync function onMessageListener(event: any) {\n\t\ttry {\n\t\t\tif (!domainLogo) domainLogo = '/images/failIcon48x48.png'; // Set default logo but change if favicon is present\n\n\t\t\tif (event.method === 'get_params') {\n\t\t\t\trequest = event.result;\n\t\t\t\tif (!request || !request.data) {\n\t\t\t\t\treturn await handleReject('No request was found. Access to YAKKL® is denied.');\n\t\t\t\t}\n\n\t\t\t\tconst requestData = request.data;\n\t\t\t\tif (\n\t\t\t\t\t!requestData ||\n\t\t\t\t\t!requestData.params ||\n\t\t\t\t\t!requestData.params[0] ||\n\t\t\t\t\t!requestData.metaData\n\t\t\t\t) {\n\t\t\t\t\treturn await handleReject('Invalid request data. Access to YAKKL® is denied.');\n\t\t\t\t}\n\n\t\t\t\tif (!requestData.metaData.metaData.isConnected) {\n\t\t\t\t\treturn await handleReject(\n\t\t\t\t\t\t'Domain is not connected. Connect to {domain} first via requestAccounts. Access to YAKKL® is denied.'\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\t// These needs to be fixed upstream\n\t\t\t\tdomainTitle = requestData.metaData.metaData.title;\n\t\t\t\tdomain = requestData.metaData.metaData.domain;\n\t\t\t\tdomainLogo = requestData.metaData.metaData.icon;\n\t\t\t\tmessage =\n\t\t\t\t\trequestData.metaData.metaData.message ??\n\t\t\t\t\t'Nothing was passed to explain the intent of this approval. Be mindful of this request!';\n\t\t\t\tparams = requestData.params ?? [];\n\t\t\t\t// Make sure params is an array\n\t\t\t\tif (!Array.isArray(params)) {\n\t\t\t\t\tparams = [params];\n\t\t\t\t}\n\n\t\t\t\tif (!requestId) requestId = requestData?.id ?? null;\n\t\t\t\tif (!requestId) {\n\t\t\t\t\treturn await handleReject('No request ID was found. Access to YAKKL® is denied.');\n\t\t\t\t}\n\n\t\t\t\t// Set the page title\n\t\t\t\ttitle = domainTitle || domain || DEFAULT_TITLE;\n\n\t\t\t\tlet data;\n\t\t\t\tswitch (method) {\n\t\t\t\t\tcase 'wallet_requestPermissions': // Only used at the moment\n\t\t\t\t\t\tpermissions = params[0];\n\t\t\t\t\t\tlog.info('Permissions:', false, permissions);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'wallet_revokePermissions':\n\t\t\t\t\t\tpermissions = params[0];\n\t\t\t\t\t\tlog.info('Revoke Permissions:', false, permissions);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'wallet_getPermissions':\n\t\t\t\t\t\tpermissions = params[0];\n\t\t\t\t\t\tlog.info('Get Permissions:', false, permissions);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tmessageValue = 'No message request was passed in. Error.';\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tlog.error(e);\n\t\t\tawait handleReject(\n\t\t\t\t'An error occurred while processing the request. Access to YAKKL® is denied.'\n\t\t\t);\n\t\t}\n\t}\n\n\tonMount(async () => {\n\t\ttry {\n\t\t\tif (browserSvelte) {\n\t\t\t\tconst settings = await getSettings();\n\t\t\t\tif (!settings.init || !settings.legal.termsAgreed) {\n\t\t\t\t\terrorValue =\n\t\t\t\t\t\t\"You must register and agree to the terms of service before using YAKKL®. Click on 'Open Wallet' to register.\";\n\t\t\t\t\tshowFailure = true;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tcurrentlySelected = await getYakklCurrentlySelected();\n\n\t\t\t\t// Since we're 1:1 we can attach to the known port name\n\t\t\t\tconst sessionInfo = (await browser_ext.runtime.sendMessage({\n\t\t\t\t\ttype: 'REQUEST_SESSION_PORT',\n\t\t\t\t\trequestId\n\t\t\t\t})) as SessionInfo;\n\n\t\t\t\tlog.info('Received session info:', false, sessionInfo);\n\n\t\t\t\t// Guard against null response\n\t\t\t\tif (!sessionInfo || !sessionInfo.success) {\n\t\t\t\t\tlog.warn('Failed to verify session port. No response received. Using YAKKL_DAPP.');\n\t\t\t\t}\n\n\t\t\t\t// Create port manager with the original port name\n\t\t\t\tportManager = createPortManagerWithStream(sessionInfo?.portName ?? YAKKL_DAPP);\n\t\t\t\tportManager.setRequestId(requestId);\n\n\t\t\t\tconst success = await portManager.createPort();\n\t\t\t\tif (!success) {\n\t\t\t\t\terrorValue = 'Failed to connect to session port.';\n\t\t\t\t\tshowFailure = true;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Connect to existing port\n\t\t\t\tstream = portManager.getStream();\n\t\t\t\tif (!stream) {\n\t\t\t\t\terrorValue = 'Stream is not available.';\n\t\t\t\t\tshowFailure = true;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tstream.on('data', onMessageListener);\n\t\t\t\tstream.write({ method: 'get_params', id: requestId });\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tlog.error(e);\n\t\t\terrorValue =\n\t\t\t\t'Port setuperror occurred while processing the request. Access to YAKKL® is denied.';\n\t\t\tshowFailure = true;\n\t\t}\n\t});\n\n\tasync function handleReject(message: string = 'User rejected the request.') {\n\t\ttry {\n\t\t\tif (browserSvelte) {\n\t\t\t\tshowConfirm = false;\n\t\t\t\tshowFailure = false;\n\t\t\t\tshowSuccess = false;\n\t\t\t\tif (stream) {\n\t\t\t\t\tstream.write({\n\t\t\t\t\t\ttype: 'YAKKL_RESPONSE:EIP6963',\n\t\t\t\t\t\tjsonrpc: '2.0',\n\t\t\t\t\t\tid: requestId,\n\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\tcode: 4001,\n\t\t\t\t\t\t\tmessage\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tlog.error(e);\n\t\t} finally {\n\t\t\tclose();\n\t\t}\n\t}\n\n\tasync function handleProcess() {\n\t\ttry {\n\t\t\tif (!browserSvelte) {\n\t\t\t\tawait handleReject();\n\t\t\t}\n\n\t\t\tif (!verifySessionToken($sessionToken)) {\n\t\t\t\tawait handleReject('Session token is invalid. Login again.');\n\t\t\t}\n\n\t\t\t// Will need to be more dynamic in the future once more items are standardized\n\t\t\tpermissions = [\n\t\t\t\t{\n\t\t\t\t\tparentCapability: 'eth_accounts',\n\t\t\t\t\tcaveats: []\n\t\t\t\t}\n\t\t\t];\n\n\t\t\t// Send response to dapp\n\t\t\tif (stream) {\n\t\t\t\tconst jsonRpcResponse: JsonRpcResponse = {\n\t\t\t\t\ttype: 'YAKKL_RESPONSE:EIP6963',\n\t\t\t\t\tjsonrpc: '2.0',\n\t\t\t\t\tid: requestId,\n\t\t\t\t\tresult: permissions\n\t\t\t\t};\n\t\t\t\tstream.write(jsonRpcResponse);\n\t\t\t\tlog.info('Sign: handleProcess - response:', false, { jsonRpcResponse });\n\t\t\t} else {\n\t\t\t\tawait handleReject('Request failed to send to dapp due to connection port not found.');\n\t\t\t}\n\t\t\tclose();\n\t\t} catch (e) {\n\t\t\tlog.error(e);\n\t\t\terrorValue = e instanceof Error ? e.message : 'Unknown error occurred';\n\t\t\tshowFailure = true;\n\t\t}\n\t}\n\n\tasync function close() {\n\t\tif (browserSvelte) {\n\t\t\ttry {\n\t\t\t\tif (portManager) {\n\t\t\t\t\tawait portManager.waitForIdle(1500);\n\t\t\t\t\tportManager.disconnect();\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tlog.warn('Port did not go idle in time', false, e);\n\t\t\t}\n\t\t\tsafeLogout();\n\t\t}\n\t}\n\n\tfunction handleConfirm() {\n\t\tshowConfirm = true;\n\t}\n</script>\n\n<svelte:head>\n\t<title>{title}</title>\n</svelte:head>\n\n<!-- <Warning bind:show={showFailure} title=\"Error\" value={errorValue} /> -->\n<Failed bind:show={showFailure} title=\"Failed!\" content={errorValue} onReject={handleReject} />\n<Confirmation\n\tbind:show={showConfirm}\n\ttitle=\"Connect to {domain}\"\n\tmessage=\"This will grant permission for {domain} to access your account(s)! Do you wish to continue?\"\n\tonConfirm={handleProcess}\n/>\n\n<div class=\"flex flex-col h-full max-h-screen overflow-hidden\">\n\t<!-- Header -->\n\t<div class=\"p-4 border-b border-base-300 flex-shrink-0\">\n\t\t<div class=\"flex items-center justify-between\">\n\t\t\t<div class=\"flex items-center gap-2 min-w-0\">\n\t\t\t\t<img\n\t\t\t\t\tid=\"dappImageId\"\n\t\t\t\t\tcrossorigin=\"anonymous\"\n\t\t\t\t\tsrc={domainLogo}\n\t\t\t\t\talt=\"Dapp logo\"\n\t\t\t\t\tclass=\"w-8 h-8 rounded-full flex-shrink-0\"\n\t\t\t\t/>\n\t\t\t\t<span class=\"font-semibold truncate\" title={domainTitle || domain}\n\t\t\t\t\t>{domainTitle || domain}</span\n\t\t\t\t>\n\t\t\t</div>\n\t\t\t<button\n\t\t\t\tonclick={() => handleReject()}\n\t\t\t\tclass=\"btn btn-ghost btn-sm flex-shrink-0\"\n\t\t\t\taria-label=\"Close\"\n\t\t\t>\n\t\t\t\t<svg\n\t\t\t\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\t\t\t\tclass=\"h-5 w-5\"\n\t\t\t\t\tviewBox=\"0 0 20 20\"\n\t\t\t\t\tfill=\"currentColor\"\n\t\t\t\t>\n\t\t\t\t\t<path\n\t\t\t\t\t\tfill-rule=\"evenodd\"\n\t\t\t\t\t\td=\"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z\"\n\t\t\t\t\t\tclip-rule=\"evenodd\"\n\t\t\t\t\t/>\n\t\t\t\t</svg>\n\t\t\t</button>\n\t\t</div>\n\t</div>\n\n\t<!-- Content-->\n\t<div class=\"flex-1 p-6 flex flex-col max-w-[428px]\">\n\t\t<div class=\"text-center mb-4 flex-shrink-0 border-2 border-red-500 rounded-md p-2\">\n\t\t\t<p class=\"text-md font-extrabold animate-pulse mb-2\">Important!:</p>\n\t\t\t<span class=\"text-sm font-bold mb-2\"\n\t\t\t\t>Granting permission to access your account(s): PLEASE be mindful and know what you are\n\t\t\t\tdoing.</span\n\t\t\t>\n\t\t\t<span class=\"text-sm font-bold mb-2\"\n\t\t\t\t>Permissions can be revoked at any time! Be 100% sure or REJECT this process and research\n\t\t\t\tmore before trying again.</span\n\t\t\t>\n\t\t</div>\n\n\t\t<div class=\"overflow-auto flex-1 min-h-0 mb-4\">\n\t\t\t<span class=\"text-sm\">Permissions:</span>\n\t\t\t<pre\n\t\t\t\tclass=\"text-md border-2 border-blue-500 rounded-md p-2 bg-opacity-25\">(your account(s))</pre>\n\t\t</div>\n\t</div>\n\n\t<!-- Footer -->\n\t<div class=\"p-4 border-t border-base-300 flex-shrink-0\">\n\t\t<div class=\"flex gap-4 justify-end\">\n\t\t\t<button onclick={() => handleReject()} class=\"btn btn-outline\"> Reject </button>\n\t\t\t<button onclick={handleConfirm} class=\"btn btn-primary\"> Approve </button>\n\t\t</div>\n\t</div>\n</div>\n\n<Copyright />\n\n<style>\n\t/* Smooth transitions */\n\t.btn {\n\t\ttransition: all 0.2s ease;\n\t}\n\n\t.btn:hover {\n\t\ttransform: translateY(-1px);\n\t}\n</style>\n"],"names":["showConfirm","showSuccess","showFailure","errorValue","domain","domainLogo","title","DEFAULT_TITLE","method","requestId","permissions","pass","portManager","stream","browserSvelte","page","url","searchParams","get","$.store_set","yakklDappConnectRequestStore","e","log","error","handleReject","async","message","close","handleProcess","verifySessionToken","$.store_get","$$store_subs","sessionToken","parentCapability","caveats","Error","warn","safeLogout","$$value","$$payload","out","$.attr","$.escape"],"mappings":"6mCAkCK,IAAAA,YAAqB,MACrB,IAAAC,YAAqB,MACrB,IAAAC,YAAqB,MACrB,IAAAC,WAAoB,6DAEpB,IAAAC,OAAwB,GACxB,IAAAC,WAA4B,GAE5B,IAAAC,MAAuBC,cAEvB,IAAAC,OACA,IAAAC,UAMA,IAAAC,YAAA,OAEAC,KAAO,UAEPC,YAA4C,SAC5CC,OAAkC,QAElCC,cAAe,CACd,IACHL,UAAYM,KAAKC,IAAIC,aAAaC,IAAI,aACtCV,OAAUO,KAAKC,IAAIC,aAAaC,IAAI,WAAwB,GAC5BC,UAAAC,6BAAAX,cAE5BA,UAAW,CACPE,KAAA,IACR,CAED,OAASU,GACRC,IAAIC,MAAMF,GACVG,aAAa,gEACd,CACD,CAoIeC,eAAAD,aAAaE,SAAkB,8BACzC,OACCZ,cAAe,CACJd,YAAA,MACAE,YAAA,MACAD,YAAA,SACVY,QAWL,CACD,OAASQ,GACRC,IAAIC,MAAMF,GACT,QACDM,OACD,CACD,gBAEeC,gBACV,QACEd,cAAe,OACbU,cACP,KAEKK,mBAAmCC,UAAAC,eAAA,CAAA,EAAA,gBAAAC,eAAA,OACjCR,aAAa,yCACpB,CAGAd,YAAA,CAEE,CAAAuB,iBAAkB,eAClBC,QAAA,QAKErB,YASG,OACAW,aAAa,mEACpB,CACAG,OACD,OAASN,GACRC,IAAIC,MAAMF,GACGlB,WAAAkB,aAAac,MAAQd,EAAEK,QAAU,yBAChCxB,YAAA,IACf,CACD,gBAEeyB,WACVb,cAAe,CACd,OACCF,aAIL,OAASS,GACJC,IAAAc,KAAK,+BAAgC,MAAOf,EACjD,CACAgB,YACD,CACD,gJAQQ/B,8DAIgDH,oBAAsBqB,wBAA5D,OAAAtB,+BAAWA,YAAAoC,mHAGVlC,8DACsBA,wEAC9BwB,yBAHA,OAAA5B,+BAAWA,YAAAsC,uiBAcbjC,8HAIsCkC,WAAAC,KAAA,wCAAAC,KAAA,QAAerC,iDACxDmC,WAAAC,KAAA,GAAAE,YAAetC"}