import{p as push,j as store_set,h as copy_payload,i as assign_payload,c as pop,r as head,a as push_element,m as attr,b as pop_element,e as escape_html,g as stringify}from"../../../../../../chunks/index2.js";import{b as browserSvelte,c as isClient,g as getBrowserExt,a as browser_ext}from"../../../../../../chunks/environment.js";import{p as page}from"../../../../../../chunks/index3.js";import{l as log,b as yakklDappConnectRequestStore,aK as YAKKL_DAPP,_ as DEFAULT_TITLE}from"../../../../../../chunks/encryption.js";import{C as Copyright}from"../../../../../../chunks/Copyright.js";import{F as Failed}from"../../../../../../chunks/Failed.js";import"../../../../../../chunks/Warning.js";import{C as Confirmation}from"../../../../../../chunks/Confirmation.js";import{s as safeLogout,a as safeNavigate}from"../../../../../../chunks/safeNavigate.js";import"../../../../../../chunks/Logger.js";import{F as FILENAME}from"../../../../../../chunks/utils.js";async function getDuplex(){if(browserSvelte){const mod=await import("stream-browserify");return mod.Duplex}else{const mod=await import("readable-stream");return mod.Duplex}}class PortDuplexStream{port;stream;inflight=0;constructor(port,stream){this.port=port;this.stream=stream;this.port.onMessage.addListener(this._onMessage.bind(this));this.port.onDisconnect.addListener(()=>this.destroy())}_onMessage(message){try{log.info("PortDuplexStream _onMessage:",false,message);this.inflight=Math.max(0,this.inflight-1);this.stream.push(message)}catch(err){log.error("PortDuplexStream _onMessage error",false,err)}}write(msg){log.info("PortDuplexStream write:",false,msg);this.inflight++;this.port.postMessage(msg)}on(event,handler){log.info("PortDuplexStream on:",false,event);this.stream.on(event,handler)}destroy(){log.info("PortDuplexStream destroy:",false);this.port.disconnect();this.stream.destroy()}isIdle(){return this.inflight===0}async waitForIdle(timeout=3e3){log.info("PortDuplexStream waitForIdle:",false,timeout);const start=Date.now();return new Promise((resolve,reject)=>{const check=()=>{if(this.isIdle())return resolve();if(Date.now()-start>timeout)return reject(new Error("Timed out waiting for port to go idle"));setTimeout(check,50)};check()})}}class PortManagerWithStream{port=null;stream=null;requestId=null;name;constructor(name){this.name=name}async createPort(){if(this.port&&this.stream)return true;const ext=isClient?getBrowserExt():browser_ext;if(!ext||!ext.runtime?.connect){log.error("Extension API not available for PortManagerWithStream");return false}try{this.port=ext.runtime.connect({name:this.name});const Duplex=await getDuplex();class CustomDuplex extends Duplex{constructor(){super({objectMode:true})}_read(){}_write(_chunk,_enc,cb){cb()}write(chunk){super.write(chunk)}on(event,handler){super.on(event,handler)}destroy(){super.destroy()}}const baseStream=new CustomDuplex;this.stream=new PortDuplexStream(this.port,baseStream);return true}catch(error){log.error("Failed to create port stream",false,error);this.port=null;this.stream=null;return false}}getStream(){return this.stream}getPort(){return this.port}isIdle(){return this.stream?.isIdle()??true}async waitForIdle(timeout=3e3){return this.stream?.waitForIdle(timeout)}disconnect(){try{if(this.port&&this.requestId){browser_ext.runtime.sendMessage({type:"UNREGISTER_SESSION_PORT",requestId:this.requestId})}this.stream?.destroy()}catch(err){log.warn("Error destroying port stream",false,err)}this.stream=null;this.port=null;this.requestId=null}setRequestId(requestId){this.requestId=requestId}getRequestId(){return this.requestId}clearRequestId(){this.requestId=null}}function createPortManagerWithStream(name="secure"){return new PortManagerWithStream(name)}_page[FILENAME]="src/routes/(dapp)/dapp/popups/approve/+page.svelte";function _page($$payload,$$props){push(_page);let showConfirm=false;let showSuccess=false;let showFailure=false;let errorValue="No domain/site name was found. Access to YAKKL® is denied.";let domain="";let domainLogo="";let title=DEFAULT_TITLE;let requestId=null;let method="";let portManager=createPortManagerWithStream(YAKKL_DAPP);if(browserSvelte){try{requestId=page.url.searchParams.get("requestId");const methodParam=page.url.searchParams.get("method");if(methodParam)method=methodParam;store_set(yakklDappConnectRequestStore,requestId)}catch(e){log.error(e);handleReject("No requestId or methodwas found. Access to YAKKL® is denied.")}}async function handleProcess(){if(!browserSvelte)return;try{sessionStorage.setItem("yakklSigningRequest",JSON.stringify({requestId:requestId,method:method}));return safeNavigate("/dapp/login?requestId="+requestId+"&method="+method)}catch(e){errorValue=e;showFailure=true}}async function handleReject(message2="User rejected the request."){try{showConfirm=false;showFailure=false;showSuccess=false;errorValue="";const port=portManager?.getPort();if(port){port.postMessage({id:requestId,method:"error",response:{type:"YAKKL_RESPONSE",data:{name:"ProviderRpcError",code:4001,message:message2}}})}try{if(portManager){await portManager.waitForIdle(1500);portManager.disconnect()}}catch(e){log.warn("Port did not go idle in time",false,e)}}catch(e){log.error(e)}finally{safeLogout()}}let $$settled=true;let $$inner_payload;function $$render_inner($$payload2){head($$payload2,$$payload3=>{$$payload3.title=`<title>${escape_html(title)}</title>`});Failed($$payload2,{title:"Failed!",content:errorValue,onReject:handleReject,get show(){return showFailure},set show($$value){showFailure=$$value;$$settled=false}});$$payload2.out+=`\x3c!----\x3e `;Confirmation($$payload2,{title:`Connect to ${stringify(domain)}`,message:`This will connect ${stringify(domain)} to YAKKL®. Do you wish to continue?`,onConfirm:handleProcess,onReject:handleReject,get show(){return showConfirm},set show($$value){showConfirm=$$value;$$settled=false}});$$payload2.out+=`\x3c!----\x3e <div class="flex flex-col h-full max-h-screen overflow-hidden">`;push_element($$payload2,"div",195,0);$$payload2.out+=`<div class="p-4 border-b border-base-300 flex-shrink-0">`;push_element($$payload2,"div",197,1);$$payload2.out+=`<div class="flex items-center justify-between">`;push_element($$payload2,"div",198,2);$$payload2.out+=`<div class="flex items-center gap-2 min-w-0">`;push_element($$payload2,"div",199,3);$$payload2.out+=`<img id="dappImageId" crossorigin="anonymous"${attr("src",domainLogo)} alt="Dapp logo" class="w-8 h-8 rounded-full flex-shrink-0"/>`;push_element($$payload2,"img",200,4);pop_element();$$payload2.out+=` <span class="font-semibold truncate">`;push_element($$payload2,"span",207,4);$$payload2.out+=`${escape_html(title)}</span>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=` <button class="btn btn-ghost btn-sm flex-shrink-0 svelte-16rhvk2" aria-label="Close">`;push_element($$payload2,"button",209,3);$$payload2.out+=`<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">`;push_element($$payload2,"svg",214,4);$$payload2.out+=`<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd">`;push_element($$payload2,"path",220,5);$$payload2.out+=`</path>`;pop_element();$$payload2.out+=`</svg>`;pop_element();$$payload2.out+=`</button>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=` <div class="flex-1 p-4 flex flex-col max-w-[428px]">`;push_element($$payload2,"div",231,1);$$payload2.out+=`<div class="text-center mb-4 flex-shrink-0">`;push_element($$payload2,"div",232,2);if(method!=="eth_requestAccounts"&&method!=="eth_sendTransaction"&&method!=="eth_signTypedData_v4"&&method!=="personal_sign"){$$payload2.out+="\x3c!--[--\x3e";$$payload2.out+=`<h2 class="text-xl font-bold mb-2">`;push_element($$payload2,"h2",234,4);$$payload2.out+=`Security Risk</h2>`;pop_element()}else{$$payload2.out+="\x3c!--[!--\x3e";$$payload2.out+=`<h2 class="text-xl font-bold mb-2">`;push_element($$payload2,"h2",236,4);$$payload2.out+=`Connection Request</h2>`;pop_element();$$payload2.out+=` <p class="text-base-content/80">`;push_element($$payload2,"p",237,4);$$payload2.out+=`This site would like to:</p>`;pop_element()}$$payload2.out+=`\x3c!--]--\x3e</div>`;pop_element();$$payload2.out+=` <div class="space-y-4 mb-4 overflow-y-auto flex-1 min-h-0 svelte-16rhvk2">`;push_element($$payload2,"div",241,2);$$payload2.out+=`<div class="flex items-center gap-3 p-3 bg-base-200 rounded-lg">`;push_element($$payload2,"div",242,3);$$payload2.out+=`<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">`;push_element($$payload2,"svg",243,4);$$payload2.out+=`<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z">`;push_element($$payload2,"path",250,5);$$payload2.out+=`</path>`;pop_element();$$payload2.out+=`</svg>`;pop_element();$$payload2.out+=` `;if(method==="eth_requestAccounts"){$$payload2.out+="\x3c!--[--\x3e";$$payload2.out+=`<span>`;push_element($$payload2,"span",258,5);$$payload2.out+=`1. Request approval to connect to your wallet addresses</span>`;pop_element()}else if(method==="eth_sendTransaction"){$$payload2.out+="\x3c!--[1--\x3e";$$payload2.out+=`<span>`;push_element($$payload2,"span",260,5);$$payload2.out+=`1. Request approval to send a transaction</span>`;pop_element()}else if(method==="eth_signTypedData_v4"||method==="personal_sign"||method==="eth_signTransaction"){$$payload2.out+="\x3c!--[2--\x3e";$$payload2.out+=`<span>`;push_element($$payload2,"span",262,5);$$payload2.out+=`1. Request approval to sign a message</span>`;pop_element()}else if(method==="wallet_requestPermissions"||method==="wallet_revokePermissions"||method==="wallet_getPermissions"){$$payload2.out+="\x3c!--[3--\x3e";$$payload2.out+=`<span>`;push_element($$payload2,"span",265,5);$$payload2.out+=`1. Request approval to connect to your wallet addresses</span>`;pop_element()}else if(method==="wallet_switchEthereumChain"){$$payload2.out+="\x3c!--[4--\x3e";$$payload2.out+=`<span>`;push_element($$payload2,"span",267,5);$$payload2.out+=`1. Request approval to switch to a different network</span>`;pop_element()}else{$$payload2.out+="\x3c!--[!--\x3e";$$payload2.out+=`<span>`;push_element($$payload2,"span",271,5);$$payload2.out+=`Request approval for '${escape_html(method)}' but it is not supported by YAKKL® due to security\n\t\t\t\t\t\tconcerns.</span>`;pop_element()}$$payload2.out+=`\x3c!--]--\x3e</div>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=` <div class="bg-base-200 rounded-lg p-4 mb-4 flex-shrink-0">`;push_element($$payload2,"div",293,2);$$payload2.out+=`<p class="text-sm text-base-content/70">`;push_element($$payload2,"p",294,3);if(method!=="eth_requestAccounts"&&method!=="eth_sendTransaction"&&method!=="eth_signTypedData_v4"&&method!=="personal_sign"&&method!=="eth_signTransaction"&&method!=="wallet_requestPermissions"&&method!=="wallet_revokePermissions"&&method!=="wallet_getPermissions"&&method!=="wallet_switchEthereumChain"){$$payload2.out+="\x3c!--[--\x3e";$$payload2.out+=`The request is a possible security risk and not allowed!`}else{$$payload2.out+="\x3c!--[!--\x3e";$$payload2.out+=`By connecting, you agree to allow this site to connect to your addresses. Any signing or\n\t\t\t\t\ttransaction requests will have an additional approval step.`}$$payload2.out+=`\x3c!--]--\x3e</p>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=` <div class="p-4 border-t border-base-300 flex-shrink-0">`;push_element($$payload2,"div",306,1);$$payload2.out+=`<div class="flex gap-4 justify-end">`;push_element($$payload2,"div",307,2);if(method!=="eth_requestAccounts"&&method!=="eth_sendTransaction"&&method!=="eth_signTypedData_v4"&&method!=="personal_sign"&&method!=="eth_signTransaction"&&method!=="wallet_requestPermissions"&&method!=="wallet_revokePermissions"&&method!=="wallet_getPermissions"&&method!=="wallet_switchEthereumChain"){$$payload2.out+="\x3c!--[--\x3e";$$payload2.out+=`<button class="btn btn-primary svelte-16rhvk2">`;push_element($$payload2,"button",309,4);$$payload2.out+=`Reject</button>`;pop_element()}else{$$payload2.out+="\x3c!--[!--\x3e";$$payload2.out+=`<button class="btn btn-primary svelte-16rhvk2">`;push_element($$payload2,"button",316,4);if(method==="eth_requestAccounts"){$$payload2.out+="\x3c!--[--\x3e";$$payload2.out+=`Connect`}else if(method==="eth_sendTransaction"){$$payload2.out+="\x3c!--[1--\x3e";$$payload2.out+=`Approve Transaction`}else if(method==="eth_signTypedData_v4"||method==="personal_sign"||method==="eth_signTransaction"){$$payload2.out+="\x3c!--[2--\x3e";$$payload2.out+=`Approve Signing`}else if(method==="wallet_requestPermissions"){$$payload2.out+="\x3c!--[3--\x3e";$$payload2.out+=`Approve Connection`}else if(method==="wallet_revokePermissions"){$$payload2.out+="\x3c!--[4--\x3e";$$payload2.out+=`Revoke Connection`}else if(method==="wallet_getPermissions"){$$payload2.out+="\x3c!--[5--\x3e";$$payload2.out+=`View Permissions`}else if(method==="wallet_switchEthereumChain"){$$payload2.out+="\x3c!--[6--\x3e";$$payload2.out+=`Switch Network`}else{$$payload2.out+="\x3c!--[!--\x3e"}$$payload2.out+=`\x3c!--]--\x3e</button>`;pop_element()}$$payload2.out+=`\x3c!--]--\x3e</div>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=` `;Copyright($$payload2,{});$$payload2.out+=`\x3c!----\x3e`}do{$$settled=true;$$inner_payload=copy_payload($$payload);$$render_inner($$inner_payload)}while(!$$settled);assign_payload($$payload,$$inner_payload);pop()}_page.render=function(){throw new Error("Component.render(...) is no longer valid in Svelte 5. See https://svelte.dev/docs/svelte/v5-migration-guide#Components-are-no-longer-classes for more information")};export{_page as default};
//# sourceMappingURL=_page.svelte.js.map
