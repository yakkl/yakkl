{"version":3,"file":"_page.svelte.js","sources":["../../../../../../../../../src/routes/(dapp)/dapp/popups/wallet/+page.svelte"],"sourcesContent":["<script lang=\"ts\">\n\timport { browser_ext, browserSvelte } from '$lib/common/environment';\n\timport { page } from '$app/state';\n\timport {\n\t\tgetYakklCurrentlySelected,\n\t\tgetMiscStore,\n\t\tyakklDappConnectRequestStore,\n\t\tgetSettings\n\t} from '$lib/common/stores';\n\timport { type YakklCurrentlySelected } from '$lib/common';\n\timport { DEFAULT_TITLE, YAKKL_DAPP } from '$lib/common/constants';\n\timport { onMount } from 'svelte';\n\timport { log } from '$managers/Logger';\n\timport type { Runtime } from 'webextension-polyfill';\n\timport type { JsonRpcResponse, SessionInfo } from '$lib/common/interfaces';\n\timport type { BackgroundPendingRequest } from '$lib/extensions/chrome/background';\n\timport Confirmation from '$lib/components/Confirmation.svelte';\n\timport Copyright from '$lib/components/Copyright.svelte';\n\t// import Warning from '$lib/components/Warning.svelte';\n\timport Failed from '$lib/components/Failed.svelte';\n\timport {\n\t\tcreatePortManagerWithStream,\n\t\tPortManagerWithStream\n\t} from '$lib/managers/PortManagerWithStream';\n\timport type { PortDuplexStream } from '$lib/managers/PortStreamManager';\n\timport { sessionToken, verifySessionToken } from '$lib/common/auth/session';\n\timport { safeLogout } from '$lib/common/safeNavigate';\n\n\t// NOTE: This is not as large of security risk as the network form, but we should still be mindful of it.\n\t// NOTE: We should also consider adding a warning to the user about the risks of signing messages.\n\t// NOTE: We should also consider adding something to the wallet UI to make it more obvious that this is happening or has happened.\n\n\t// NOTE: We believe this is a possible security risk. We will not support this feature at this time.\n\n\ttype RuntimePort = Runtime.Port | undefined;\n\n\tlet currentlySelected: YakklCurrentlySelected;\n\tlet yakklMiscStore: string;\n\n\tlet showConfirm = $state(false);\n\tlet showSuccess = $state(false);\n\tlet showFailure = $state(false);\n\tlet errorValue = $state('No domain/site name was found. Access to YAKKL® is denied.');\n\n\tlet domain: string = $state('');\n\tlet domainLogo: string = $state('');\n\tlet domainTitle: string = $state('');\n\tlet title: string = $state(DEFAULT_TITLE);\n\tlet request: BackgroundPendingRequest;\n\tlet requestId: string | null;\n\tlet method: string | null;\n\tlet params: any[] = $state([]);\n\n\tlet pass = false;\n\n\tlet portManager: PortManagerWithStream | null = null;\n\tlet stream: PortDuplexStream | null = null;\n\n\t// const mode = $derived(props.mode ?? 'switch');\n\tlet chainId: string = $state('');\n\n\tlet currentChainData = $state<YakklCurrentlySelected | null>(null);\n\n\tconst currentChainId = $derived(currentChainData?.shortcuts?.chainId ?? '0x1');\n\n\tif (browserSvelte) {\n\t\ttry {\n\t\t\trequestId = page.url.searchParams.get('requestId');\n\t\t\tmethod = page.url.searchParams.get('method');\n\t\t\t$yakklDappConnectRequestStore = requestId as string;\n\n\t\t\tif (requestId) {\n\t\t\t\tpass = true;\n\t\t\t}\n\t\t\t// NOTE: The internal check now makes sure the requestId is valid\n\t\t} catch (e) {\n\t\t\tlog.error(e);\n\t\t\thandleReject('No requestId or method was found. Access to YAKKL® is denied.');\n\t\t}\n\t}\n\n\t// We no longer need to do get_params since we can access the request data directly\n\tasync function onMessageListener(event: any) {\n\t\ttry {\n\t\t\tif (!domainLogo) domainLogo = '/images/failIcon48x48.png'; // Set default logo but change if favicon is present\n\n\t\t\tif (event.method === 'get_params') {\n\t\t\t\trequest = event.result;\n\t\t\t\tif (!request || !request.data) {\n\t\t\t\t\treturn await handleReject('No request was found. Access to YAKKL® is denied.');\n\t\t\t\t}\n\n\t\t\t\tconst requestData = request.data;\n\t\t\t\tif (\n\t\t\t\t\t!requestData ||\n\t\t\t\t\t!requestData.params ||\n\t\t\t\t\t!requestData.params[0] ||\n\t\t\t\t\t!requestData.metaData\n\t\t\t\t) {\n\t\t\t\t\treturn await handleReject('Invalid request data. Access to YAKKL® is denied.');\n\t\t\t\t}\n\n\t\t\t\tif (!requestData.metaData.metaData.isConnected) {\n\t\t\t\t\treturn await handleReject(\n\t\t\t\t\t\t'Domain is not connected. Connect to {domain} first via requestAccounts. Access to YAKKL® is denied.'\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\t// These needs to be fixed upstream\n\t\t\t\tdomainTitle = requestData.metaData.metaData.title;\n\t\t\t\tdomain = requestData.metaData.metaData.domain;\n\t\t\t\tdomainLogo = requestData.metaData.metaData.icon;\n\t\t\t\tparams = requestData.params ?? [];\n\t\t\t\t// Make sure params is an array\n\t\t\t\tif (!Array.isArray(params)) {\n\t\t\t\t\tparams = [params];\n\t\t\t\t}\n\n\t\t\t\tif (!requestId) requestId = requestData?.id ?? null;\n\t\t\t\tif (!requestId) {\n\t\t\t\t\treturn await handleReject('No request ID was found. Access to YAKKL® is denied.');\n\t\t\t\t}\n\n\t\t\t\t// Set the page title\n\t\t\t\ttitle = domainTitle || domain || DEFAULT_TITLE;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tlog.error(e);\n\t\t\tawait handleReject(\n\t\t\t\t'An error occurred while processing the request. Access to YAKKL® is denied.'\n\t\t\t);\n\t\t}\n\t}\n\n\tonMount(async () => {\n\t\ttry {\n\t\t\tif (browserSvelte) {\n\t\t\t\tlog.info('Dapp - wallet page mounted:', false);\n\n\t\t\t\tconst settings = await getSettings();\n\t\t\t\tif (!settings.init || !settings.legal.termsAgreed) {\n\t\t\t\t\terrorValue =\n\t\t\t\t\t\t\"You must register and agree to the terms of service before using YAKKL®. Click on 'Open Wallet' to register.\";\n\t\t\t\t\tshowFailure = true;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tcurrentlySelected = await getYakklCurrentlySelected();\n\t\t\t\tyakklMiscStore = getMiscStore();\n\n\t\t\t\t// Since we're 1:1 we can attach to the known port name\n\t\t\t\tconst sessionInfo = (await browser_ext.runtime.sendMessage({\n\t\t\t\t\ttype: 'REQUEST_SESSION_PORT',\n\t\t\t\t\trequestId\n\t\t\t\t})) as SessionInfo;\n\n\t\t\t\tlog.info('Received session info:', false, sessionInfo);\n\n\t\t\t\t// Guard against null response\n\t\t\t\tif (!sessionInfo || !sessionInfo.success) {\n\t\t\t\t\tlog.warn('Failed to verify session port. No response received. Using YAKKL_DAPP.');\n\t\t\t\t}\n\n\t\t\t\t// Create port manager with the original port name\n\t\t\t\tportManager = createPortManagerWithStream(sessionInfo?.portName ?? YAKKL_DAPP);\n\t\t\t\tportManager.setRequestId(requestId);\n\n\t\t\t\tconst success = await portManager.createPort();\n\t\t\t\tif (!success) {\n\t\t\t\t\terrorValue = 'Failed to connect to session port.';\n\t\t\t\t\tshowFailure = true;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Connect to existing port\n\t\t\t\tstream = portManager.getStream();\n\t\t\t\tif (!stream) {\n\t\t\t\t\terrorValue = 'Stream is not available.';\n\t\t\t\t\tshowFailure = true;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tstream.on('data', onMessageListener);\n\t\t\t\tstream.write({ method: 'get_params', id: requestId });\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tlog.error(e);\n\t\t\terrorValue =\n\t\t\t\t'Port setuperror occurred while processing the request. Access to YAKKL® is denied.';\n\t\t\tshowFailure = true;\n\t\t}\n\t});\n\n\tasync function handleReject(message: string = 'User rejected the request.') {\n\t\ttry {\n\t\t\tif (browserSvelte) {\n\t\t\t\tshowConfirm = false;\n\t\t\t\tshowFailure = false;\n\t\t\t\tshowSuccess = false;\n\t\t\t\tif (stream) {\n\t\t\t\t\tstream.write({\n\t\t\t\t\t\ttype: 'YAKKL_RESPONSE:EIP6963',\n\t\t\t\t\t\tjsonrpc: '2.0',\n\t\t\t\t\t\tid: requestId,\n\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\tcode: 4001,\n\t\t\t\t\t\t\tmessage\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tlog.error(e);\n\t\t} finally {\n\t\t\tclose();\n\t\t}\n\t}\n\n\tasync function handleProcess() {\n\t\ttry {\n\t\t\tif (!browserSvelte) {\n\t\t\t\tawait handleReject();\n\t\t\t}\n\n\t\t\tif (!verifySessionToken($sessionToken)) {\n\t\t\t\tawait handleReject('Session token is invalid. Login again.');\n\t\t\t}\n\n\t\t\t// Send response to dapp\n\t\t\tif (stream) {\n\t\t\t\tlog.info('ChainId change approved: handleProcess - chainId: BEFORE', false, chainId);\n\n\t\t\t\tconst jsonRpcResponse: JsonRpcResponse = {\n\t\t\t\t\ttype: 'YAKKL_RESPONSE:EIP6963',\n\t\t\t\t\tjsonrpc: '2.0',\n\t\t\t\t\tid: requestId,\n\t\t\t\t\tresult: null // NOTE: Just null like any other response with no value\n\t\t\t\t};\n\n\t\t\t\t// Write to stream and add a small delay to ensure the write completes\n\t\t\t\tstream.write(jsonRpcResponse);\n\t\t\t\tawait new Promise(async (resolve) => {\n\t\t\t\t\tconst { UnifiedTimerManager } = await import('$lib/managers/UnifiedTimerManager');\n\t\t\t\t\tconst timerManager = UnifiedTimerManager.getInstance();\n\t\t\t\t\ttimerManager.addTimeout('wallet-popup-delay', () => resolve(undefined), 100);\n\t\t\t\t\ttimerManager.startTimeout('wallet-popup-delay');\n\t\t\t\t});\n\n\t\t\t\tlog.info('ChainId change approved: handleProcess - response:', false, { jsonRpcResponse });\n\t\t\t} else {\n\t\t\t\tawait handleReject('Request failed to send to dapp due to connection port not found.');\n\t\t\t}\n\t\t\tclose();\n\t\t} catch (e) {\n\t\t\tlog.error(e);\n\t\t\terrorValue = e instanceof Error ? e.message : 'Unknown error occurred';\n\t\t\tshowFailure = true;\n\t\t}\n\t}\n\n\tasync function close() {\n\t\tif (browserSvelte) {\n\t\t\ttry {\n\t\t\t\t// Wait for port to go idle\n\t\t\t\tif (portManager) {\n\t\t\t\t\tawait portManager.waitForIdle(1500);\n\t\t\t\t\tportManager.disconnect();\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tlog.warn('Port did not go idle in time', false, e);\n\t\t\t}\n\t\t\tsafeLogout();\n\t\t}\n\t}\n\n\tfunction handleConfirm() {\n\t\tshowConfirm = true;\n\t}\n\n\tfunction handleClose() {\n\t\thandleReject();\n\t}\n</script>\n\n<svelte:head>\n\t<title>{title}</title>\n</svelte:head>\n\n<!-- <Warning bind:show={showFailure} title=\"Error\" value={errorValue} /> -->\n<Failed bind:show={showFailure} title=\"Failed!\" content={errorValue} onReject={handleReject} />\n<Confirmation\n\tbind:show={showConfirm}\n\ttitle=\"Connect to {domain}\"\n\tmessage=\"This will connect {domain} to chainId {chainId} and switch your wallet to that network! Do you wish to continue?\"\n\tonConfirm={handleProcess}\n/>\n\n<div class=\"flex flex-col h-full max-h-screen overflow-hidden\">\n\t<!-- Header -->\n\t<div class=\"p-4 border-b border-base-300 flex-shrink-0\">\n\t\t<div class=\"flex items-center justify-between\">\n\t\t\t<div class=\"flex items-center gap-2 min-w-0\">\n\t\t\t\t<img\n\t\t\t\t\tid=\"dappImageId\"\n\t\t\t\t\tcrossorigin=\"anonymous\"\n\t\t\t\t\tsrc={domainLogo}\n\t\t\t\t\talt=\"Dapp logo\"\n\t\t\t\t\tclass=\"w-8 h-8 rounded-full flex-shrink-0\"\n\t\t\t\t/>\n\t\t\t\t<span class=\"font-semibold truncate\" title={domainTitle || domain}\n\t\t\t\t\t>{domainTitle || domain}</span\n\t\t\t\t>\n\t\t\t</div>\n\t\t\t<button onclick={handleClose} class=\"btn btn-ghost btn-sm flex-shrink-0\" aria-label=\"Close\">\n\t\t\t\t<svg\n\t\t\t\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\t\t\t\tclass=\"h-5 w-5\"\n\t\t\t\t\tviewBox=\"0 0 20 20\"\n\t\t\t\t\tfill=\"currentColor\"\n\t\t\t\t>\n\t\t\t\t\t<path\n\t\t\t\t\t\tfill-rule=\"evenodd\"\n\t\t\t\t\t\td=\"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z\"\n\t\t\t\t\t\tclip-rule=\"evenodd\"\n\t\t\t\t\t/>\n\t\t\t\t</svg>\n\t\t\t</button>\n\t\t</div>\n\t</div>\n\n\t<!-- Content-->\n\t<div class=\"flex-1 p-6 flex flex-col max-w-[428px]\">\n\t\t<div class=\"text-center mb-4 flex-shrink-0 border-2 border-red-500 rounded-md p-2\">\n\t\t\t<p class=\"text-md font-extrabold animate-pulse mb-2\">Important!:</p>\n\t\t\t<span class=\"text-sm font-bold mb-2\"\n\t\t\t\t>Allowing another site or app to change the network of your wallet is a security concern.</span\n\t\t\t>\n\t\t\t<span class=\"text-sm font-bold mb-2\"\n\t\t\t\t>You change it back to Mainnet from within the wallet if you desire! Be 100% sure you trust\n\t\t\t\tthe site or app or REJECT this transaction and research more before trying again.</span\n\t\t\t>\n\t\t</div>\n\t</div>\n\n\t<!-- Footer -->\n\t<div class=\"p-4 border-t border-base-300 flex-shrink-0\">\n\t\t<div class=\"flex gap-4 justify-end\">\n\t\t\t<button onclick={handleClose} class=\"btn btn-outline\"> Reject </button>\n\t\t\t<button onclick={handleConfirm} class=\"btn btn-primary\"> Approve </button>\n\t\t</div>\n\t</div>\n</div>\n\n<Copyright />\n\n<style>\n\t/* Smooth transitions */\n\t.btn {\n\t\ttransition: all 0.2s ease;\n\t}\n\n\t.btn:hover {\n\t\ttransform: translateY(-1px);\n\t}\n\n\t/* Custom scrollbar */\n\t/* .overflow-y-auto {\n    scrollbar-width: thin;\n    scrollbar-color: hsl(var(--p)) transparent;\n  }\n\n  .overflow-y-auto::-webkit-scrollbar {\n    width: 6px;\n  }\n\n  .overflow-y-auto::-webkit-scrollbar-track {\n    background: transparent;\n  }\n\n  .overflow-y-auto::-webkit-scrollbar-thumb {\n    background-color: hsl(var(--p));\n    border-radius: 3px;\n  } */\n</style>\n"],"names":["showConfirm","showSuccess","showFailure","errorValue","domain","domainLogo","title","DEFAULT_TITLE","requestId","method","pass","portManager","stream","chainId","browserSvelte","page","url","searchParams","get","$.store_set","yakklDappConnectRequestStore","e","log","error","handleReject","async","message","close","handleProcess","verifySessionToken","$.store_get","$$store_subs","sessionToken","Error","warn","safeLogout","$$value","$.stringify","$$payload","out","$.attr","$.escape"],"mappings":"ikCAuCK,IAAAA,YAAqB,MACrB,IAAAC,YAAqB,MACrB,IAAAC,YAAqB,MACrB,IAAAC,WAAoB,6DAEpB,IAAAC,OAAwB,GACxB,IAAAC,WAA4B,GAE5B,IAAAC,MAAuBC,cAEvB,IAAAC,UACA,IAAAC,WAGAC,KAAO,UAEPC,YAA4C,SAC5CC,OAAkC,KAGlC,IAAAC,QAAyB,MAMzBC,cAAe,CACd,IACHN,UAAYO,KAAKC,IAAIC,aAAaC,IAAI,aACtCT,OAASM,KAAKC,IAAIC,aAAaC,IAAI,UACHC,UAAAC,6BAAAZ,cAE5BA,UAAW,CACPE,KAAA,IACR,CAED,OAASW,GACRC,IAAIC,MAAMF,GACVG,aAAa,gEACd,CACD,CAiHeC,eAAAD,aAAaE,QAAkB,8BACzC,OACCZ,cAAe,CACJd,YAAA,MACAE,YAAA,MACAD,YAAA,SACVW,QAWL,CACD,OAASS,GACRC,IAAIC,MAAMF,GACT,QACDM,OACD,CACD,gBAEeC,gBACV,QACEd,cAAe,OACbU,cACP,KAEKK,mBAAmCC,UAAAC,eAAA,CAAA,EAAA,gBAAAC,eAAA,OACjCR,aAAa,yCACpB,IAGIZ,YAoBG,OACAY,aAAa,mEACpB,CACAG,OACD,OAASN,GACRC,IAAIC,MAAMF,GACGlB,WAAAkB,aAAaY,MAAQZ,EAAEK,QAAU,yBAChCxB,YAAA,IACf,CACD,gBAEeyB,WACVb,cAAe,CACd,OAECH,aAIL,OAASU,GACJC,IAAAY,KAAK,+BAAgC,MAAOb,EACjD,CACAc,YACD,CACD,gJAYQ7B,8DAIgDH,oBAAsBqB,wBAA5D,OAAAtB,+BAAWA,YAAAkC,mHAGVhC,UACSsB,QAAA,qBAAAW,UAAAjC,gCAAoBS,sFACrCe,yBAHA,OAAA5B,+BAAWA,YAAAoC,uiBAcb/B,8HAIsCiC,WAAAC,KAAA,wCAAAC,KAAA,QAAepC,iDACxDkC,WAAAC,KAAA,GAAAE,YAAerC"}