import{p as push,j as store_set,h as copy_payload,i as assign_payload,c as pop,r as head,a as push_element,m as attr,b as pop_element,e as escape_html,g as stringify,s as store_get,u as unsubscribe_stores}from"../../../../../../chunks/index2.js";import{a as browser_ext,b as browserSvelte}from"../../../../../../chunks/environment.js";import{p as page}from"../../../../../../chunks/index3.js";import{b as yakklDappConnectRequestStore,l as log$1,_ as DEFAULT_TITLE,g as getYakklAccounts,i as isEncryptedData,j as decryptData}from"../../../../../../chunks/encryption.js";import{l as log}from"../../../../../../chunks/Logger.js";import{F as FILENAME}from"../../../../../../chunks/utils.js";import{v as verifySessionToken,s as sessionToken}from"../../../../../../chunks/session.js";import{C as Confirmation}from"../../../../../../chunks/Confirmation.js";import{C as Copyright}from"../../../../../../chunks/Copyright.js";import"../../../../../../chunks/Warning.js";import{F as Failed}from"../../../../../../chunks/Failed.js";import{s as safeLogout}from"../../../../../../chunks/safeNavigate.js";import"../../../../../../chunks/utilities.js";async function requestSigning(requestId,type,params,token){if(typeof window==="undefined"){throw new Error("This function can only be called in a browser environment")}if(!requestId||!type||!params||!token){throw new Error("Missing required parameters for signing request")}log.info("requestSigning - Sending request to background",false,{requestId:requestId,type:type,params:params,token:token});try{const response=await browser_ext.runtime.sendMessage({type:type,requestId:requestId,params:params,token:token});log.info("requestSigning - Received response from background",false,{response:response});if(!response){throw new Error("No response received from background script")}if(response.error){throw new Error(response.error.message||"Unknown error occurred")}return response}catch(error){log.error("requestSigning - Error sending request to background",false,error);throw error}}_page[FILENAME]="src/routes/(dapp)/dapp/popups/sign/+page.svelte";function _page($$payload,$$props){push(_page);var $$store_subs;let yakklMiscStore;let wallet;let showConfirm=false;let showSuccess=false;let showFailure=false;let errorValue="No domain/site name was found. Access to YAKKL® is denied.";let domain="";let domainLogo="";let title=DEFAULT_TITLE;let method="";let requestId;let message="";let address="";let chainId;let params=[];let transaction={};let transactionDisplay={};let gasLimit=0n;let pass=false;let portManager=null;let stream=null;if(browserSvelte){try{requestId=page.url.searchParams.get("requestId");method=page.url.searchParams.get("method")??"";store_set(yakklDappConnectRequestStore,requestId);if(requestId){pass=true}}catch(e){log$1.error(e);handleReject("No requestId or method was found. Access to YAKKL® is denied.")}}async function handleReject(message2="User rejected the request."){try{if(browserSvelte){showConfirm=false;showFailure=false;showSuccess=false;if(stream);}}catch(e){log$1.error(e)}finally{close()}}async function handleProcess(){try{if(!browserSvelte){await handleReject()}if(!verifySessionToken(store_get($$store_subs??={},"$sessionToken",sessionToken))){await handleReject("Session token is invalid. Login again.")}if(method==="eth_signTransaction"){await handleSignTransaction()}else{const response=await requestSigning(requestId,method,params,store_get($$store_subs??={},"$sessionToken",sessionToken));if(!response){await handleReject("Request failed due to no response from the signing request.")}if(response.error){await handleReject(response.error.message||"Signing request failed")}if(stream);else{await handleReject("Request failed to send to dapp due to connection port not found.")}}close()}catch(e){log$1.error(e);errorValue=e instanceof Error?e.message:"Unknown error occurred";showFailure=true}}async function handleSignTransaction(){try{const accounts=await getYakklAccounts();const account=accounts.find(acc=>acc.address.toLowerCase()===transaction.from?.toLowerCase());if(!account){await handleReject("Account not found.");return}if(isEncryptedData(account.data)){account.data=await decryptData(account.data,yakklMiscStore)}if(!account.data.privateKey){await handleReject("Account key not available.");return}transaction.gasLimit=gasLimit;transaction.nonce=transaction.nonce??-1;transaction.type=transaction.type??2;transaction.chainId=chainId;await wallet.setSigner(account.data.privateKey);const blockchain=wallet.getBlockchain();const provider=blockchain.getProvider();const signer=provider.getSigner();const signedTx=await signer.signTransaction(transaction);if(stream);else{await handleReject("Request failed to send to dapp due to connection port not found.")}}catch(e){log$1.error("Transaction signing error:",false,e);errorValue=e instanceof Error?e.message:"Transaction signing failed";showFailure=true}}async function close(){if(browserSvelte){try{if(portManager);}catch(e){log$1.warn("Port did not go idle in time",false,e)}safeLogout()}}let $$settled=true;let $$inner_payload;function $$render_inner($$payload2){head($$payload2,$$payload3=>{$$payload3.title=`<title>${escape_html(title)}</title>`});Failed($$payload2,{title:"Failed!",content:errorValue,onReject:handleReject,get show(){return showFailure},set show($$value){showFailure=$$value;$$settled=false}});$$payload2.out+=`\x3c!----\x3e `;Confirmation($$payload2,{title:`Connect to ${stringify(domain)}`,message:`This will connect ${stringify(domain)} to ${stringify(address)} and sign the transaction or message! Do you wish to continue?`,onConfirm:handleProcess,get show(){return showConfirm},set show($$value){showConfirm=$$value;$$settled=false}});$$payload2.out+=`\x3c!----\x3e <div class="flex flex-col h-full max-h-screen overflow-hidden">`;push_element($$payload2,"div",376,0);$$payload2.out+=`<div class="p-4 border-b border-base-300 flex-shrink-0">`;push_element($$payload2,"div",378,1);$$payload2.out+=`<div class="flex items-center justify-between">`;push_element($$payload2,"div",379,2);$$payload2.out+=`<div class="flex items-center gap-2 min-w-0">`;push_element($$payload2,"div",380,3);$$payload2.out+=`<img id="dappImageId" crossorigin="anonymous"${attr("src",domainLogo)} alt="Dapp logo" class="w-8 h-8 rounded-full flex-shrink-0"/>`;push_element($$payload2,"img",381,4);pop_element();$$payload2.out+=` <span class="font-semibold truncate"${attr("title",domain)}>`;push_element($$payload2,"span",388,4);$$payload2.out+=`${escape_html(domain)}</span>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=` <button class="btn btn-ghost btn-sm flex-shrink-0 svelte-ffsqec" aria-label="Close">`;push_element($$payload2,"button",392,3);$$payload2.out+=`<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">`;push_element($$payload2,"svg",397,4);$$payload2.out+=`<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd">`;push_element($$payload2,"path",403,5);$$payload2.out+=`</path>`;pop_element();$$payload2.out+=`</svg>`;pop_element();$$payload2.out+=`</button>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=` <div class="flex-1 p-6 flex flex-col max-w-[428px]">`;push_element($$payload2,"div",414,1);$$payload2.out+=`<div class="text-center mb-4 flex-shrink-0 border-2 border-red-500 rounded-md p-2">`;push_element($$payload2,"div",415,2);$$payload2.out+=`<p class="text-md font-extrabold animate-pulse mb-2">`;push_element($$payload2,"p",416,3);$$payload2.out+=`Important!:</p>`;pop_element();$$payload2.out+=` <span class="text-sm font-bold mb-2">`;push_element($$payload2,"span",417,3);$$payload2.out+=`Signing of Message requesting permission to execute: PLEASE be mindful and know what you\n\t\t\t\tare doing.</span>`;pop_element();$$payload2.out+=` <span class="text-sm font-bold mb-2">`;push_element($$payload2,"span",421,3);$$payload2.out+=`There is no cancel or return option! Be 100% sure or REJECT this transaction and research\n\t\t\t\tmore before trying again.</span>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=` <div class="overflow-auto flex-1 min-h-0 mb-4 svelte-ffsqec">`;push_element($$payload2,"div",427,2);if(method==="eth_signTransaction"){$$payload2.out+="\x3c!--[--\x3e";$$payload2.out+=`<span class="text-sm">`;push_element($$payload2,"span",429,4);$$payload2.out+=`Transaction Details:</span>`;pop_element();$$payload2.out+=` <div class="bg-base-200 rounded-lg p-4 space-y-3 mt-2">`;push_element($$payload2,"div",430,4);$$payload2.out+=`<div class="flex justify-between items-center border-b border-base-300 pb-2">`;push_element($$payload2,"div",431,5);$$payload2.out+=`<span class="font-medium">`;push_element($$payload2,"span",432,6);$$payload2.out+=`From:</span>`;pop_element();$$payload2.out+=` <span class="font-mono text-sm">`;push_element($$payload2,"span",433,6);$$payload2.out+=`${escape_html(transactionDisplay.from)}</span>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=` <div class="flex justify-between items-center border-b border-base-300 pb-2">`;push_element($$payload2,"div",435,5);$$payload2.out+=`<span class="font-medium">`;push_element($$payload2,"span",436,6);$$payload2.out+=`To:</span>`;pop_element();$$payload2.out+=` <span class="font-mono text-sm">`;push_element($$payload2,"span",437,6);$$payload2.out+=`${escape_html(transactionDisplay.to)}</span>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=` <div class="flex justify-between items-center border-b border-base-300 pb-2">`;push_element($$payload2,"div",439,5);$$payload2.out+=`<span class="font-medium">`;push_element($$payload2,"span",440,6);$$payload2.out+=`Value:</span>`;pop_element();$$payload2.out+=` <span class="font-bold text-primary">`;push_element($$payload2,"span",441,6);$$payload2.out+=`${escape_html(transactionDisplay.value)}</span>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=` <div class="flex justify-between items-center border-b border-base-300 pb-2">`;push_element($$payload2,"div",443,5);$$payload2.out+=`<span class="font-medium">`;push_element($$payload2,"span",444,6);$$payload2.out+=`Gas Limit:</span>`;pop_element();$$payload2.out+=` <span>`;push_element($$payload2,"span",445,6);$$payload2.out+=`${escape_html(transactionDisplay.gasLimit)}</span>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=` `;if(transaction.data){$$payload2.out+="\x3c!--[--\x3e";$$payload2.out+=`<div class="flex justify-between items-center">`;push_element($$payload2,"div",448,6);$$payload2.out+=`<span class="font-medium">`;push_element($$payload2,"span",449,7);$$payload2.out+=`Data:</span>`;pop_element();$$payload2.out+=` <span class="text-sm truncate max-w-[200px]">`;push_element($$payload2,"span",450,7);$$payload2.out+=`${escape_html(transactionDisplay.data)}</span>`;pop_element();$$payload2.out+=`</div>`;pop_element()}else{$$payload2.out+="\x3c!--[!--\x3e"}$$payload2.out+=`\x3c!--]--\x3e</div>`;pop_element()}else{$$payload2.out+="\x3c!--[!--\x3e";$$payload2.out+=`<span class="text-sm">`;push_element($$payload2,"span",455,4);$$payload2.out+=`Data to sign:</span>`;pop_element();$$payload2.out+=` <pre class="text-md border-2 border-blue-500 rounded-md p-2 bg-opacity-25">`;push_element($$payload2,"pre",456,4);$$payload2.out+=`${escape_html(message)}</pre>`;pop_element()}$$payload2.out+=`\x3c!--]--\x3e</div>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=` <div class="p-4 border-t border-base-300 flex-shrink-0">`;push_element($$payload2,"div",462,1);$$payload2.out+=`<div class="flex gap-4 justify-end">`;push_element($$payload2,"div",463,2);$$payload2.out+=`<button class="btn btn-outline svelte-ffsqec">`;push_element($$payload2,"button",464,3);$$payload2.out+=`Reject</button>`;pop_element();$$payload2.out+=` <button class="btn btn-primary svelte-ffsqec">`;push_element($$payload2,"button",465,3);$$payload2.out+=`Approve</button>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=`</div>`;pop_element();$$payload2.out+=` `;Copyright($$payload2,{});$$payload2.out+=`\x3c!----\x3e`}do{$$settled=true;$$inner_payload=copy_payload($$payload);$$render_inner($$inner_payload)}while(!$$settled);assign_payload($$payload,$$inner_payload);if($$store_subs)unsubscribe_stores($$store_subs);pop()}_page.render=function(){throw new Error("Component.render(...) is no longer valid in Svelte 5. See https://svelte.dev/docs/svelte/v5-migration-guide#Components-are-no-longer-classes for more information")};export{_page as default};
//# sourceMappingURL=_page.svelte.js.map
