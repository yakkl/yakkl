{"version":3,"file":"SecurityWarningEnhanced.js","sources":["../../../../src/lib/components/SecurityWarningEnhanced.svelte"],"sourcesContent":["<script lang=\"ts\">\n\timport { onMount, onDestroy } from 'svelte';\n\timport { fade, scale } from 'svelte/transition';\n\timport { bounceIn } from 'svelte/easing';\n\timport { NotificationService } from '$lib/common/notifications';\n\timport { browser_ext } from '$lib/common/environment';\n\timport { securityWarningStore, hideSecurityWarning } from '$lib/common/stores/securityWarning';\n\timport { log } from '$lib/common/logger-wrapper';\n\timport { UnifiedTimerManager } from '$lib/managers/UnifiedTimerManager';\n\timport { createCountdownTimer, type CountdownTimer } from '$lib/managers/CountdownTimer';\n\n\tinterface Props {\n\t\twarningTime?: number;\n\t\tonComplete?: () => void;\n\t}\n\n\tlet { warningTime = 30, onComplete = () => {} } = $props();\n\n\tlet timeLeft = $state(warningTime);\n\tlet countdownTimer: CountdownTimer | null = null;\n\tlet show = $state(false);\n\tlet isUrgent = $state(false);\n\tlet originalTitle = '';\n\tlet isCleaningUp = $state(false);\n\tlet timerManager = UnifiedTimerManager.getInstance();\n\n\t// Subscribe to the security warning store\n\tlet unsubscribe: (() => void) | undefined;\n\n\tasync function triggerLockdown() {\n\t\tif (isCleaningUp) return;\n\n\t\ttry {\n\t\t\tlog.info('üîí [SecurityWarningEnhanced] Triggering lockdown');\n\t\t\tisCleaningUp = true;\n\n\t\t\t// Clean up our own timers first\n\t\t\tcleanup();\n\n\t\t\t// Send lockdown message\n\t\t\tif (browser_ext) {\n\t\t\t\tawait browser_ext.runtime.sendMessage({\n\t\t\t\t\ttype: 'lockdown',\n\t\t\t\t\treason: 'idle-timeout'\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Clear enhanced alerts\n\t\t\tawait NotificationService.clearAllAlertsEnhanced();\n\n\t\t\t// Hide the warning\n\t\t\thideSecurityWarning();\n\n\t\t\t// Call the completion handler\n\t\t\tonComplete();\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to trigger lockdown:', error);\n\t\t} finally {\n\t\t\tisCleaningUp = false;\n\t\t}\n\t}\n\n\tfunction cleanup() {\n\t\t// Clear main countdown timer\n\t\tif (countdownTimer) {\n\t\t\tcountdownTimer.destroy();\n\t\t\tcountdownTimer = null;\n\t\t}\n\n\t\t// Clear title flash timer\n\t\ttimerManager.stopTimeout('title-flash');\n\t\ttimerManager.removeTimeout('title-flash');\n\n\t\t// Close audio context\n\t\tif (typeof window !== 'undefined') {\n\t\t\tconst audioContext = (window as any).__yakklAudioContext;\n\t\t\tif (audioContext && audioContext.state !== 'closed') {\n\t\t\t\taudioContext.close().catch(() => {});\n\t\t\t\t(window as any).__yakklAudioContext = null;\n\t\t\t}\n\t\t}\n\n\t\t// Restore document title\n\t\tif (originalTitle && document.title.includes('üö® URGENT')) {\n\t\t\tdocument.title = originalTitle;\n\t\t\toriginalTitle = '';\n\t\t}\n\n\t\tremoveListeners();\n\t}\n\n\tfunction startCountdown() {\n\t\tlog.info('‚è∞ [SecurityWarningEnhanced] Starting countdown from', false, timeLeft);\n\n\t\t// Clean up any existing timer first\n\t\tcleanup();\n\n\t\t// Store original title for restoration\n\t\toriginalTitle = document.title;\n\n\t\tcountdownTimer = createCountdownTimer(\n\t\t\t'security-warning-enhanced',\n\t\t\ttimeLeft,\n\t\t\t(remaining) => {\n\t\t\t\ttimeLeft = remaining;\n\t\t\t\tlog.debug('‚è±Ô∏è [SecurityWarningEnhanced] Time left:', false, timeLeft);\n\n\t\t\t\t// Update urgency state\n\t\t\t\tisUrgent = timeLeft <= 10;\n\n\t\t\t\t// Start title flashing at 15 seconds if not already started\n\t\t\t\tif (\n\t\t\t\t\ttimeLeft <= 15 &&\n\t\t\t\t\t!timerManager.isTimeoutRunning('title-flash') &&\n\t\t\t\t\t!document.title.includes('üö® URGENT')\n\t\t\t\t) {\n\t\t\t\t\tstartTitleFlash();\n\t\t\t\t}\n\n\t\t\t\t// Play final warning sound at 5 seconds\n\t\t\t\tif (timeLeft === 5) {\n\t\t\t\t\tplayFinalWarningSound();\n\t\t\t\t}\n\t\t\t},\n\t\t\ttriggerLockdown\n\t\t);\n\n\t\tcountdownTimer.start();\n\t\tlog.info('‚úÖ [SecurityWarningEnhanced] Countdown started');\n\t}\n\n\tfunction startTitleFlash() {\n\t\tif (timerManager.isTimeoutRunning('title-flash') || !originalTitle) return;\n\n\t\tlog.info('‚ö° [SecurityWarningEnhanced] Starting title flash');\n\n\t\tlet flashCount = 0;\n\t\tconst flashFunction = () => {\n\t\t\tif (flashCount >= 20) {\n\t\t\t\t// Flash 10 times total\n\t\t\t\ttimerManager.stopTimeout('title-flash');\n\t\t\t\ttimerManager.removeTimeout('title-flash');\n\t\t\t\tif (originalTitle) {\n\t\t\t\t\tdocument.title = originalTitle;\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst flashTitle = flashCount % 2 === 0 ? 'üö® URGENT: Security Warning!' : originalTitle;\n\t\t\tdocument.title = flashTitle;\n\t\t\tflashCount++;\n\n\t\t\t// Schedule next flash\n\t\t\ttimerManager.addTimeout('title-flash', flashFunction, 500);\n\t\t\ttimerManager.startTimeout('title-flash');\n\t\t};\n\n\t\t// Start the first flash\n\t\ttimerManager.addTimeout('title-flash', flashFunction, 500);\n\t\ttimerManager.startTimeout('title-flash');\n\t}\n\n\tfunction stopCountdown() {\n\t\tlog.info('‚èπÔ∏è [SecurityWarningEnhanced] Stopping countdown');\n\t\tcleanup();\n\t}\n\n\tfunction playFinalWarningSound() {\n\t\ttry {\n\t\t\tif (typeof window !== 'undefined' && window.AudioContext) {\n\t\t\t\tconst audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\n\n\t\t\t\t// Create urgent final warning sound sequence\n\t\t\t\tfor (let i = 0; i < 3; i++) {\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst oscillator = audioContext.createOscillator();\n\t\t\t\t\t\t\tconst gainNode = audioContext.createGain();\n\n\t\t\t\t\t\t\toscillator.connect(gainNode);\n\t\t\t\t\t\t\tgainNode.connect(audioContext.destination);\n\n\t\t\t\t\t\t\toscillator.frequency.setValueAtTime(1200, audioContext.currentTime);\n\t\t\t\t\t\t\tgainNode.gain.setValueAtTime(0.4, audioContext.currentTime);\n\t\t\t\t\t\t\tgainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);\n\n\t\t\t\t\t\t\toscillator.start(audioContext.currentTime);\n\t\t\t\t\t\t\toscillator.stop(audioContext.currentTime + 0.3);\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\tlog.debug('Audio beep failed in final warning:', false, e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, i * 400);\n\t\t\t\t}\n\n\t\t\t\t// Close audio context after sounds complete\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\taudioContext.close().catch(() => {});\n\t\t\t\t}, 2000);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.warn('Failed to play final warning sound:', error);\n\t\t}\n\t}\n\n\tfunction handleUserActivity() {\n\t\tif (isCleaningUp) return;\n\n\t\tlog.info('üëÜ [SecurityWarningEnhanced] User activity detected - canceling warning');\n\t\tisCleaningUp = true;\n\n\t\ttry {\n\t\t\t// Clean up our own state first\n\t\t\tcleanup();\n\n\t\t\t// Hide the security warning\n\t\t\thideSecurityWarning();\n\n\t\t\t// Send activity message to background\n\t\t\tif (browser_ext) {\n\t\t\t\tbrowser_ext.runtime\n\t\t\t\t\t.sendMessage({\n\t\t\t\t\t\ttype: 'USER_ACTIVITY',\n\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\tcontext: 'security',\n\t\t\t\t\t\taction: 'security_warning_interaction'\n\t\t\t\t\t})\n\t\t\t\t\t.catch(() => {\n\t\t\t\t\t\t// Ignore errors\n\t\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Clear all enhanced alerts through the notification service\n\t\t\tNotificationService.clearAllAlertsEnhanced().catch((error) => {\n\t\t\t\tlog.warn('Error clearing enhanced alerts from SecurityWarning:', false, error);\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tlog.error('Error in handleUserActivity:', false, error);\n\t\t} finally {\n\t\t\tisCleaningUp = false;\n\t\t}\n\t}\n\n\tfunction addListeners() {\n\t\tif (typeof window === 'undefined') return;\n\n\t\t// Use passive listeners and single-use listeners for better performance\n\t\twindow.addEventListener('mousemove', handleUserActivity, { once: true, passive: true });\n\t\twindow.addEventListener('keydown', handleUserActivity, { once: true, passive: true });\n\t\twindow.addEventListener('click', handleUserActivity, { once: true, passive: true });\n\t\twindow.addEventListener('focus', handleUserActivity, { once: true, passive: true });\n\n\t\tlog.debug('‚úÖ [SecurityWarningEnhanced] Activity listeners added');\n\t}\n\n\tfunction removeListeners() {\n\t\tif (typeof window === 'undefined') return;\n\n\t\t// Remove all listeners (in case they weren't used yet)\n\t\twindow.removeEventListener('mousemove', handleUserActivity);\n\t\twindow.removeEventListener('keydown', handleUserActivity);\n\t\twindow.removeEventListener('click', handleUserActivity);\n\t\twindow.removeEventListener('focus', handleUserActivity);\n\n\t\tlog.debug('‚úÖ [SecurityWarningEnhanced] Activity listeners removed');\n\t}\n\n\t$effect(() => {\n\t\tif (show && !isCleaningUp) {\n\t\t\taddListeners();\n\t\t} else {\n\t\t\tremoveListeners();\n\t\t}\n\t});\n\n\tonMount(() => {\n\t\tlog.info('üöÄ [SecurityWarningEnhanced] Component mounted');\n\n\t\t// Subscribe to the security warning store\n\t\tunsubscribe = securityWarningStore.subscribe((state) => {\n\t\t\tlog.info('üì¢ [SecurityWarningEnhanced] Store state changed:', false, state);\n\n\t\t\tif (state.show && !show && !isCleaningUp) {\n\t\t\t\t// Show warning\n\t\t\t\tshow = true;\n\t\t\t\ttimeLeft = state.warningTime;\n\t\t\t\tif (state.onComplete) {\n\t\t\t\t\tonComplete = state.onComplete;\n\t\t\t\t}\n\t\t\t\tstartCountdown();\n\t\t\t} else if (!state.show && show) {\n\t\t\t\t// Hide warning\n\t\t\t\tshow = false;\n\t\t\t\tstopCountdown();\n\t\t\t}\n\t\t});\n\n\t\t// Focus window when component mounts during warning\n\t\tif (show && typeof window !== 'undefined') {\n\t\t\twindow.focus();\n\t\t}\n\t});\n\n\tonDestroy(() => {\n\t\tlog.info('üî• [SecurityWarningEnhanced] Component destroyed - performing cleanup');\n\n\t\t// Ensure complete cleanup\n\t\tcleanup();\n\n\t\tif (unsubscribe) {\n\t\t\tunsubscribe();\n\t\t}\n\t});\n</script>\n\n{#if show}\n\t<div\n\t\tclass=\"fixed inset-0 z-50 flex items-start justify-center pt-4\"\n\t\ttransition:fade={{ duration: 300 }}\n\t>\n\t\t<!-- Backdrop with enhanced pulsing effect -->\n\t\t<div\n\t\t\tclass=\"fixed inset-0 bg-red-900/70 backdrop-blur-md\"\n\t\t\tclass:animate-pulse={isUrgent}\n\t\t\tstyle=\"animation-duration: {isUrgent ? '0.5s' : '2s'}\"\n\t\t></div>\n\n\t\t<!-- Enhanced warning panel -->\n\t\t<div\n\t\t\tclass=\"relative bg-gradient-to-br from-red-900 to-red-800 border-2 border-red-400 text-white p-6 rounded-xl shadow-2xl max-w-lg mx-4 {isUrgent\n\t\t\t\t? 'animate-bounce shadow-red-500/50'\n\t\t\t\t: ''}\"\n\t\t\ttransition:scale={{ duration: 400, easing: bounceIn }}\n\t\t\trole=\"alert\"\n\t\t\taria-live=\"assertive\"\n\t\t\tstyle=\"box-shadow: {isUrgent ? '0 0 30px rgba(239, 68, 68, 0.5)' : ''}\"\n\t\t>\n\t\t\t<!-- Urgent indicator with enhanced visibility -->\n\t\t\t{#if isUrgent}\n\t\t\t\t<div\n\t\t\t\t\tclass=\"absolute -top-3 -right-3 bg-yellow-400 text-red-900 px-3 py-1 rounded-full text-sm font-bold animate-ping shadow-lg\"\n\t\t\t\t>\n\t\t\t\t\tURGENT!\n\t\t\t\t</div>\n\t\t\t{/if}\n\n\t\t\t<!-- Enhanced header -->\n\t\t\t<div class=\"flex items-center justify-center space-x-4 mb-6\">\n\t\t\t\t<svg\n\t\t\t\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\t\t\t\tclass=\"h-10 w-10 text-yellow-300\"\n\t\t\t\t\tclass:animate-pulse={true}\n\t\t\t\t\tviewBox=\"0 0 20 20\"\n\t\t\t\t\tfill=\"currentColor\"\n\t\t\t\t>\n\t\t\t\t\t<path\n\t\t\t\t\t\tfill-rule=\"evenodd\"\n\t\t\t\t\t\td=\"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z\"\n\t\t\t\t\t\tclip-rule=\"evenodd\"\n\t\t\t\t\t/>\n\t\t\t\t</svg>\n\t\t\t\t<div class=\"text-center\">\n\t\t\t\t\t<h2 class=\"text-2xl font-bold\">üö® SECURITY WARNING</h2>\n\t\t\t\t\t<p class=\"text-red-200 text-sm mt-1\">Immediate attention required</p>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<!-- Enhanced countdown display -->\n\t\t\t<div class=\"text-center mb-6\">\n\t\t\t\t<div class=\"text-sm text-red-200 mb-3\">Wallet will lock due to inactivity in:</div>\n\t\t\t\t<div\n\t\t\t\t\tclass=\"text-6xl font-mono font-bold text-yellow-300 mb-3 transition-all duration-300\"\n\t\t\t\t\tclass:text-red-300={isUrgent}\n\t\t\t\t\tclass:animate-pulse={isUrgent}\n\t\t\t\t\tclass:scale-110={isUrgent}\n\t\t\t\t>\n\t\t\t\t\t{timeLeft}\n\t\t\t\t</div>\n\t\t\t\t<div class=\"text-base text-red-200 font-semibold\">seconds</div>\n\t\t\t</div>\n\n\t\t\t<!-- Enhanced progress bar -->\n\t\t\t<div class=\"w-full bg-red-800 rounded-full h-3 mb-6 shadow-inner\">\n\t\t\t\t<div\n\t\t\t\t\tclass=\"h-3 rounded-full transition-all duration-1000 shadow-sm\"\n\t\t\t\t\tclass:bg-gradient-to-r={!isUrgent}\n\t\t\t\t\tclass:from-yellow-400={!isUrgent}\n\t\t\t\t\tclass:to-yellow-300={!isUrgent}\n\t\t\t\t\tclass:bg-red-400={isUrgent}\n\t\t\t\t\tclass:animate-pulse={isUrgent}\n\t\t\t\t\tstyle=\"width: {(timeLeft / warningTime) * 100}%\"\n\t\t\t\t></div>\n\t\t\t</div>\n\n\t\t\t<!-- Enhanced action buttons -->\n\t\t\t<div class=\"flex space-x-4 mb-4\">\n\t\t\t\t<button\n\t\t\t\t\tclass=\"flex-1 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white px-6 py-4 rounded-lg font-bold text-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-500/50 shadow-lg\"\n\t\t\t\t\tonclick={handleUserActivity}\n\t\t\t\t\tdisabled={isCleaningUp}\n\t\t\t\t>\n\t\t\t\t\t‚úÖ I'm Here - Stay Active\n\t\t\t\t</button>\n\n\t\t\t\t<button\n\t\t\t\t\tclass=\"bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white px-6 py-4 rounded-lg font-bold transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-500/50 shadow-lg\"\n\t\t\t\t\tonclick={triggerLockdown}\n\t\t\t\t\tdisabled={isCleaningUp}\n\t\t\t\t>\n\t\t\t\t\tüîí Lock Now\n\t\t\t\t</button>\n\t\t\t</div>\n\n\t\t\t<!-- Enhanced additional info -->\n\t\t\t<div class=\"text-center\">\n\t\t\t\t<div class=\"text-xs text-red-200 mb-2\">\n\t\t\t\t\tClick anywhere on this warning or press any key to stay active\n\t\t\t\t</div>\n\t\t\t\t<div class=\"text-xs text-red-300 opacity-75\">\n\t\t\t\t\tYour extension badge is also showing the countdown\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n{/if}\n"],"names":["warningTime","onComplete","$$props","isCleaningUp","timerManager","UnifiedTimerManager","getInstance","cleanup","stopTimeout","removeTimeout","window","audioContext","__yakklAudioContext","state","close","catch","removeListeners","handleUserActivity","log","info","hideSecurityWarning","browser_ext","runtime","sendMessage","type","timestamp","Date","now","context","action","NotificationService","clearAllAlertsEnhanced","error","warn","removeEventListener","debug","onDestroy"],"mappings":"okBAgBOA,YAAc,GAAIC,WAAAA,mBAAoBC,QAOxC,IAAAC,aAAsB,MACtB,IAAAC,aAAeC,oBAAoBC,uBAsC9BC,UAQRH,aAAaI,YAAY,eACzBJ,aAAaK,cAAc,eAGhB,UAAAC,SAAW,YAAa,CAC5B,MAAAC,aAAgBD,OAAeE,oBACjC,GAAAD,cAAgBA,aAAaE,QAAU,SAAU,CACvCF,aAAAG,QAAQC,MAAY,QAChCL,OAAeE,oBAAsB,IACvC,CACD,CAQAI,iBACD,UAmHSC,qBACJ,GAAAd,aAAA,OAEJe,IAAIC,KAAK,2EACMhB,aAAA,KAEX,IAEHI,UAGAa,yBAGIC,YAAa,CAChBA,YAAYC,QACVC,YAAA,CACAC,KAAM,gBACNC,UAAWC,KAAKC,MAChBC,QAAS,WACTC,OAAQ,iCAERd,MAAA,OAGH,CAGAe,oBAAoBC,yBAAyBhB,MAAOiB,QAC/Cd,IAAAe,KAAK,uDAAwD,MAAOD,QAE1E,OAASA,OACJd,IAAAc,MAAM,+BAAgC,MAAOA,OAChD,QACc7B,aAAA,KAChB,CACD,UAcSa,4BACGN,SAAW,YAAA,OAGfA,OAAAwB,oBAAoB,YAAajB,oBACjCP,OAAAwB,oBAAoB,UAAWjB,oBAC/BP,OAAAwB,oBAAoB,QAASjB,oBAC7BP,OAAAwB,oBAAoB,QAASjB,oBAEpCC,IAAIiB,MAAM,yDACX,CAsCAC,UAAgB,KACflB,IAAIC,KAAK,yEAGTZ"}