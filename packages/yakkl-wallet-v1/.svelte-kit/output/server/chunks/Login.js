import{p as push,o as store_mutate,s as store_get,a as push_element,f as attr_class,m as attr,g as stringify,b as pop_element,e as escape_html,u as unsubscribe_stores,c as pop}from"./index2.js";import{c as createForm}from"./create-form.js";import{a as authStore,v as verify,j as jwtManager,s as sessionManager}from"./auth-store.js";import{f as getContextTypeStore,l as log}from"./encryption.js";import{A as AuthLoading,a as AuthError}from"./AuthLoading.js";import{F as FILENAME}from"./utils.js";Login[FILENAME]="src/lib/components/Login.svelte";function Login($$payload,$$props){push(Login);var $$store_subs;const{$$slots:$$slots,$$events:$$events,...props}=$$props;const loginButtonText=props.loginButtonText??"Unlock";const cancelButtonText=props.cancelButtonText??"Exit/Logout";const inputTextClass=props.inputTextClass??"text-base-content";const inputBgClass=props.inputBgClass??"";const contextType=getContextTypeStore();const isDappContext=contextType==="popup-dapp"||(contextType?.includes?.("dapp")??false);const minimumAuth=props.minimumAuth!==void 0?props.minimumAuth:isDappContext;let showError=false;let errorMessage="";let isLoggingIn=false;let retryCount=0;const maxRetries=3;const{form:form}=createForm({initialValues:{userName:"",password:""},onSubmit:async data=>{isLoggingIn=true;try{await verifyUser(data.userName,data.password)}finally{store_mutate($$store_subs??={},"$form",form,store_get($$store_subs??={},"$form",form).userName="");store_mutate($$store_subs??={},"$form",form,store_get($$store_subs??={},"$form",form).password="");isLoggingIn=false}}});async function verifyUser(userName,password){try{let jwtToken;if(props.useAuthStore){const profile2=await authStore.login(userName,password);const digest2=await import("./encryption.js").then(n=>n.b3).then(module=>module.getMiscStore());if(!digest2){throw"Authentication succeeded but failed to retrieve security digest"}jwtToken=authStore.getCurrentJWTToken()||void 0;props.onSuccess(profile2,digest2,minimumAuth,jwtToken);return}const normalizedUsername=userName.toLowerCase().trim().replace(".nfs.id","");const loginString=normalizedUsername+".nfs.id"+password;const profile=await verify(loginString);if(!profile){throw"Invalid credentials or profile not found"}const digest=await import("./encryption.js").then(n=>n.b3).then(module=>module.getMiscStore());if(!digest){throw"Authentication succeeded but failed to retrieve security digest"}if(props.generateJWT){try{const{getSettings:getSettings}=await import("./encryption.js").then(n=>n.b3);const settings=await getSettings();const planLevel=settings?.plan?.type||"basic";jwtToken=await jwtManager.generateToken(profile.id||profile.userName,profile.userName,profile.id||profile.userName,planLevel);if(!props.useAuthStore){await sessionManager.startSession(profile.id||profile.userName,profile.userName,profile.id||profile.userName,planLevel)}log.debug("JWT token generated for login",false,{username:normalizedUsername,hasToken:!!jwtToken})}catch(jwtError){log.warn("Failed to generate JWT token:",false,jwtError)}}props.onSuccess(profile,digest,minimumAuth,jwtToken)}catch(e){retryCount++;if(typeof e==="string"){errorMessage=e}else if(e instanceof Error){errorMessage=e.message}else{errorMessage="Authentication failed"}if(retryCount<maxRetries){errorMessage+=` (Attempt ${retryCount}/${maxRetries})`}else{errorMessage+=" - Maximum retry attempts reached."}showError=true;log.error("Login verification failed",false,{error:e,retryCount:retryCount,maxRetries:maxRetries});props.onError(e)}}async function handleRetry(){if(retryCount<maxRetries){showError=false;errorMessage="";await verifyUser(store_get($$store_subs??={},"$form",form).userName,store_get($$store_subs??={},"$form",form).password)}}function handleDismiss(){showError=false;errorMessage="";retryCount=0}$$payload.out+=`<div class="login-container">`;push_element($$payload,"div",152,0);$$payload.out+=`<form>`;push_element($$payload,"form",153,1);$$payload.out+=`<div class="mt-5 flex flex-row justify-center">`;push_element($$payload,"div",159,2);$$payload.out+=`<div class="form-control w-[22rem]">`;push_element($$payload,"div",160,3);$$payload.out+=`<div class="join">`;push_element($$payload,"div",161,4);$$payload.out+=`<input id="userName" type="text"${attr_class(`input input-bordered input-primary w-full join-item ${stringify(inputTextClass)} ${stringify(inputBgClass)}`)} placeholder="Username" autocomplete="off"${attr("value",store_get($$store_subs??={},"$form",form).userName)} required/>`;push_element($$payload,"input",162,5);pop_element();$$payload.out+=` <span class="label-text bg-slate-900 join-item w-[60px]">`;push_element($$payload,"span",171,5);$$payload.out+=`<div class="mt-[.9rem]">`;push_element($$payload,"div",172,6);$$payload.out+=`.nfs.id</div>`;pop_element();$$payload.out+=`</span>`;pop_element();$$payload.out+=`</div>`;pop_element();$$payload.out+=`</div>`;pop_element();$$payload.out+=`</div>`;pop_element();$$payload.out+=` <div class="mt-5 flex flex-row justify-center">`;push_element($$payload,"div",178,2);$$payload.out+=`<div class="form-control w-[22rem]">`;push_element($$payload,"div",179,3);$$payload.out+=`<input id="password" type="password"${attr_class(`input input-bordered input-primary w-full mt-2 ${stringify(inputTextClass)} ${stringify(inputBgClass)}`)} placeholder="Password" autocomplete="off"${attr("value",store_get($$store_subs??={},"$form",form).password)} required/>`;push_element($$payload,"input",180,4);pop_element();$$payload.out+=`  <svg id="pweye-closed" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 ml-1 fill-gray-200 absolute right-12 z-10 mt-5 cursor-pointer">`;push_element($$payload,"svg",193,4);$$payload.out+=`<path d="M3.53 2.47a.75.75 0 00-1.06 1.06l18 18a.75.75 0 101.06-1.06l-18-18zM22.676 12.553a11.249 11.249 0 01-2.631 4.31l-3.099-3.099a5.25 5.25 0 00-6.71-6.71L7.759 4.577a11.217 11.217 0 014.242-.827c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113z">`;push_element($$payload,"path",201,5);$$payload.out+=`</path>`;pop_element();$$payload.out+=`<path d="M15.75 12c0 .18-.013.357-.037.53l-4.244-4.243A3.75 3.75 0 0115.75 12zM12.53 15.713l-4.243-4.244a3.75 3.75 0 004.243 4.243z">`;push_element($$payload,"path",204,5);$$payload.out+=`</path>`;pop_element();$$payload.out+=`<path d="M6.75 12c0-.619.107-1.213.304-1.764l-3.1-3.1a11.25 11.25 0 00-2.63 4.31c-.12.362-.12.752 0 1.114 1.489 4.467 5.704 7.69 10.675 7.69 1.5 0 2.933-.294 4.242-.827l-2.477-2.477A5.25 5.25 0 016.75 12z">`;push_element($$payload,"path",207,5);$$payload.out+=`</path>`;pop_element();$$payload.out+=`</svg>`;pop_element();$$payload.out+=`  <svg id="pweye-open" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 ml-1 fill-gray-200 absolute right-12 z-10 mt-5 cursor-pointer">`;push_element($$payload,"svg",214,4);$$payload.out+=`<path d="M12 15a3 3 0 100-6 3 3 0 000 6z">`;push_element($$payload,"path",222,5);$$payload.out+=`</path>`;pop_element();$$payload.out+=`<path fill-rule="evenodd" d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 010-1.113zM17.25 12a5.25 5.25 0 11-10.5 0 5.25 5.25 0 0110.5 0z" clip-rule="evenodd">`;push_element($$payload,"path",223,5);$$payload.out+=`</path>`;pop_element();$$payload.out+=`</svg>`;pop_element();$$payload.out+=`</div>`;pop_element();$$payload.out+=`</div>`;pop_element();$$payload.out+=` <div class="inline-block text-center">`;push_element($$payload,"div",232,2);$$payload.out+=`<button type="submit" class="bg-emerald-400 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-full mt-3 w-64"${attr("disabled",isLoggingIn,true)}>`;push_element($$payload,"button",233,3);$$payload.out+=`<div class="inline-flex items-center align-middle">`;push_element($$payload,"div",238,4);$$payload.out+=`<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">`;push_element($$payload,"svg",239,5);$$payload.out+=`<path stroke-linecap="round" stroke-linejoin="round" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z">`;push_element($$payload,"path",247,6);$$payload.out+=`</path>`;pop_element();$$payload.out+=`</svg>`;pop_element();$$payload.out+=` <span>`;push_element($$payload,"span",253,5);$$payload.out+=`${escape_html(isLoggingIn?"Unlocking...":loginButtonText)}</span>`;pop_element();$$payload.out+=`</div>`;pop_element();$$payload.out+=`</button>`;pop_element();$$payload.out+=` <button type="button" class="bg-slate-400 hover:bg-slate-500 w-64 rounded-full py-2 px-4 mt-3 font-bold text-white">`;push_element($$payload,"button",257,3);$$payload.out+=`<div class="inline-flex items-center align-middle">`;push_element($$payload,"div",262,4);$$payload.out+=`<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" stroke="currentColor" class="w-6 h-6 mx-2">`;push_element($$payload,"svg",263,5);$$payload.out+=`<path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 015.25 2h5.5A2.25 2.25 0 0113 4.25v2a.75.75 0 01-1.5 0v-2a.75.75 0 00-.75-.75h-5.5a.75.75 0 00-.75.75v11.5c0 .414.336.75.75.75h5.5a.75.75 0 00.75-.75v-2a.75.75 0 011.5 0v2A2.25 2.25 0 0110.75 18h-5.5A2.25 2.25 0 013 15.75V4.25z" clip-rule="evenodd">`;push_element($$payload,"path",270,6);$$payload.out+=`</path>`;pop_element();$$payload.out+=`<path fill-rule="evenodd" d="M19 10a.75.75 0 00-.75-.75H8.704l1.048-.943a.75.75 0 10-1.004-1.114l-2.5 2.25a.75.75 0 000 1.114l2.5 2.25a.75.75 0 101.004-1.114l-1.048-.943h9.546A.75.75 0 0019 10z" clip-rule="evenodd">`;push_element($$payload,"path",275,6);$$payload.out+=`</path>`;pop_element();$$payload.out+=`</svg>`;pop_element();$$payload.out+=` <span>`;push_element($$payload,"span",281,5);$$payload.out+=`${escape_html(cancelButtonText)}</span>`;pop_element();$$payload.out+=`</div>`;pop_element();$$payload.out+=`</button>`;pop_element();$$payload.out+=`</div>`;pop_element();$$payload.out+=`</form>`;pop_element();$$payload.out+=` `;if(isLoggingIn){$$payload.out+="\x3c!--[--\x3e";AuthLoading($$payload,{message:"Authenticating...",variant:"spinner",size:"md",className:"mt-4"})}else{$$payload.out+="\x3c!--[!--\x3e"}$$payload.out+=`\x3c!--]--\x3e `;AuthError($$payload,{error:showError?errorMessage:null,onRetry:retryCount<maxRetries&&!isLoggingIn?handleRetry:void 0,onDismiss:!isLoggingIn?handleDismiss:void 0});$$payload.out+=`\x3c!----\x3e</div>`;pop_element();if($$store_subs)unsubscribe_stores($$store_subs);pop()}Login.render=function(){throw new Error("Component.render(...) is no longer valid in Svelte 5. See https://svelte.dev/docs/svelte/v5-migration-guide#Components-are-no-longer-classes for more information")};export{Login as L};
//# sourceMappingURL=Login.js.map
