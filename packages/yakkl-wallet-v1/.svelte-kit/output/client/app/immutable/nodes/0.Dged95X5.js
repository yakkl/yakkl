import{l as log,b6 as YAKKL_INTERNAL,i as PATH_LOGOUT}from"../chunks/Cb2naUpm.js";import{i as isServerSide,w as wait}from"../chunks/BgnL0Zd7.js";import{h as handleLockDown}from"../chunks/CZieKDFj.js";import{i as initializeBrowserAPI}from"../chunks/DPTaukvs.js";import{a as browser_ext}from"../chunks/CgCfpVku.js";import{c as check_target,l as legacy_api}from"../chunks/BXFaAXnq.js";import{p as push,h as tag,i as state,ae as proxy,u as user_derived,g as get,ay as user_effect,e as set,ak as update,b0 as $window,c as child,s as sibling,r as reset,j as next,t as template_effect,a as pop,b as strict_equals,F as FILENAME,o as onMount,f as first_child,n as noop}from"../chunks/BaS8d5lg.js";import{a as append,f as from_html,c as comment}from"../chunks/Cm3jf07C.js";import{w as wrap_snippet,s as snippet}from"../chunks/d5hrMixo.js";import{g as get$1}from"../chunks/B2gA1VsD.js";/* empty css                */import{a as storeSessionToken,c as sessionExpiresAt,b as sessionToken}from"../chunks/CMG1aIle.js";import{l as log$1}from"../chunks/WDN37msH.js";import{a as add_locations}from"../chunks/3AhEABF_.js";import{i as if_block}from"../chunks/Q1yPWpQ-.js";import{s as setup_stores,b as store_set,m as mark_store_binding,a as store_get}from"../chunks/CViNpZsE.js";import{v as validate_store}from"../chunks/Dv9a3G0k.js";import{g as goto}from"../chunks/CkqS9PXN.js";import{b as showSessionWarning,a as authStore,c as sessionTimeRemaining}from"../chunks/DmxAnVWO.js";import{s as set_text}from"../chunks/Cmwrv3PW.js";import{c as create_ownership_validator}from"../chunks/COgMMZ9C.js";import{d as delegate,e as event}from"../chunks/DiU70Is3.js";import{s as set_class}from"../chunks/DX_EEhpR.js";import{p as prop}from"../chunks/BYboeQtC.js";import{M as Modal}from"../chunks/UU1vCwIM.js";import{p as protectedContexts}from"../chunks/D59oTG1g.js";const prerender=true;let port;async function connectPort(){if(!browser_ext){return false}try{port=browser_ext.runtime.connect({name:YAKKL_INTERNAL});if(port){port.onDisconnect.addListener(async event2=>{var _a;handleLockDown();port=void 0;if(event2==null?void 0:event2.error){log.error("Port disconnect:",false,(_a=event2.error)==null?void 0:_a.message)}});return true}}catch(error){log.error("Port connection failed:",false,error)}return false}async function initializeExtension(){try{let connected=await connectPort();if(!connected){log.info("Port connection failed, retrying in 1 second...");await wait(1e3);connected=await connectPort()}}catch(error){log.error("Extension initialization failed:",false,error)}}const load=async()=>{if(isServerSide()){return{}}try{const browser=initializeBrowserAPI();if(browser){await initializeExtension()}}catch(error){log.error("Error initializing extension:",false,error)}return{}};const _layout$1=Object.freeze(Object.defineProperty({__proto__:null,load:load,prerender:prerender},Symbol.toStringTag,{value:"Module"}));SessionWarning[FILENAME]="src/lib/components/SessionWarning.svelte";var root_2=add_locations(from_html(`<div class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full animate-ping"></div>`),SessionWarning[FILENAME],[[116,5]]);var root_1=add_locations(from_html(`<div class="p-6 text-center space-y-6"><div class="flex flex-col items-center space-y-4"><div class="relative"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg> <!></div> <div class="text-center"><h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Your session is about to expire</h3> <div> </div> <p class="text-sm text-gray-600 dark:text-gray-400 mt-2"> </p></div></div> <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg"><p class="text-sm text-blue-800 dark:text-blue-200">For your security, we automatically log you out after periods of inactivity. You can extend\n\t\t\t\tyour session to continue working.</p></div> <div class="flex gap-4 justify-center"><button class="px-6 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" title="Logout Now (Esc)">Logout Now</button> <button title="Extend Session (Enter)">Extend Session (+30 min)</button></div> <div class="text-xs text-gray-500 dark:text-gray-400 border-t pt-4"><p>Keyboard shortcuts: <kbd class="px-1 py-0.5 bg-gray-200 dark:bg-gray-700 rounded text-xs">Enter</kbd> to extend, <kbd class="px-1 py-0.5 bg-gray-200 dark:bg-gray-700 rounded text-xs">Esc</kbd> to\n\t\t\t\tlogout</p></div></div>`),SessionWarning[FILENAME],[[93,1,[[95,2,[[96,3,[[97,4,[[108,5]]]]],[120,3,[[121,4],[124,4],[133,4]]]]],[144,2,[[145,3]]],[152,2,[[153,3],[160,3]]],[172,2,[[173,3,[[174,24],[177,15]]]]]]]]);function SessionWarning($$anchor,$$props){check_target(new.target);push($$props,true,SessionWarning);var $$ownership_validator=create_ownership_validator($$props);let show=prop($$props,"show",15,false),autoLogoutEnabled=prop($$props,"autoLogoutEnabled",3,true);let countdownInterval=null;let localTimeRemaining=tag(state(proxy($$props.timeRemaining)),"localTimeRemaining");const formattedTime=tag(user_derived(()=>()=>{try{const timeValue=get(localTimeRemaining)||0;const validTimeRemaining=Math.max(0,Math.floor(timeValue));const minutes=Math.floor(validTimeRemaining/60);const seconds=validTimeRemaining%60;return`${minutes}:${seconds.toString().padStart(2,"0")}`}catch(error){log.error("Error formatting time:",false,error);return"0:00"}}),"formattedTime");const isUrgent=tag(user_derived(()=>get(localTimeRemaining)<=30),"isUrgent");const isCritical=tag(user_derived(()=>get(localTimeRemaining)<=10),"isCritical");user_effect(()=>{set(localTimeRemaining,$$props.timeRemaining,true)});user_effect(()=>{if(show()&&autoLogoutEnabled()){countdownInterval=setInterval(()=>{update(localTimeRemaining,-1);if(get(localTimeRemaining)<=0){log.warn("Session expired - auto logout",false);handleLogoutNow()}},1e3);return()=>{if(countdownInterval){clearInterval(countdownInterval);countdownInterval=null}}}});user_effect(()=>()=>{if(countdownInterval){clearInterval(countdownInterval)}});function handleExtendSession(){try{$$props.onExtendSession();show(false);log.debug("Session extended by user",false)}catch(error){log.error("Failed to extend session:",false,error)}}function handleLogoutNow(){try{if(countdownInterval){clearInterval(countdownInterval);countdownInterval=null}$$props.onLogoutNow();show(false);log.debug("User logged out via session warning",false)}catch(error){log.error("Failed to logout:",false,error)}}function handleKeydown(event2){if(!show())return;if(strict_equals(event2.key,"Enter")){event2.preventDefault();event2.stopPropagation();handleExtendSession()}else if(strict_equals(event2.key,"Escape")){event2.preventDefault();event2.stopPropagation();handleLogoutNow()}}event("keydown",$window,handleKeydown);{$$ownership_validator.binding("show",Modal,show);Modal($$anchor,{title:"Session Expiring",className:"z-[800]",preventClose:false,onClose:handleLogoutNow,get show(){return show()},set show($$value){show($$value)},children:wrap_snippet(SessionWarning,($$anchor2,$$slotProps)=>{var div=root_1();var div_1=child(div);var div_2=child(div_1);var svg=child(div_2);var node=sibling(svg,2);{var consequent=$$anchor3=>{var div_3=root_2();append($$anchor3,div_3)};if_block(node,$$render=>{if(get(isCritical))$$render(consequent)})}reset(div_2);var div_4=sibling(div_2,2);var div_5=sibling(child(div_4),2);var text=child(div_5,true);reset(div_5);var p=sibling(div_5,2);var text_1=child(p,true);reset(p);reset(div_4);reset(div_1);var div_6=sibling(div_1,4);var button=child(div_6);button.__click=handleLogoutNow;var button_1=sibling(button,2);button_1.__click=handleExtendSession;reset(div_6);next(2);reset(div);template_effect(()=>{set_class(svg,0,`w-16 h-16 ${get(isCritical)?"text-red-500 animate-pulse":get(isUrgent)?"text-orange-500 animate-bounce":"text-yellow-500"}`);set_class(div_5,1,`text-3xl font-mono font-bold ${get(isCritical)?"text-red-500":get(isUrgent)?"text-orange-500":"text-yellow-600"}`);set_text(text,get(formattedTime));set_text(text_1,get(isCritical)?"Logging out in seconds!":get(isUrgent)?"Time is running out!":"You will be automatically logged out for security.");set_class(button_1,1,`px-6 py-3 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors shadow-md ${get(isCritical)?"animate-pulse":""}`)});append($$anchor2,div)}),$$slots:{default:true}})}return pop({...legacy_api()})}delegate(["click"]);SessionProvider[FILENAME]="src/lib/components/SessionProvider.svelte";var root=add_locations(from_html(`<!> <!>`,1),SessionProvider[FILENAME],[]);function SessionProvider($$anchor,$$props){check_target(new.target);push($$props,true,SessionProvider);const[$$stores,$$cleanup]=setup_stores();const $showSessionWarning=()=>(validate_store(showSessionWarning,"showSessionWarning"),store_get(showSessionWarning,"$showSessionWarning",$$stores));const $sessionTimeRemaining=()=>(validate_store(sessionTimeRemaining,"sessionTimeRemaining"),store_get(sessionTimeRemaining,"$sessionTimeRemaining",$$stores));let shouldShowSessionWarning=tag(state(false),"shouldShowSessionWarning");function getCurrentContextType(){try{if(strict_equals(typeof window,"undefined"))return"unknown";const pathname=window.location.pathname;const href=window.location.href;if(pathname.includes("sidepanel")||href.includes("sidepanel")){return"sidepanel"}else if(pathname.includes("index.html")||href.includes("index.html")||strict_equals(pathname,"/")||strict_equals(pathname,"")){return"popup-wallet"}else if(pathname.includes("dapp/popups")||href.includes("dapp/popups")){return"popup-dapp"}else{return"popup-wallet"}}catch(error){return"unknown"}}function currentContextNeedsSessionWarning(){const contextType=getCurrentContextType();return protectedContexts.includes(contextType)}onMount(()=>{set(shouldShowSessionWarning,currentContextNeedsSessionWarning(),true);log.debug("SessionProvider context check:",false,{contextType:getCurrentContextType(),shouldShowSessionWarning:get(shouldShowSessionWarning)})});async function handleExtendSession(){try{await authStore.extendSession(30);log.debug("Session extended via session provider",false)}catch(error){log.error("Failed to extend session:",false,error)}}async function handleLogoutNow(){try{await authStore.logout();log.debug("User logged out via session provider",false);goto(PATH_LOGOUT)}catch(error){log.error("Failed to logout:",false,error);goto(PATH_LOGOUT)}}var fragment=root();var node=first_child(fragment);snippet(node,()=>$$props.children);var node_1=sibling(node,2);{var consequent=$$anchor2=>{SessionWarning($$anchor2,{get timeRemaining(){return $sessionTimeRemaining()},onExtendSession:handleExtendSession,onLogoutNow:handleLogoutNow,autoLogoutEnabled:true,get show(){mark_store_binding();return $showSessionWarning()},set show($$value){store_set(showSessionWarning,$$value)}})};if_block(node_1,$$render=>{if(get(shouldShowSessionWarning))$$render(consequent)})}append($$anchor,fragment);var $$pop=pop({...legacy_api()});$$cleanup();return $$pop}_layout[FILENAME]="src/routes/+layout.svelte";function _layout($$anchor,$$props){check_target(new.target);push($$props,true,_layout);onMount(async()=>{try{browser_ext.runtime.onMessage.addListener(message=>{if(strict_equals(message==null?void 0:message.type,"SESSION_TOKEN_BROADCAST")){storeSessionToken(message.token,message.expiresAt);log$1.info("[Layout] Session token set:",false,{sessionToken:sessionToken,sessionExpiresAt:sessionExpiresAt},get$1(sessionToken),get$1(sessionExpiresAt))}return false});initializeBrowserAPI()}catch(error){log$1.warn("Error initializing layout:",false,error)}});SessionProvider($$anchor,{children:wrap_snippet(_layout,($$anchor2,$$slotProps)=>{var fragment_1=comment();var node=first_child(fragment_1);snippet(node,()=>$$props.children??noop);append($$anchor2,fragment_1)}),$$slots:{default:true}});return pop({...legacy_api()})}export{_layout as component,_layout$1 as universal};
//# sourceMappingURL=0.Dged95X5.js.map
