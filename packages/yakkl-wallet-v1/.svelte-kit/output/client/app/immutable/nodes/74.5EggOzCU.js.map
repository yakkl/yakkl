{"version":3,"mappings":"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","names":["loginButtonText","$.tag","$.derived","$$props","cancelButtonText","inputTextClass","inputBgClass","contextType","$.tag_proxy","$.proxy","getContextTypeStore","isDappContext","$.strict_equals","_a","includes","minimumAuth","$.get","showError","$.state","errorMessage","pweyeOpen","isLoggingIn","retryCount","maxRetries","form","handleSubmit","createForm","initialValues","userName","password","onSubmit","async","data","verifyUser","store_mutate","$.untrack","$form","jwtToken","useAuthStore","profile","authStore","login","digest","__VITE_PRELOAD__","url","then","module","getMiscStore","getCurrentJWTToken","onSuccess","normalizedUsername","toLowerCase","trim","replace","loginString","verify","__vitePreload","import","generateJWT","getSettings","n","dg","settings","planLevel","plan","type","jwtManager","generateToken","id","sessionManager","startSession","log","debug","username","hasToken","jwtError","warn","e","$.update","set","Error","message","error","onError","togglePasswordVisibility","document","pwField","getElementById","pwEyeOpen","pwEyeClosed","removeAttribute","setAttribute","handleRetry","handleDismiss","$.user_effect","onCancel","this","$$args","Login","$$render","consequent","expression_1","$.set_class","input","input_1","event","form_1","preventDefault","$.bind_value","$$value","$.store_mutate","errorValue","planType","PlanType","BASIC_MEMBER","yakklSettings","formatPlanType","split","map","word","charAt","toUpperCase","slice","join","onMount","getNormalizedSettings","setSettingsStorage","isMinimal","store_set","yakklUserNameStore","setIconUnlock","syncStorageToStore","setLocks","get","protectedContexts","info","startActivityTracking","Promise","resolve","setTimeout","sessionStorage","setItem","safeNavigate","replaceState","invalidateAll","value","safeLogout","onClose","YAKKL_PRO","FOUNDING_MEMBER","EARLY_ADOPTER","$.template_effect","$0","$.set_text","text_3","consequent_2","alternate_2","consequent_1","alternate_1","alternate"],"ignoreList":[],"sources":["../../../../../../src/routes/preview2/lib/components/Login.svelte","../../../../../../src/routes/preview2/login/+page.svelte"],"sourcesContent":["<!-- Login.svelte -->\n<script lang=\"ts\">\n\timport { createForm } from 'svelte-forms-lib';\n\timport { verify } from '$lib/common/security';\n\timport { getContextTypeStore } from '$lib/common/stores';\n\timport { log } from '$lib/common/logger-wrapper';\n\timport { authStore } from '$lib/stores/auth-store';\n\timport AuthError from '$lib/components/AuthError.svelte';\n\timport AuthLoading from '$lib/components/AuthLoading.svelte';\n\timport { sessionManager } from '$lib/managers/SessionManager';\n\timport { jwtManager } from '$lib/utilities/jwt';\n\n\t// Props using runes syntax\n\tconst props = $props<{\n\t\tonSuccess: (profile: any, digest: string, isMinimal: boolean, jwtToken?: string) => void;\n\t\tonError: (error: any) => void;\n\t\tonCancel: () => void;\n\t\tloginButtonText?: string;\n\t\tcancelButtonText?: string;\n\t\tminimumAuth?: boolean;\n\t\trequestId?: string;\n\t\tmethod?: string;\n\t\tuseAuthStore?: boolean; // Optional flag to update auth store on login\n\t\tgenerateJWT?: boolean; // Optional flag to generate JWT token on login\n\t\tinputTextClass?: string; // Custom text color class for inputs\n\t\tinputBgClass?: string; // Custom background class for inputs\n\t}>();\n\n\tconst loginButtonText = $derived(props.loginButtonText ?? 'Unlock');\n\tconst cancelButtonText = $derived(props.cancelButtonText ?? 'Exit/Logout');\n\n\t// Default to DaisyUI default colors (no explicit text/bg colors)\n\tconst inputTextClass = $derived(props.inputTextClass ?? 'text-base-content');\n\tconst inputBgClass = $derived(props.inputBgClass ?? '');\n\n\t// Local state\n\tconst contextType = $state(getContextTypeStore());\n\tconst isDappContext = $derived(\n\t\tcontextType === 'popup-dapp' || (contextType?.includes?.('dapp') ?? false)\n\t);\n\tconst minimumAuth = $derived(props.minimumAuth !== undefined ? props.minimumAuth : isDappContext);\n\n\t// Form state\n\tlet showError = $state(false);\n\tlet errorMessage = $state('');\n\tlet pweyeOpen = $state(false);\n\tlet isLoggingIn = $state(false);\n\tlet retryCount = $state(0);\n\tconst maxRetries = 3;\n\n\t// Form setup with svelte-forms-lib\n\tconst { form, errors, handleSubmit } = createForm({\n\t\tinitialValues: { userName: '', password: '' },\n\t\tonSubmit: async (data) => {\n\t\t\tisLoggingIn = true;\n\t\t\ttry {\n\t\t\t\tawait verifyUser(data.userName, data.password);\n\t\t\t} finally {\n\t\t\t\t// Clear form data for security regardless of outcome\n\t\t\t\t$form.userName = '';\n\t\t\t\t$form.password = '';\n\t\t\t\tisLoggingIn = false;\n\t\t\t}\n\t\t}\n\t});\n\n\tasync function verifyUser(userName: string, password: string) {\n\t\ttry {\n\t\t\tlet jwtToken: string | undefined;\n\n\t\t\t// If useAuthStore is enabled, use the auth store login method\n\t\t\tif (props.useAuthStore) {\n\t\t\t\tconst profile = await authStore.login(userName, password);\n\t\t\t\tconst digest = await import('$lib/common/stores').then((module) => module.getMiscStore());\n\n\t\t\t\tif (!digest) {\n\t\t\t\t\tthrow 'Authentication succeeded but failed to retrieve security digest';\n\t\t\t\t}\n\n\t\t\t\t// Get JWT token from auth store if available\n\t\t\t\tjwtToken = authStore.getCurrentJWTToken() || undefined;\n\n\t\t\t\tprops.onSuccess(profile, digest, minimumAuth, jwtToken);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Original verification method\n\t\t\t// Format the username properly (removing .nfs.id if already present, then adding it)\n\t\t\tconst normalizedUsername = userName.toLowerCase().trim().replace('.nfs.id', '');\n\t\t\tconst loginString = normalizedUsername + '.nfs.id' + password;\n\n\t\t\t// Call the existing verify function - this is your core authentication\n\t\t\tconst profile = await verify(loginString);\n\n\t\t\tif (!profile) {\n\t\t\t\tthrow 'Invalid credentials or profile not found';\n\t\t\t}\n\n\t\t\t// Get the digest that was set during verification\n\t\t\t// This is important as it's used for decryption throughout the app\n\t\t\tconst digest = await import('$lib/common/stores').then((module) => module.getMiscStore());\n\n\t\t\tif (!digest) {\n\t\t\t\tthrow 'Authentication succeeded but failed to retrieve security digest';\n\t\t\t}\n\n\t\t\t// Generate JWT token if requested\n\t\t\tif (props.generateJWT) {\n\t\t\t\ttry {\n\t\t\t\t\t// Get user's plan level for JWT\n\t\t\t\t\tconst { getSettings } = await import('$lib/common/stores');\n\t\t\t\t\tconst settings = await getSettings();\n\t\t\t\t\tconst planLevel = settings?.plan?.type || 'basic';\n\n\t\t\t\t\t// Generate JWT token\n\t\t\t\t\tjwtToken = await jwtManager.generateToken(\n\t\t\t\t\t\tprofile.id || profile.userName,\n\t\t\t\t\t\tprofile.userName,\n\t\t\t\t\t\tprofile.id || profile.userName,\n\t\t\t\t\t\tplanLevel\n\t\t\t\t\t);\n\n\t\t\t\t\t// Also start session management if not using auth store\n\t\t\t\t\tif (!props.useAuthStore) {\n\t\t\t\t\t\tawait sessionManager.startSession(\n\t\t\t\t\t\t\tprofile.id || profile.userName,\n\t\t\t\t\t\t\tprofile.userName,\n\t\t\t\t\t\t\tprofile.id || profile.userName,\n\t\t\t\t\t\t\tplanLevel\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\tlog.debug('JWT token generated for login', false, {\n\t\t\t\t\t\tusername: normalizedUsername,\n\t\t\t\t\t\thasToken: !!jwtToken\n\t\t\t\t\t});\n\t\t\t\t} catch (jwtError) {\n\t\t\t\t\tlog.warn('Failed to generate JWT token:', false, jwtError);\n\t\t\t\t\t// Continue without JWT - don't fail the login\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Call success handler with profile, digest, minimal flag, and optional JWT\n\t\t\tprops.onSuccess(profile, digest, minimumAuth, jwtToken);\n\t\t} catch (e) {\n\t\t\t// Increment retry count\n\t\t\tretryCount++;\n\n\t\t\t// Format error for display with more specific messages\n\t\t\tif (typeof e === 'string') {\n\t\t\t\terrorMessage = e;\n\t\t\t} else if (e instanceof Error) {\n\t\t\t\terrorMessage = e.message;\n\t\t\t} else {\n\t\t\t\terrorMessage = 'Authentication failed';\n\t\t\t}\n\n\t\t\t// Add retry guidance if max retries not reached\n\t\t\tif (retryCount < maxRetries) {\n\t\t\t\terrorMessage += ` (Attempt ${retryCount}/${maxRetries})`;\n\t\t\t} else {\n\t\t\t\terrorMessage += ' - Maximum retry attempts reached.';\n\t\t\t}\n\n\t\t\tshowError = true;\n\t\t\tlog.error('Login verification failed', false, { error: e, retryCount, maxRetries });\n\t\t\tprops.onError(e);\n\t\t}\n\t}\n\n\tfunction togglePasswordVisibility() {\n\t\tif (!document) return;\n\n\t\tconst pwField = document.getElementById('password') as HTMLInputElement;\n\t\tconst pwEyeOpen = document.getElementById('pweye-open');\n\t\tconst pwEyeClosed = document.getElementById('pweye-closed');\n\n\t\tif (!pwField || !pwEyeOpen || !pwEyeClosed) return;\n\n\t\tif (pwField.type === 'password') {\n\t\t\tpwField.type = 'text';\n\t\t\tpwEyeOpen.removeAttribute('hidden');\n\t\t\tpwEyeClosed.setAttribute('hidden', 'hidden');\n\t\t\tpweyeOpen = true;\n\t\t} else {\n\t\t\tpwField.type = 'password';\n\t\t\tpwEyeOpen.setAttribute('hidden', 'hidden');\n\t\t\tpwEyeClosed.removeAttribute('hidden');\n\t\t\tpweyeOpen = false;\n\t\t}\n\t}\n\n\t// Retry function\n\tasync function handleRetry() {\n\t\tif (retryCount < maxRetries) {\n\t\t\tshowError = false;\n\t\t\terrorMessage = '';\n\t\t\t// Re-enable form and try again with current form values\n\t\t\tawait verifyUser($form.userName, $form.password);\n\t\t}\n\t}\n\n\t// Dismiss error\n\tfunction handleDismiss() {\n\t\tshowError = false;\n\t\terrorMessage = '';\n\t\tretryCount = 0; // Reset retry count on manual dismiss\n\t}\n\n\t// Initialize eye icons on component mount\n\t$effect(() => {\n\t\tif (!document) return;\n\t\tconst pwEyeOpen = document.getElementById('pweye-open');\n\t\tconst pwEyeClosed = document.getElementById('pweye-closed');\n\n\t\tif (pwEyeOpen && pwEyeClosed) {\n\t\t\tpwEyeOpen.setAttribute('tabindex', '-1');\n\t\t\tpwEyeClosed.setAttribute('tabindex', '-1');\n\t\t\tpwEyeOpen.setAttribute('hidden', 'hidden');\n\t\t}\n\t});\n</script>\n\n<div class=\"login-container\">\n\t<form\n\t\tonsubmit={(e) => {\n\t\t\te.preventDefault();\n\t\t\thandleSubmit(e);\n\t\t}}\n\t>\n\t\t<div class=\"mt-5 flex flex-row justify-center\">\n\t\t\t<div class=\"form-control w-[22rem]\">\n\t\t\t\t<div class=\"join\">\n\t\t\t\t\t<input\n\t\t\t\t\t\tid=\"userName\"\n\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\tclass=\"input input-bordered input-primary w-full join-item {inputTextClass} {inputBgClass}\"\n\t\t\t\t\t\tplaceholder=\"Username\"\n\t\t\t\t\t\tautocomplete=\"off\"\n\t\t\t\t\t\tbind:value={$form.userName}\n\t\t\t\t\t\trequired\n\t\t\t\t\t/>\n\t\t\t\t\t<span class=\"label-text bg-slate-900 join-item w-[60px]\">\n\t\t\t\t\t\t<div class=\"mt-[.9rem]\">.nfs.id</div>\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\n\t\t<div class=\"mt-5 flex flex-row justify-center\">\n\t\t\t<div class=\"form-control w-[22rem]\">\n\t\t\t\t<input\n\t\t\t\t\tid=\"password\"\n\t\t\t\t\ttype=\"password\"\n\t\t\t\t\tclass=\"input input-bordered input-primary w-full mt-2 {inputTextClass} {inputBgClass}\"\n\t\t\t\t\tplaceholder=\"Password\"\n\t\t\t\t\tautocomplete=\"off\"\n\t\t\t\t\tbind:value={$form.password}\n\t\t\t\t\trequired\n\t\t\t\t/>\n\n\t\t\t\t<!-- Password visibility toggle icons -->\n\t\t\t\t<!-- svelte-ignore a11y_click_events_have_key_events -->\n\t\t\t\t<!-- svelte-ignore a11y_no_static_element_interactions -->\n\t\t\t\t<svg\n\t\t\t\t\tid=\"pweye-closed\"\n\t\t\t\t\tonclick={togglePasswordVisibility}\n\t\t\t\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\t\t\t\tviewBox=\"0 0 24 24\"\n\t\t\t\t\tfill=\"currentColor\"\n\t\t\t\t\tclass=\"w-6 h-6 ml-1 fill-gray-200 absolute right-12 z-10 mt-5 cursor-pointer\"\n\t\t\t\t>\n\t\t\t\t\t<path\n\t\t\t\t\t\td=\"M3.53 2.47a.75.75 0 00-1.06 1.06l18 18a.75.75 0 101.06-1.06l-18-18zM22.676 12.553a11.249 11.249 0 01-2.631 4.31l-3.099-3.099a5.25 5.25 0 00-6.71-6.71L7.759 4.577a11.217 11.217 0 014.242-.827c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113z\"\n\t\t\t\t\t/>\n\t\t\t\t\t<path\n\t\t\t\t\t\td=\"M15.75 12c0 .18-.013.357-.037.53l-4.244-4.243A3.75 3.75 0 0115.75 12zM12.53 15.713l-4.243-4.244a3.75 3.75 0 004.243 4.243z\"\n\t\t\t\t\t/>\n\t\t\t\t\t<path\n\t\t\t\t\t\td=\"M6.75 12c0-.619.107-1.213.304-1.764l-3.1-3.1a11.25 11.25 0 00-2.63 4.31c-.12.362-.12.752 0 1.114 1.489 4.467 5.704 7.69 10.675 7.69 1.5 0 2.933-.294 4.242-.827l-2.477-2.477A5.25 5.25 0 016.75 12z\"\n\t\t\t\t\t/>\n\t\t\t\t</svg>\n\n\t\t\t\t<!-- svelte-ignore a11y_click_events_have_key_events -->\n\t\t\t\t<!-- svelte-ignore a11y_no_static_element_interactions -->\n\t\t\t\t<svg\n\t\t\t\t\tid=\"pweye-open\"\n\t\t\t\t\tonclick={togglePasswordVisibility}\n\t\t\t\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\t\t\t\tviewBox=\"0 0 24 24\"\n\t\t\t\t\tfill=\"currentColor\"\n\t\t\t\t\tclass=\"w-6 h-6 ml-1 fill-gray-200 absolute right-12 z-10 mt-5 cursor-pointer\"\n\t\t\t\t>\n\t\t\t\t\t<path d=\"M12 15a3 3 0 100-6 3 3 0 000 6z\" />\n\t\t\t\t\t<path\n\t\t\t\t\t\tfill-rule=\"evenodd\"\n\t\t\t\t\t\td=\"M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 010-1.113zM17.25 12a5.25 5.25 0 11-10.5 0 5.25 5.25 0 0110.5 0z\"\n\t\t\t\t\t\tclip-rule=\"evenodd\"\n\t\t\t\t\t/>\n\t\t\t\t</svg>\n\t\t\t</div>\n\t\t</div>\n\n\t\t<div class=\"inline-block text-center\">\n\t\t\t<button\n\t\t\t\ttype=\"submit\"\n\t\t\t\tclass=\"bg-emerald-400 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-full mt-3 w-64\"\n\t\t\t\tdisabled={isLoggingIn}\n\t\t\t>\n\t\t\t\t<div class=\"inline-flex items-center align-middle\">\n\t\t\t\t\t<svg\n\t\t\t\t\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\t\t\t\t\tclass=\"h-6 w-6 mr-2 ml-2\"\n\t\t\t\t\t\tfill=\"none\"\n\t\t\t\t\t\tviewBox=\"0 0 24 24\"\n\t\t\t\t\t\tstroke=\"currentColor\"\n\t\t\t\t\t\tstroke-width=\"2\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<path\n\t\t\t\t\t\t\tstroke-linecap=\"round\"\n\t\t\t\t\t\t\tstroke-linejoin=\"round\"\n\t\t\t\t\t\t\td=\"M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</svg>\n\t\t\t\t\t<span>{isLoggingIn ? 'Unlocking...' : loginButtonText}</span>\n\t\t\t\t</div>\n\t\t\t</button>\n\n\t\t\t<button\n\t\t\t\ttype=\"button\"\n\t\t\t\tonclick={props.onCancel}\n\t\t\t\tclass=\"bg-slate-400 hover:bg-slate-500 w-64 rounded-full py-2 px-4 mt-3 font-bold text-white\"\n\t\t\t>\n\t\t\t\t<div class=\"inline-flex items-center align-middle\">\n\t\t\t\t\t<svg\n\t\t\t\t\t\taria-hidden=\"true\"\n\t\t\t\t\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\t\t\t\t\tviewBox=\"0 0 20 20\"\n\t\t\t\t\t\tstroke=\"currentColor\"\n\t\t\t\t\t\tclass=\"w-6 h-6 mx-2\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<path\n\t\t\t\t\t\t\tfill-rule=\"evenodd\"\n\t\t\t\t\t\t\td=\"M3 4.25A2.25 2.25 0 015.25 2h5.5A2.25 2.25 0 0113 4.25v2a.75.75 0 01-1.5 0v-2a.75.75 0 00-.75-.75h-5.5a.75.75 0 00-.75.75v11.5c0 .414.336.75.75.75h5.5a.75.75 0 00.75-.75v-2a.75.75 0 011.5 0v2A2.25 2.25 0 0110.75 18h-5.5A2.25 2.25 0 013 15.75V4.25z\"\n\t\t\t\t\t\t\tclip-rule=\"evenodd\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<path\n\t\t\t\t\t\t\tfill-rule=\"evenodd\"\n\t\t\t\t\t\t\td=\"M19 10a.75.75 0 00-.75-.75H8.704l1.048-.943a.75.75 0 10-1.004-1.114l-2.5 2.25a.75.75 0 000 1.114l2.5 2.25a.75.75 0 101.004-1.114l-1.048-.943h9.546A.75.75 0 0019 10z\"\n\t\t\t\t\t\t\tclip-rule=\"evenodd\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</svg>\n\t\t\t\t\t<span>{cancelButtonText}</span>\n\t\t\t\t</div>\n\t\t\t</button>\n\t\t</div>\n\t</form>\n\n\t<!-- Loading state -->\n\t{#if isLoggingIn}\n\t\t<AuthLoading message=\"Authenticating...\" variant=\"spinner\" size=\"md\" className=\"mt-4\" />\n\t{/if}\n\n\t<!-- Error handling with retry -->\n\t<AuthError\n\t\terror={showError ? errorMessage : null}\n\t\tonRetry={retryCount < maxRetries && !isLoggingIn ? handleRetry : undefined}\n\t\tonDismiss={!isLoggingIn ? handleDismiss : undefined}\n\t/>\n</div>","<script lang=\"ts\">\n  import Login from '../lib/components/Login.svelte';\n  import { setSettingsStorage, syncStorageToStore, yakklUserNameStore } from '$lib/common/stores';\n  import { setIconUnlock } from '$lib/utilities/utilities';\n  import { safeLogout, safeNavigate } from '$lib/common/safeNavigate';\n  import { startActivityTracking } from '$lib/common/messaging';\n  import { log } from '$lib/common/logger-wrapper';\n  import type { Profile, Settings } from '$lib/common/interfaces';\n  import { getNormalizedSettings, PATH_WELCOME, PlanType } from '$lib/common';\n  import { setLocks } from '$lib/common/locks';\n  import Welcome from '$lib/components/Welcome.svelte';\n  import ErrorNoAction from '$lib/components/ErrorNoAction.svelte';\n  import { onMount } from 'svelte';\n  import { protectedContexts } from '$lib/common/globals';\n\n  // State\n  let showError = $state(false);\n  let errorValue = $state('');\n  let planType = $state(PlanType.BASIC_MEMBER);\n  let yakklSettings: Settings | null = $state(null);\n\n  // Format plan type for display (remove underscores and capitalize)\n  function formatPlanType(plan: string): string {\n    if (!plan) return '';\n    return plan\n      .replace(/_/g, ' ')\n      .split(' ')\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n      .join(' ');\n  }\n\n  onMount(async () => {\n    yakklSettings = await getNormalizedSettings();\n    await setSettingsStorage(yakklSettings);\n    planType = yakklSettings?.plan.type ?? PlanType.BASIC_MEMBER;\n  });\n\n  // Handle successful login\n  async function onSuccess(profile: Profile, digest: string, isMinimal: boolean) {\n    try {\n      // Set the username in the global store\n      $yakklUserNameStore = profile.userName || '';\n\n      // Full wallet initialization\n      setIconUnlock();\n      \n      // KEY: Sync all storage to stores - this loads all persistent data\n      await syncStorageToStore();\n\n      // Unlock the wallet using setLocks function - this updates both storage and stores\n      await setLocks(false, yakklSettings?.plan.type || PlanType.BASIC_MEMBER);\n\n      // Start activity tracking\n      const contextType = 'popup-wallet';\n      if (protectedContexts.includes(contextType)) {\n        log.info(`Starting activity tracking for protected context: ${contextType}`);\n        startActivityTracking(contextType);\n      }\n\n      // Small delay to ensure all stores are synchronized before redirect\n      await new Promise(resolve => setTimeout(resolve, 200));\n      \n      log.info('Preview2: All stores synchronized after login');\n      \n      // Mark session as authenticated for preview2\n      sessionStorage.setItem('preview2-authenticated', 'true');\n      \n      // Navigate to preview2 dashboard\n      safeNavigate('/preview2', 0, { replaceState: true, invalidateAll: true });\n    } catch (e: any) {\n      log.error('Error during post-login initialization', false, e);\n      errorValue = e;\n      showError = true;\n    }\n  }\n\n  // Handle login errors\n  function onError(value: string) {\n    errorValue = value;\n    showError = true;\n  }\n\n  // Handle login cancel\n  function onCancel() {\n    safeLogout();\n  }\n\n  // Handle close\n  function onClose() {\n    showError = false;\n    errorValue = '';\n  }\n</script>\n\n<ErrorNoAction bind:show={showError} title=\"ERROR!\" value={errorValue} {onClose} />\n\n<div class=\"min-h-screen flex items-center justify-center px-4\">\n  <div class=\"max-w-sm w-full\">\n    <div class=\"yakkl-card text-center p-6\">\n      <!-- Logo -->\n      <div class=\"mb-6\">\n        <img src=\"/images/logoBullFav128x128.png\" alt=\"YAKKL\" class=\"w-20 h-20 mx-auto\" />\n        <h1 class=\"text-2xl font-bold text-zinc-900 dark:text-white mt-4\">YAKKL Wallet</h1>\n        <p class=\"text-sm text-zinc-600 dark:text-zinc-400 mt-2\">Preview 2.0</p>\n      </div>\n\n      <!-- Login Form -->\n      <Login\n        {onSuccess}\n        {onError}\n        {onCancel}\n        loginButtonText=\"Unlock Wallet\"\n        cancelButtonText=\"Exit\"\n        inputTextClass=\"text-zinc-900 dark:text-white\"\n        inputBgClass=\"bg-white dark:bg-zinc-800\"\n      />\n\n      <!-- Plan Info -->\n      <div class=\"mt-8 p-4 bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900 dark:to-purple-900 rounded-xl\">\n        {#if planType.toLowerCase() === PlanType.YAKKL_PRO.toLowerCase()}\n          <h3 class=\"font-semibold text-indigo-900 dark:text-indigo-100\">{formatPlanType(PlanType.YAKKL_PRO)}</h3>\n          <p class=\"text-sm text-indigo-700 dark:text-indigo-200 mt-1\">\n            Access to all premium features and advanced tools\n          </p>\n        {:else if planType.toLowerCase() === PlanType.FOUNDING_MEMBER.toLowerCase()}\n          <h3 class=\"font-semibold text-purple-900 dark:text-purple-100\">{formatPlanType(PlanType.FOUNDING_MEMBER)}</h3>\n          <p class=\"text-sm text-purple-700 dark:text-purple-200 mt-1\">\n            Exclusive access to all features and early releases\n          </p>\n        {:else if planType.toLowerCase() === PlanType.EARLY_ADOPTER.toLowerCase()}\n          <h3 class=\"font-semibold text-blue-900 dark:text-blue-100\">{formatPlanType(PlanType.EARLY_ADOPTER)}</h3>\n          <p class=\"text-sm text-blue-700 dark:text-blue-200 mt-1\">\n            Enhanced features and priority support\n          </p>\n        {:else}\n          <h3 class=\"font-semibold text-zinc-900 dark:text-zinc-100\">{formatPlanType(planType)}</h3>\n          <p class=\"text-sm text-zinc-700 dark:text-zinc-300 mt-1\">\n            Core wallet features with option to upgrade\n          </p>\n        {/if}\n      </div>\n\n    </div>\n  </div>\n</div>\n"],"file":"app/immutable/nodes/74.5EggOzCU.js"}