{"version":3,"file":"18.DJRgXaWK.js","sources":["../../../../../../src/routes/(dapp)/dapp/login/+page.svelte"],"sourcesContent":["<script lang=\"ts\">\n\timport { page } from '$app/state';\n\timport { browserSvelte } from '$lib/common/environment';\n\timport Login from '$lib/components/Login.svelte';\n\timport {\n\t\tsyncStorageToStore,\n\t\tyakklDappConnectRequestStore,\n\t\tyakklUserNameStore\n\t} from '$lib/common/stores';\n\timport { safeLogout, safeNavigate } from '$lib/common/safeNavigate';\n\timport { messagingService, startActivityTracking } from '$lib/common/messaging';\n\timport { log } from '$lib/common/logger-wrapper';\n\timport type { Profile } from '$lib/common/interfaces';\n\timport ErrorNoAction from '$lib/components/ErrorNoAction.svelte';\n\timport Welcome from '$lib/components/Welcome.svelte';\n\timport { protectedContexts } from '$lib/common/globals';\n\n\t// Get request parameters\n\tlet requestId = $state('');\n\tlet method = $state('');\n\tlet showError = $state(false);\n\tlet errorValue = $state('');\n\tlet approvalUrl = '';\n\n\tfunction getApprovalUrl() {\n\t\tif (!method) return '/dapp/popups/approve/';\n\t\tswitch (method) {\n\t\t\tcase 'eth_requestAccounts':\n\t\t\t\treturn '/dapp/popups/accounts/';\n\t\t\tcase 'eth_sendTransaction':\n\t\t\t\treturn '/dapp/popups/transactions/';\n\t\t\tcase 'eth_signTypedData_v4':\n\t\t\tcase 'personal_sign':\n\t\t\tcase 'eth_signTransaction':\n\t\t\t\treturn '/dapp/popups/sign/';\n\t\t\tcase 'wallet_requestPermissions':\n\t\t\tcase 'wallet_revokePermissions':\n\t\t\tcase 'wallet_getPermissions':\n\t\t\t\treturn '/dapp/popups/permissions/';\n\t\t\tcase 'wallet_switchEthereumChain':\n\t\t\t\treturn '/dapp/popups/wallet/';\n\t\t\tdefault:\n\t\t\t\treturn '/dapp/popups/approve/';\n\t\t}\n\t}\n\n\tfunction initializeFromUrl() {\n\t\tif (!browserSvelte) return;\n\n\t\tconst urlRequestId = (page.url.searchParams.get('requestId') as string) ?? '';\n\t\trequestId = urlRequestId;\n\t\tmethod = (page.url.searchParams.get('method') as string) ?? '';\n\n\t\tapprovalUrl = getApprovalUrl();\n\n\t\tconsole.log('approvalUrl', approvalUrl);\n\t\tconsole.log('requestId', requestId);\n\t\tconsole.log('method', method);\n\t}\n\n\tinitializeFromUrl();\n\n\t// Determine which approval page to go to based on method\n\t// Handle successful login in dapp context\n\tfunction onSuccess(profile: Profile, digest: string, isMinimal: boolean) {\n\t\ttry {\n\t\t\tif (!browserSvelte) return;\n\t\t\t// Set the username in the global store\n\t\t\t$yakklUserNameStore = profile.userName || '';\n\t\t\t// Set the global request ID\n\t\t\t$yakklDappConnectRequestStore = requestId;\n\t\t\t// For dapp context, we just need the minimal sync\n\t\t\tsyncStorageToStore();\n\n\t\t\t// Tell the background script about successful auth\n\t\t\tconst contextType = 'popup-dapp'; // This is explicitly the dapp context\n\t\t\tif (protectedContexts.includes(contextType)) {\n\t\t\t\tlog.info(`Starting activity tracking for protected context: ${contextType}`);\n\t\t\t\tstartActivityTracking(contextType);\n\t\t\t} else {\n\t\t\t\tlog.info(`Skipping activity tracking for non-protected context: ${contextType}`);\n\t\t\t}\n\n\t\t\t// Navigate to the appropriate approval screen with parameters\n\t\t\tconst url = `${approvalUrl}?requestId=${requestId}&method=${method}`;\n\t\t\tsafeNavigate(url);\n\t\t} catch (e: any) {\n\t\t\tlog.error('Error during post-login initialization', false, e);\n\t\t\terrorValue = e;\n\t\t\tshowError = true;\n\n\t\t\t// Reject the request on error\n\t\t\tmessagingService.sendMessage('rejectRequest', {\n\t\t\t\trequestId,\n\t\t\t\terror: 'Authentication failed'\n\t\t\t});\n\t\t}\n\t}\n\n\t// Handle login errors\n\tfunction onError(value: string) {\n\t\tif (!browserSvelte) return;\n\n\t\terrorValue = value;\n\t\tshowError = true;\n\n\t\t// Reject the request if login fails\n\t\tmessagingService.sendMessage('rejectRequest', {\n\t\t\trequestId,\n\t\t\terror: 'Authentication failed'\n\t\t});\n\t}\n\n\t// Handle login cancel\n\tfunction onCancel() {\n\t\tif (!browserSvelte) return;\n\t\tsafeLogout();\n\t}\n\n\t// Handle close\n\tfunction onClose() {\n\t\tif (!browserSvelte) return;\n\t\tshowError = false;\n\t\terrorValue = '';\n\t}\n</script>\n\n<ErrorNoAction bind:show={showError} title=\"ERROR!\" value={errorValue} {onClose} />\n\n<!-- relative bg-gradient-to-b from-indigo-700 to-indigo-500/15 m-1 ml-2 mr-2 dark:bg-gray-900 rounded-t-xl overflow-hidden -->\n<div class=\"relative h-[98vh] text-base-content\">\n\t<main class=\"px-4 text-center\">\n\t\t<Welcome />\n\n\t\t<div class=\"mt-5\">\n\t\t\t<Login\n\t\t\t\tminimumAuth={true}\n\t\t\t\t{requestId}\n\t\t\t\t{method}\n\t\t\t\t{onSuccess}\n\t\t\t\t{onError}\n\t\t\t\t{onCancel}\n\t\t\t\tloginButtonText=\"Unlock\"\n\t\t\t\tcancelButtonText=\"Exit/Logout\"\n\t\t\t/>\n\t\t</div>\n\t</main>\n</div>\n"],"names":["requestId","$.tag","$.state","method","showError","errorValue","approvalUrl","getApprovalUrl","$.get","initializeFromUrl","browserSvelte","urlRequestId","page","url","searchParams","get","set","console","log","$.log_if_contains_state","onSuccess","profile","digest","isMinimal","store_set","yakklUserNameStore","userName","yakklDappConnectRequestStore","syncStorageToStore","contextType","protectedContexts","includes","info","startActivityTracking","safeNavigate","e","error","messagingService","sendMessage","onError","value","onCancel","safeLogout","onClose","$$value"],"mappings":"q6CAkBK,IAAAA,UAAAC,IAAAC,MAAmB,IAAE,aACrB,IAAAC,OAAAF,IAAAC,MAAgB,IAAE,UAClB,IAAAE,UAAAH,IAAAC,MAAmB,OAAK,aACxB,IAAAG,WAAAJ,IAAAC,MAAoB,IAAE,kBACtBI,YAAc,YAETC,yBACHJ,QAAe,MAAA,wBACZK,OAAAA,IAAAL,SACF,IAAA,sBACG,MAAA,yBACH,IAAA,sBACG,MAAA,6BACH,IAAA,uBACA,IAAA,gBACA,IAAA,sBACG,MAAA,qBACH,IAAA,4BACA,IAAA,2BACA,IAAA,wBACG,MAAA,4BACH,IAAA,6BACG,MAAA,+BAEA,MAAA,wBAEV,UAESM,oBACH,IAAAC,cAAA,OAEC,MAAAC,aAAgBC,KAAKC,IAAIC,aAAaC,IAAI,cAA2B,GAC3EC,IAAAhB,UAAYW,aAAA,MACZK,IAAAb,OAAUS,KAAKC,IAAIC,aAAaC,IAAI,WAAwB,GAAA,MAE5DT,YAAcC,iBAEdU,QAAQC,OAAAC,sBAAA,MAAI,cAAeb,cACnBW,QAAAC,OAAAC,sBAAA,MAAI,gBAAanB,aACjBiB,QAAAC,OAAAC,sBAAA,MAAI,aAAUhB,SACvB,CAEAM,oBAIS,SAAAW,UAAUC,QAAkBC,OAAgBC,WAChD,IACE,IAAAb,cAAA,OAEiBc,UAAAC,mBAAAJ,QAAQK,UAAY,IAEVF,UAAAG,6BAAAnB,IAAAR,YAEhC4B,2BAGMC,YAAc,aAChB,GAAAC,kBAAkBC,SAASF,aAAc,CACxCX,IAAAc,0DAA0DH,eAC9DI,sBAAsBJ,iBAChB,CACFX,IAAAc,8DAA8DH,cACnE,CAGM,MAAAhB,IAAA,GAASP,yBAAWE,IAAcR,qBAASQ,IAAWL,UAC5D+B,aAAarB,IACd,OAASsB,GACJjB,IAAAkB,MAAM,yCAA0C,MAAOD,GAC3DnB,IAAAX,WAAa8B,EAAA,UACb/B,UAAY,MAGZiC,iBAAiBC,YAAY,gBAAA,CAC5BtC,UAAAQ,IAAAR,WACAoC,MAAO,yBAET,CACD,CAGS,SAAAG,QAAQC,OACX,IAAA9B,cAAA,OAELM,IAAAX,WAAamC,MAAA,UACbpC,UAAY,MAGZiC,iBAAiBC,YAAY,gBAAA,CAC5BtC,UAAAQ,IAAAR,WACAoC,MAAO,yBAET,UAGSK,WACH,IAAA/B,cAAA,OACLgC,YACD,UAGSC,UACH,IAAAjC,cAAA,WACLN,UAAY,WACZC,WAAa,GACd,8GAG0DA,mDAAjCD,8BAAAY,IAAAZ,UAASwC,QAAA,6KASlB"}