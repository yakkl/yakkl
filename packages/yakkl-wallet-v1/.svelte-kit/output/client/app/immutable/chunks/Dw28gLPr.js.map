{"version":3,"file":"Dw28gLPr.js","sources":["../../../../../../src/lib/utilities/gas.ts"],"sourcesContent":["// main.ts\nimport { get } from 'svelte/store';\nimport { yakklGasTransStore, yakklConnectionStore } from '$lib/common/stores';\nimport type {\n\tGasFeeTrend,\n\tBlocknativeResponse,\n\tGasTransStore,\n\tEstimatedPrice\n} from '$lib/common/interfaces';\nimport { getTimerManager } from '$lib/managers/TimerManager';\nimport { log } from '$lib/managers/Logger';\nimport { TIMER_CHECK_GAS_PRICE_INTERVAL_TIME, TIMER_GAS_PRICE_CHECK } from '$lib/common';\nimport { UnifiedTimerManager } from '$lib/managers/UnifiedTimerManager';\n\nconst now = () => +Date.now() / 1000;\n\nlet providerGasCB: string | null = null;\nconst gasFeeTrend: GasFeeTrend[] = [];\n\nasync function checkGasPricesCB() {\n\ttry {\n\t\tif (getTimerManager().isRunning(TIMER_GAS_PRICE_CHECK)) {\n\t\t\tif (get(yakklConnectionStore) === true) {\n\t\t\t\tconst results = await fetchBlocknativeData();\n\t\t\t\t// log.debug('gas.ts - checkGasPricesCB', false, results);\n\t\t\t\tyakklGasTransStore.set({\n\t\t\t\t\tprovider: providerGasCB,\n\t\t\t\t\tid: getTimerManager().getTimeoutID(TIMER_GAS_PRICE_CHECK),\n\t\t\t\t\tresults\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t} catch (error) {\n\t\tlog.error(error);\n\t}\n}\n\nfunction setGasCBProvider(provider: string | null) {\n\tproviderGasCB = provider;\n}\n\nexport function stopCheckGasPrices() {\n\ttry {\n\t\tgetTimerManager().stopTimer(TIMER_GAS_PRICE_CHECK);\n\t\tsetGasCBProvider(null);\n\t} catch (error) {\n\t\tlog.error(error);\n\t}\n}\n\nexport function startCheckGasPrices(\n\tprovider = 'blocknative',\n\tms = TIMER_CHECK_GAS_PRICE_INTERVAL_TIME\n) {\n\ttry {\n\t\tif (ms > 0) {\n\t\t\tif (getTimerManager().isRunning(TIMER_GAS_PRICE_CHECK)) {\n\t\t\t\treturn; // Already running\n\t\t\t}\n\n\t\t\tsetGasCBProvider(provider);\n\t\t\tif (!getTimerManager().isRunning(TIMER_GAS_PRICE_CHECK)) {\n\t\t\t\tgetTimerManager().addTimer(TIMER_GAS_PRICE_CHECK, checkGasPricesCB, ms);\n\t\t\t\tgetTimerManager().startTimer(TIMER_GAS_PRICE_CHECK);\n\t\t\t}\n\t\t}\n\t} catch (error) {\n\t\tlog.error(error);\n\t\tgetTimerManager().stopTimer(TIMER_GAS_PRICE_CHECK);\n\t}\n}\n\nconst memoizeAsync = <T>(fn: () => Promise<T>): (() => Promise<T>) => {\n\tconst CACHE_DURATION = 10;\n\tlet lastRunTs = 0;\n\tlet cache: T;\n\n\treturn async () => {\n\t\tconst isCacheExpired = now() - lastRunTs > CACHE_DURATION;\n\n\t\tif (isCacheExpired) {\n\t\t\tlastRunTs = now();\n\t\t\tcache = await fn();\n\t\t}\n\n\t\treturn cache;\n\t};\n};\n\nconst debounce = <T>(fn: () => Promise<T>): (() => Promise<T>) => {\n\tconst debouncedFn = UnifiedTimerManager.createDebounce(async () => {\n\t\treturn fn();\n\t}, 500);\n\n\treturn () =>\n\t\tnew Promise((resolve, reject) => {\n\t\t\ttry {\n\t\t\t\t// createDebounce returns a function that doesn't return a promise\n\t\t\t\t// We need to handle the async callback differently\n\t\t\t\tconst asyncWrapper = async () => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst result = await fn();\n\t\t\t\t\t\tresolve(result);\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\t// Cancel any existing debounced call and set up new one\n\t\t\t\tdebouncedFn.cancel();\n\t\t\t\tconst newDebouncedFn = UnifiedTimerManager.createDebounce(asyncWrapper, 500);\n\t\t\t\tnewDebouncedFn();\n\t\t\t} catch (error) {\n\t\t\t\treject(error);\n\t\t\t}\n\t\t});\n};\n\nconst getBlocknativeData = memoizeAsync<BlocknativeResponse>(async () =>\n\t(await fetch(import.meta.env.VITE_GAS_BLOCKNATIVE_ENDPOINT)).json()\n);\n\nconst getEtherscanData = memoizeAsync(async () =>\n\t(await fetch(import.meta.env.VITE_GAS_ETHERSCAN_ENDPOINT)).json()\n);\n\nconst getEGSData = memoizeAsync(async () =>\n\t(await fetch(import.meta.env.VITE_GAS_ETHGASSTATION_ENDPOINT)).json()\n);\n\nexport { debounce, getBlocknativeData, getEtherscanData, getEGSData };\n\nexport const fetchBlocknativeData = debounce(async () => {\n\ttry {\n\t\tconst response = await getBlocknativeData();\n\t\tif (response?.blockPrices) {\n\t\t\tconst blockPrices = response.blockPrices[0];\n\t\t\tconst estimatedPrices: EstimatedPrice[] = blockPrices.estimatedPrices;\n\n\t\t\tconst fastest = estimatedPrices.find((price: EstimatedPrice) => price.confidence === 99)!;\n\t\t\tconst faster = estimatedPrices.find((price: EstimatedPrice) => price.confidence === 95)!;\n\t\t\tconst fast = estimatedPrices.find((price: EstimatedPrice) => price.confidence === 90)!;\n\t\t\tconst standard = estimatedPrices.find((price: EstimatedPrice) => price.confidence === 80)!;\n\t\t\tconst slow = estimatedPrices.find((price: EstimatedPrice) => price.confidence === 70)!;\n\n\t\t\tif (gasFeeTrend.length > 4) {\n\t\t\t\tgasFeeTrend.shift();\n\t\t\t}\n\t\t\tgasFeeTrend.push({\n\t\t\t\tblocknumber: blockPrices.blockNumber,\n\t\t\t\tbaseFeePerGas: blockPrices.baseFeePerGas,\n\t\t\t\tmaxPriorityFeePerGas: fastest.maxPriorityFeePerGas,\n\t\t\t\tmaxFeePerGas: fastest.maxFeePerGas,\n\t\t\t\ttimestamp: now()\n\t\t\t});\n\n\t\t\tconst sum = gasFeeTrend.reduce(\n\t\t\t\t(accumulator, currentValue) => accumulator + currentValue.baseFeePerGas,\n\t\t\t\t0\n\t\t\t);\n\t\t\tconst avg = sum / gasFeeTrend.length;\n\n\t\t\tconst results: GasTransStore['results'] = {\n\t\t\t\tblockNumber: blockPrices.blockNumber,\n\t\t\t\testimatedTransactionCount: blockPrices.estimatedTransactionCount,\n\t\t\t\tgasProvider: 'blocknative',\n\t\t\t\tactual: {\n\t\t\t\t\tbaseFeePerGas: blockPrices.baseFeePerGas,\n\t\t\t\t\tfastest: {\n\t\t\t\t\t\tmaxPriorityFeePerGas: fastest.maxPriorityFeePerGas,\n\t\t\t\t\t\tmaxFeePerGas: fastest.maxFeePerGas\n\t\t\t\t\t},\n\t\t\t\t\tfaster: {\n\t\t\t\t\t\tmaxPriorityFeePerGas: faster.maxPriorityFeePerGas,\n\t\t\t\t\t\tmaxFeePerGas: faster.maxFeePerGas\n\t\t\t\t\t},\n\t\t\t\t\tfast: {\n\t\t\t\t\t\tmaxPriorityFeePerGas: fast.maxPriorityFeePerGas,\n\t\t\t\t\t\tmaxFeePerGas: fast.maxFeePerGas\n\t\t\t\t\t},\n\t\t\t\t\tstandard: {\n\t\t\t\t\t\tmaxPriorityFeePerGas: standard.maxPriorityFeePerGas,\n\t\t\t\t\t\tmaxFeePerGas: standard.maxFeePerGas\n\t\t\t\t\t},\n\t\t\t\t\tslow: { maxPriorityFeePerGas: slow.maxPriorityFeePerGas, maxFeePerGas: slow.maxFeePerGas }\n\t\t\t\t},\n\t\t\t\tgasFeeTrend: {\n\t\t\t\t\tbaseFeePerGasAvg: avg,\n\t\t\t\t\tmostRecentFees: gasFeeTrend\n\t\t\t\t}\n\t\t\t};\n\n\t\t\treturn results;\n\t\t} else {\n\t\t\treturn {} as GasTransStore['results'];\n\t\t}\n\t} catch (error) {\n\t\tlog.error(error);\n\t\treturn {} as GasTransStore['results'];\n\t}\n});\n\nexport const fetchEtherscanData = debounce(async () => {\n\ttry {\n\t\tconst {\n\t\t\tresult: { SafeGasPrice, ProposeGasPrice, FastGasPrice }\n\t\t} = await getEtherscanData();\n\n\t\treturn [parseInt(FastGasPrice, 10), parseInt(ProposeGasPrice, 10), parseInt(SafeGasPrice, 10)];\n\t} catch (error) {\n\t\tlog.error(error);\n\t\treturn [0, 0, 0];\n\t}\n});\n\nexport const fetchEGSData = debounce(async () => {\n\ttry {\n\t\tconst { fast, safeLow, average } = await getEGSData();\n\n\t\treturn [fast / 10, average / 10, safeLow / 10];\n\t} catch (error) {\n\t\tlog.error(error);\n\t\treturn [0, 0, 0];\n\t}\n});\n"],"names":["now","Date","providerGasCB","gasFeeTrend","async","checkGasPricesCB","getTimerManager","isRunning","TIMER_GAS_PRICE_CHECK","get","yakklConnectionStore","results","fetchBlocknativeData","yakklGasTransStore","set","provider","id","getTimeoutID","error","log","setGasCBProvider","stopCheckGasPrices","stopTimer","startCheckGasPrices","ms","TIMER_CHECK_GAS_PRICE_INTERVAL_TIME","addTimer","startTimer","memoizeAsync","fn","CACHE_DURATION","lastRunTs","cache","isCacheExpired","debounce","debouncedFn","UnifiedTimerManager","createDebounce","Promise","resolve","reject","asyncWrapper","result","cancel","newDebouncedFn","getBlocknativeData","fetch","json","getEtherscanData","getEGSData","response","blockPrices","estimatedPrices","fastest","find","price","confidence","faster","fast","standard","slow","length","shift","push","blocknumber","blockNumber","baseFeePerGas","maxPriorityFeePerGas","maxFeePerGas","timestamp","sum","reduce","accumulator","currentValue","avg","estimatedTransactionCount","gasProvider","actual","baseFeePerGasAvg","mostRecentFees","SafeGasPrice","ProposeGasPrice","FastGasPrice","parseInt","safeLow","average"],"mappings":"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"}