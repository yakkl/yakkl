const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./Cb2naUpm.js","./WDN37msH.js","./CgCfpVku.js","./B2gA1VsD.js","./BaS8d5lg.js","./BOosul_h.js"])))=>i.map(i=>d[i]);
import{E as getContextTypeStore,_ as __vitePreload,l as log}from"./Cb2naUpm.js";import{c as check_target,l as legacy_api}from"./BXFaAXnq.js";import{p as push,h as tag,aC as tag_proxy,ae as proxy,ay as user_effect,s as sibling,t as template_effect,a as pop,u as user_derived,i as state,e as set,a7 as untrack,g as get,ak as update,b as strict_equals,c as child,F as FILENAME,j as next,r as reset}from"./BaS8d5lg.js";import{a as add_locations}from"./3AhEABF_.js";import{s as set_text}from"./Cmwrv3PW.js";import{i as if_block}from"./Q1yPWpQ-.js";import{a as append,f as from_html}from"./Cm3jf07C.js";import{v as validate_store}from"./Dv9a3G0k.js";import{r as remove_input_defaults}from"./DTBsVM-c.js";import{s as set_class}from"./DX_EEhpR.js";import{d as delegate,b as apply,e as event}from"./DiU70Is3.js";import{b as bind_value}from"./B6q982nR.js";import{a as store_get,s as setup_stores,d as store_mutate}from"./CViNpZsE.js";import{c as createForm}from"./CEKklR__.js";import"./Doq7snb5.js";import{v as verify}from"./z_jpiecc.js";import{a as authStore,j as jwtManager,s as sessionManager}from"./DmxAnVWO.js";import{A as AuthError,a as AuthLoading}from"./CN9x-apg.js";Login[FILENAME]="src/lib/components/Login.svelte";var root=add_locations(from_html(`<div class="login-container"><form><div class="mt-5 flex flex-row justify-center"><div class="form-control w-[22rem]"><div class="join"><input id="userName" type="text" placeholder="Username" autocomplete="off" required/> <span class="label-text bg-slate-900 join-item w-[60px]"><div class="mt-[.9rem]">.nfs.id</div></span></div></div></div> <div class="mt-5 flex flex-row justify-center"><div class="form-control w-[22rem]"><input id="password" type="password" placeholder="Password" autocomplete="off" required/>  <svg id="pweye-closed" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 ml-1 fill-gray-200 absolute right-12 z-10 mt-5 cursor-pointer"><path d="M3.53 2.47a.75.75 0 00-1.06 1.06l18 18a.75.75 0 101.06-1.06l-18-18zM22.676 12.553a11.249 11.249 0 01-2.631 4.31l-3.099-3.099a5.25 5.25 0 00-6.71-6.71L7.759 4.577a11.217 11.217 0 014.242-.827c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113z"></path><path d="M15.75 12c0 .18-.013.357-.037.53l-4.244-4.243A3.75 3.75 0 0115.75 12zM12.53 15.713l-4.243-4.244a3.75 3.75 0 004.243 4.243z"></path><path d="M6.75 12c0-.619.107-1.213.304-1.764l-3.1-3.1a11.25 11.25 0 00-2.63 4.31c-.12.362-.12.752 0 1.114 1.489 4.467 5.704 7.69 10.675 7.69 1.5 0 2.933-.294 4.242-.827l-2.477-2.477A5.25 5.25 0 016.75 12z"></path></svg>  <svg id="pweye-open" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 ml-1 fill-gray-200 absolute right-12 z-10 mt-5 cursor-pointer"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"></path><path fill-rule="evenodd" d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 010-1.113zM17.25 12a5.25 5.25 0 11-10.5 0 5.25 5.25 0 0110.5 0z" clip-rule="evenodd"></path></svg></div></div> <div class="inline-block text-center"><button type="submit" class="bg-emerald-400 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-full mt-3 w-64"><div class="inline-flex items-center align-middle"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg> <span> </span></div></button> <button type="button" class="bg-slate-400 hover:bg-slate-500 w-64 rounded-full py-2 px-4 mt-3 font-bold text-white"><div class="inline-flex items-center align-middle"><svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" stroke="currentColor" class="w-6 h-6 mx-2"><path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 015.25 2h5.5A2.25 2.25 0 0113 4.25v2a.75.75 0 01-1.5 0v-2a.75.75 0 00-.75-.75h-5.5a.75.75 0 00-.75.75v11.5c0 .414.336.75.75.75h5.5a.75.75 0 00.75-.75v-2a.75.75 0 011.5 0v2A2.25 2.25 0 0110.75 18h-5.5A2.25 2.25 0 013 15.75V4.25z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M19 10a.75.75 0 00-.75-.75H8.704l1.048-.943a.75.75 0 10-1.004-1.114l-2.5 2.25a.75.75 0 000 1.114l2.5 2.25a.75.75 0 101.004-1.114l-1.048-.943h9.546A.75.75 0 0019 10z" clip-rule="evenodd"></path></svg> <span> </span></div></button></div></form> <!> <!></div>`),Login[FILENAME],[[152,0,[[153,1,[[159,2,[[160,3,[[161,4,[[162,5],[171,5,[[172,6]]]]]]]]],[178,2,[[179,3,[[180,4],[193,4,[[201,5],[204,5],[207,5]]],[214,4,[[222,5],[223,5]]]]]]],[232,2,[[233,3,[[238,4,[[239,5,[[247,6]]],[253,5]]]]],[257,3,[[262,4,[[263,5,[[270,6],[275,6]]],[281,5]]]]]]]]]]]]);function Login($$anchor,$$props){check_target(new.target);push($$props,true,Login);const[$$stores,$$cleanup]=setup_stores();const $form=()=>(validate_store(form,"form"),store_get(form,"$form",$$stores));const loginButtonText=tag(user_derived(()=>$$props.loginButtonText??"Unlock"),"loginButtonText");const cancelButtonText=tag(user_derived(()=>$$props.cancelButtonText??"Exit/Logout"),"cancelButtonText");const inputTextClass=tag(user_derived(()=>$$props.inputTextClass??"text-base-content"),"inputTextClass");const inputBgClass=tag(user_derived(()=>$$props.inputBgClass??""),"inputBgClass");const contextType=tag_proxy(proxy(getContextTypeStore()),"contextType");const isDappContext=tag(user_derived(()=>{var _a;return strict_equals(contextType,"popup-dapp")||(((_a=contextType==null?void 0:contextType.includes)==null?void 0:_a.call(contextType,"dapp"))??false)}),"isDappContext");const minimumAuth=tag(user_derived(()=>strict_equals($$props.minimumAuth,void 0,false)?$$props.minimumAuth:get(isDappContext)),"minimumAuth");let showError=tag(state(false),"showError");let errorMessage=tag(state(""),"errorMessage");let pweyeOpen=tag(state(false),"pweyeOpen");let isLoggingIn=tag(state(false),"isLoggingIn");let retryCount=tag(state(0),"retryCount");const maxRetries=3;const{form:form,handleSubmit:handleSubmit}=createForm({initialValues:{userName:"",password:""},onSubmit:async data=>{set(isLoggingIn,true);try{await verifyUser(data.userName,data.password)}finally{store_mutate(form,untrack($form).userName="",untrack($form));store_mutate(form,untrack($form).password="",untrack($form));set(isLoggingIn,false)}}});async function verifyUser(userName,password){var _a;try{let jwtToken;if($$props.useAuthStore){const profile2=await authStore.login(userName,password);const digest2=await __vitePreload(()=>import("./Cb2naUpm.js").then(n=>n.dg),true?__vite__mapDeps([0,1,2,3,4,5]):void 0,import.meta.url).then(module=>module.getMiscStore());if(!digest2){throw"Authentication succeeded but failed to retrieve security digest"}jwtToken=authStore.getCurrentJWTToken()||void 0;$$props.onSuccess(profile2,digest2,get(minimumAuth),jwtToken);return}const normalizedUsername=userName.toLowerCase().trim().replace(".nfs.id","");const loginString=normalizedUsername+".nfs.id"+password;const profile=await verify(loginString);if(!profile){throw"Invalid credentials or profile not found"}const digest=await __vitePreload(()=>import("./Cb2naUpm.js").then(n=>n.dg),true?__vite__mapDeps([0,1,2,3,4,5]):void 0,import.meta.url).then(module=>module.getMiscStore());if(!digest){throw"Authentication succeeded but failed to retrieve security digest"}if($$props.generateJWT){try{const{getSettings:getSettings}=await __vitePreload(async()=>{const{getSettings:getSettings2}=await import("./Cb2naUpm.js").then(n=>n.dg);return{getSettings:getSettings2}},true?__vite__mapDeps([0,1,2,3,4,5]):void 0,import.meta.url);const settings=await getSettings();const planLevel=((_a=settings==null?void 0:settings.plan)==null?void 0:_a.type)||"basic";jwtToken=await jwtManager.generateToken(profile.id||profile.userName,profile.userName,profile.id||profile.userName,planLevel);if(!$$props.useAuthStore){await sessionManager.startSession(profile.id||profile.userName,profile.userName,profile.id||profile.userName,planLevel)}log.debug("JWT token generated for login",false,{username:normalizedUsername,hasToken:!!jwtToken})}catch(jwtError){log.warn("Failed to generate JWT token:",false,jwtError)}}$$props.onSuccess(profile,digest,get(minimumAuth),jwtToken)}catch(e){update(retryCount);if(strict_equals(typeof e,"string")){set(errorMessage,e,true)}else if(e instanceof Error){set(errorMessage,e.message,true)}else{set(errorMessage,"Authentication failed")}if(get(retryCount)<maxRetries){set(errorMessage,get(errorMessage)+` (Attempt ${get(retryCount)}/${maxRetries})`)}else{set(errorMessage,get(errorMessage)+" - Maximum retry attempts reached.")}set(showError,true);log.error("Login verification failed",false,{error:e,retryCount:get(retryCount),maxRetries:maxRetries});$$props.onError(e)}}function togglePasswordVisibility(){if(!document)return;const pwField=document.getElementById("password");const pwEyeOpen=document.getElementById("pweye-open");const pwEyeClosed=document.getElementById("pweye-closed");if(!pwField||!pwEyeOpen||!pwEyeClosed)return;if(strict_equals(pwField.type,"password")){pwField.type="text";pwEyeOpen.removeAttribute("hidden");pwEyeClosed.setAttribute("hidden","hidden");set(pweyeOpen,true)}else{pwField.type="password";pwEyeOpen.setAttribute("hidden","hidden");pwEyeClosed.removeAttribute("hidden");set(pweyeOpen,false)}}async function handleRetry(){if(get(retryCount)<maxRetries){set(showError,false);set(errorMessage,"");await verifyUser($form().userName,$form().password)}}function handleDismiss(){set(showError,false);set(errorMessage,"");set(retryCount,0)}user_effect(()=>{if(!document)return;const pwEyeOpen=document.getElementById("pweye-open");const pwEyeClosed=document.getElementById("pweye-closed");if(pwEyeOpen&&pwEyeClosed){pwEyeOpen.setAttribute("tabindex","-1");pwEyeClosed.setAttribute("tabindex","-1");pwEyeOpen.setAttribute("hidden","hidden")}});var div=root();var form_1=child(div);var div_1=child(form_1);var div_2=child(div_1);var div_3=child(div_2);var input=child(div_3);remove_input_defaults(input);next(2);reset(div_3);reset(div_2);reset(div_1);var div_4=sibling(div_1,2);var div_5=child(div_4);var input_1=child(div_5);remove_input_defaults(input_1);var svg=sibling(input_1,2);svg.__click=togglePasswordVisibility;var svg_1=sibling(svg,2);svg_1.__click=togglePasswordVisibility;reset(div_5);reset(div_4);var div_6=sibling(div_4,2);var button=child(div_6);var div_7=child(button);var span=sibling(child(div_7),2);var text=child(span,true);reset(span);reset(div_7);reset(button);var button_1=sibling(button,2);button_1.__click=function(...$$args){apply(()=>$$props.onCancel,this,$$args,Login,[259,13])};var div_8=child(button_1);var span_1=sibling(child(div_8),2);var text_1=child(span_1,true);reset(span_1);reset(div_8);reset(button_1);reset(div_6);reset(form_1);var node=sibling(form_1,2);{var consequent=$$anchor2=>{AuthLoading($$anchor2,{message:"Authenticating...",variant:"spinner",size:"md",className:"mt-4"})};if_block(node,$$render=>{if(get(isLoggingIn))$$render(consequent)})}var node_1=sibling(node,2);const expression=user_derived(()=>get(showError)?get(errorMessage):null);const expression_1=user_derived(()=>get(retryCount)<maxRetries&&!get(isLoggingIn)?handleRetry:void 0);const expression_2=user_derived(()=>!get(isLoggingIn)?handleDismiss:void 0);AuthError(node_1,{get error(){return get(expression)},get onRetry(){return get(expression_1)},get onDismiss(){return get(expression_2)}});reset(div);template_effect(()=>{set_class(input,1,`input input-bordered input-primary w-full join-item ${get(inputTextClass)??""} ${get(inputBgClass)??""}`);set_class(input_1,1,`input input-bordered input-primary w-full mt-2 ${get(inputTextClass)??""} ${get(inputBgClass)??""}`);button.disabled=get(isLoggingIn);set_text(text,get(isLoggingIn)?"Unlocking...":get(loginButtonText));set_text(text_1,get(cancelButtonText))});event("submit",form_1,e=>{e.preventDefault();handleSubmit(e)});bind_value(input,()=>$form().userName,$$value=>store_mutate(form,untrack($form).userName=$$value,untrack($form)));bind_value(input_1,()=>$form().password,$$value=>store_mutate(form,untrack($form).password=$$value,untrack($form)));append($$anchor,div);var $$pop=pop({...legacy_api()});$$cleanup();return $$pop}delegate(["click"]);export{Login as L};
//# sourceMappingURL=BjtG3ltR.js.map
