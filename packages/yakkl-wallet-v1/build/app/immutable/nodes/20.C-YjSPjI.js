import{c as check_target,l as legacy_api}from"../chunks/BXFaAXnq.js";import{p as push,h as tag,i as state,ae as proxy,e as set,o as onMount,f as first_child,s as sibling,t as template_effect,a as pop,g as get,c as child,F as FILENAME,$ as $document,r as reset,b as strict_equals,j as next}from"../chunks/BaS8d5lg.js";import{a as add_locations}from"../chunks/3AhEABF_.js";import{s as set_text}from"../chunks/Cmwrv3PW.js";import{i as if_block}from"../chunks/Q1yPWpQ-.js";import{a as append,f as from_html,t as text}from"../chunks/Cm3jf07C.js";import{h as head}from"../chunks/twIkBoiu.js";import{s as set_attribute}from"../chunks/DTBsVM-c.js";import{d as delegate}from"../chunks/DiU70Is3.js";import{b as store_set,s as setup_stores}from"../chunks/CViNpZsE.js";import{a as browser_ext,b as browserSvelte}from"../chunks/CgCfpVku.js";import{p as page}from"../chunks/eULPtkAc.js";import{b as yakklDappConnectRequestStore,l as log$1,an as DEFAULT_TITLE,Y as YAKKL_DAPP,g as getSettings}from"../chunks/Cb2naUpm.js";import{C as Copyright}from"../chunks/w2W0-xnm.js";import{c as createPortManagerWithStream,F as Failed}from"../chunks/tXuNREEA.js";import"../chunks/DwnXGTX-.js";import{C as Confirmation}from"../chunks/BWiVuumU.js";import{s as safeLogout,a as safeNavigate}from"../chunks/COpD6KvM.js";import{l as log}from"../chunks/WDN37msH.js";async function safeClientSendMessage(message,timeoutMs=3e3){return new Promise((resolve,reject)=>{let isSettled=false;log.info("safeClientSendMessage",false,{message:message});const timeout=setTimeout(()=>{if(!isSettled){isSettled=true;reject(new Error(`safeClientSendMessage timed out after ${timeoutMs} ms`))}},timeoutMs);try{browser_ext.runtime.sendMessage(message).then(response=>{if(!isSettled){clearTimeout(timeout);isSettled=true;resolve(response)}}).catch(err=>{if(!isSettled){clearTimeout(timeout);isSettled=true;reject(err)}})}catch(err){if(!isSettled){clearTimeout(timeout);reject(err)}}})}_page[FILENAME]="src/routes/(dapp)/dapp/popups/approve/+page.svelte";function handleApprove(_,showConfirm){set(showConfirm,true)}var on_click=(__1,handleReject)=>handleReject();var root_2=add_locations(from_html(`<h2 class="text-xl font-bold mb-2">Security Risk</h2>`),_page[FILENAME],[[234,4]]);var root_3=add_locations(from_html(`<h2 class="text-xl font-bold mb-2">Connection Request</h2> <p class="text-base-content/80">This site would like to:</p>`,1),_page[FILENAME],[[236,4],[237,4]]);var root_4=add_locations(from_html(`<span>1. Request approval to connect to your wallet addresses</span>`),_page[FILENAME],[[258,5]]);var root_6=add_locations(from_html(`<span>1. Request approval to send a transaction</span>`),_page[FILENAME],[[260,5]]);var root_8=add_locations(from_html(`<span>1. Request approval to sign a message</span>`),_page[FILENAME],[[262,5]]);var root_10=add_locations(from_html(`<span>1. Request approval to connect to your wallet addresses</span>`),_page[FILENAME],[[265,5]]);var root_12=add_locations(from_html(`<span>1. Request approval to switch to a different network</span>`),_page[FILENAME],[[267,5]]);var root_13=add_locations(from_html(`<span> </span>`),_page[FILENAME],[[271,5]]);var on_click_1=(__2,handleReject,method)=>handleReject("Unsupported method - Security risk: "+get(method));var root_16=add_locations(from_html(`<button class="btn btn-primary svelte-16rhvk2">Reject</button>`),_page[FILENAME],[[309,4]]);var root_17=add_locations(from_html(`<button class="btn btn-primary svelte-16rhvk2"><!></button>`),_page[FILENAME],[[316,4]]);var root=add_locations(from_html(`<!> <!> <div class="flex flex-col h-full max-h-screen overflow-hidden"><div class="p-4 border-b border-base-300 flex-shrink-0"><div class="flex items-center justify-between"><div class="flex items-center gap-2 min-w-0"><img id="dappImageId" crossorigin="anonymous" alt="Dapp logo" class="w-8 h-8 rounded-full flex-shrink-0"/> <span class="font-semibold truncate"> </span></div> <button class="btn btn-ghost btn-sm flex-shrink-0 svelte-16rhvk2" aria-label="Close"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div></div> <div class="flex-1 p-4 flex flex-col max-w-[428px]"><div class="text-center mb-4 flex-shrink-0"><!></div> <div class="space-y-4 mb-4 overflow-y-auto flex-1 min-h-0 svelte-16rhvk2"><div class="flex items-center gap-3 p-3 bg-base-200 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <!></div></div> <div class="bg-base-200 rounded-lg p-4 mb-4 flex-shrink-0"><p class="text-sm text-base-content/70"><!></p></div></div> <div class="p-4 border-t border-base-300 flex-shrink-0"><div class="flex gap-4 justify-end"><!></div></div></div> <!>`,1),_page[FILENAME],[[195,0,[[197,1,[[198,2,[[199,3,[[200,4],[207,4]]],[209,3,[[214,4,[[220,5]]]]]]]]],[231,1,[[232,2],[241,2,[[242,3,[[243,4,[[250,5]]]]]]],[293,2,[[294,3]]]]],[306,1,[[307,2]]]]]]);function _page($$anchor,$$props){check_target(new.target);push($$props,true,_page);const[$$stores,$$cleanup]=setup_stores();let showConfirm=tag(state(false),"showConfirm");let showSuccess=false;let showFailure=tag(state(false),"showFailure");let errorValue=tag(state("No domain/site name was found. Access to YAKKL® is denied."),"errorValue");let domain=tag(state(""),"domain");let domainLogo=tag(state(""),"domainLogo");let domainTitle=tag(state(""),"domainTitle");let title=tag(state(proxy(DEFAULT_TITLE)),"title");let requestId=null;let method=tag(state(""),"method");let message;let portManager=createPortManagerWithStream(YAKKL_DAPP);if(browserSvelte){try{requestId=page.url.searchParams.get("requestId");const methodParam=page.url.searchParams.get("method");if(methodParam)set(method,methodParam,true);store_set(yakklDappConnectRequestStore,requestId)}catch(e){log$1.error(e);handleReject("No requestId or methodwas found. Access to YAKKL® is denied.")}}async function handleProcess(){if(!browserSvelte)return;try{sessionStorage.setItem("yakklSigningRequest",JSON.stringify({requestId:requestId,method:get(method)}));return safeNavigate("/dapp/login?requestId="+requestId+"&method="+get(method))}catch(e){set(errorValue,e,true);set(showFailure,true)}}async function onMessageListener(event){var _a,_b;if(!browserSvelte)return;try{if(!get(domainLogo))set(domainLogo,"/images/failIcon48x48.png");if(strict_equals(event.method,"get_params")){if(!((_a=event==null?void 0:event.result)==null?void 0:_a.data)){await handleReject("No request data was found. Access to YAKKL® is denied.");return}const requestData=event.result.data;const metaData=((_b=requestData.metaData)==null?void 0:_b.metaData)||requestData.metaData;if(!metaData){await handleReject("Invalid request data structure. Access to YAKKL® is denied.");return}set(domainTitle,metaData.title,true);set(domain,metaData.domain,true);set(domainLogo,metaData.icon??"/images/failIcon48x48.png",true);message=metaData.message??"Nothing was passed to explain the intent of this approval. Be mindful of this request!";if(!requestId)requestId=(requestData==null?void 0:requestData.id)??null;if(!requestId){await handleReject("No request ID was found. Access to YAKKL® is denied.");return}set(title,get(domainTitle)||get(domain)||DEFAULT_TITLE,true)}}catch(e){log$1.error(e)}}onMount(async()=>{try{if(browserSvelte){set(domainLogo,"/images/failIcon48x48.png");const settings=await getSettings();if(!settings.init||!settings.legal.termsAgreed){set(errorValue,"You must register and agree to the terms of service before using YAKKL®. Click on 'Open Wallet' to register.");set(showFailure,true);return}await safeClientSendMessage({type:"clientReady"});const storedRequest=sessionStorage.getItem("yakklSigningRequest");if(storedRequest){const{requestId:storedRequestId,method:storedMethod}=JSON.parse(storedRequest);requestId=storedRequestId;set(method,storedMethod,true);sessionStorage.removeItem("yakklSigningRequest")}if(!requestId){set(errorValue,"Missing request ID");set(showFailure,true);return}const ok=await portManager.createPort();if(ok){const stream=portManager.getStream();stream==null?void 0:stream.on("data",onMessageListener);stream==null?void 0:stream.write({method:"get_params",id:requestId})}log$1.info("Approve: BEFORE - REGISTER_SESSION_PORT - requestId and port:",false,requestId,portManager.getPort());portManager.setRequestId(requestId);await safeClientSendMessage({type:"REGISTER_SESSION_PORT",port:portManager.getPort(),requestId:requestId});log$1.info("Approve: AFTER - REGISTER_SESSION_PORT - requestId and port:",false,requestId,portManager.getPort())}}catch(e){log$1.error(e)}});async function handleReject(message2="User rejected the request."){try{set(showConfirm,false);set(showFailure,false);showSuccess=false;set(errorValue,"");const port=portManager==null?void 0:portManager.getPort();if(port){port.postMessage({id:requestId,method:"error",response:{type:"YAKKL_RESPONSE",data:{name:"ProviderRpcError",code:4001,message:message2}}})}try{if(portManager){await portManager.waitForIdle(1500);portManager.disconnect()}}catch(e){log$1.warn("Port did not go idle in time",false,e)}}catch(e){log$1.error(e)}finally{safeLogout()}}var fragment=root();head($$anchor2=>{template_effect(()=>$document.title=get(title))});var node=first_child(fragment);Failed(node,{title:"Failed!",get content(){return get(errorValue)},onReject:handleReject,get show(){return get(showFailure)},set show($$value){set(showFailure,$$value,true)}});var node_1=sibling(node,2);Confirmation(node_1,{get title(){return`Connect to ${get(domain)??""}`},get message(){return`This will connect ${get(domain)??""} to YAKKL®. Do you wish to continue?`},onConfirm:handleProcess,onReject:handleReject,get show(){return get(showConfirm)},set show($$value){set(showConfirm,$$value,true)}});var div=sibling(node_1,2);var div_1=child(div);var div_2=child(div_1);var div_3=child(div_2);var img=child(div_3);var span=sibling(img,2);var text$1=child(span,true);reset(span);reset(div_3);var button=sibling(div_3,2);button.__click=[on_click,handleReject];reset(div_2);reset(div_1);var div_4=sibling(div_1,2);var div_5=child(div_4);var node_2=child(div_5);{var consequent=$$anchor2=>{var h2=root_2();append($$anchor2,h2)};var alternate=$$anchor2=>{var fragment_1=root_3();next(2);append($$anchor2,fragment_1)};if_block(node_2,$$render=>{if(strict_equals(get(method),"eth_requestAccounts",false)&&strict_equals(get(method),"eth_sendTransaction",false)&&strict_equals(get(method),"eth_signTypedData_v4",false)&&strict_equals(get(method),"personal_sign",false))$$render(consequent);else $$render(alternate,false)})}reset(div_5);var div_6=sibling(div_5,2);var div_7=child(div_6);var node_3=sibling(child(div_7),2);{var consequent_1=$$anchor2=>{var span_1=root_4();append($$anchor2,span_1)};var alternate_1=($$anchor2,$$elseif)=>{{var consequent_2=$$anchor3=>{var span_2=root_6();append($$anchor3,span_2)};var alternate_2=($$anchor3,$$elseif2)=>{{var consequent_3=$$anchor4=>{var span_3=root_8();append($$anchor4,span_3)};var alternate_3=($$anchor4,$$elseif3)=>{{var consequent_4=$$anchor5=>{var span_4=root_10();append($$anchor5,span_4)};var alternate_4=($$anchor5,$$elseif4)=>{{var consequent_5=$$anchor6=>{var span_5=root_12();append($$anchor6,span_5)};var alternate_5=$$anchor6=>{var span_6=root_13();var text_1=child(span_6);reset(span_6);template_effect(()=>set_text(text_1,`Request approval for '${get(method)??""}' but it is not supported by YAKKL® due to security\n\t\t\t\t\t\tconcerns.`));append($$anchor6,span_6)};if_block($$anchor5,$$render=>{if(strict_equals(get(method),"wallet_switchEthereumChain"))$$render(consequent_5);else $$render(alternate_5,false)},$$elseif4)}};if_block($$anchor4,$$render=>{if(strict_equals(get(method),"wallet_requestPermissions")||strict_equals(get(method),"wallet_revokePermissions")||strict_equals(get(method),"wallet_getPermissions"))$$render(consequent_4);else $$render(alternate_4,false)},$$elseif3)}};if_block($$anchor3,$$render=>{if(strict_equals(get(method),"eth_signTypedData_v4")||strict_equals(get(method),"personal_sign")||strict_equals(get(method),"eth_signTransaction"))$$render(consequent_3);else $$render(alternate_3,false)},$$elseif2)}};if_block($$anchor2,$$render=>{if(strict_equals(get(method),"eth_sendTransaction"))$$render(consequent_2);else $$render(alternate_2,false)},$$elseif)}};if_block(node_3,$$render=>{if(strict_equals(get(method),"eth_requestAccounts"))$$render(consequent_1);else $$render(alternate_1,false)})}reset(div_7);reset(div_6);var div_8=sibling(div_6,2);var p=child(div_8);var node_4=child(p);{var consequent_6=$$anchor2=>{var text_2=text("The request is a possible security risk and not allowed!");append($$anchor2,text_2)};var alternate_6=$$anchor2=>{var text_3=text("By connecting, you agree to allow this site to connect to your addresses. Any signing or\n\t\t\t\t\ttransaction requests will have an additional approval step.");append($$anchor2,text_3)};if_block(node_4,$$render=>{if(strict_equals(get(method),"eth_requestAccounts",false)&&strict_equals(get(method),"eth_sendTransaction",false)&&strict_equals(get(method),"eth_signTypedData_v4",false)&&strict_equals(get(method),"personal_sign",false)&&strict_equals(get(method),"eth_signTransaction",false)&&strict_equals(get(method),"wallet_requestPermissions",false)&&strict_equals(get(method),"wallet_revokePermissions",false)&&strict_equals(get(method),"wallet_getPermissions",false)&&strict_equals(get(method),"wallet_switchEthereumChain",false))$$render(consequent_6);else $$render(alternate_6,false)})}reset(p);reset(div_8);reset(div_4);var div_9=sibling(div_4,2);var div_10=child(div_9);var node_5=child(div_10);{var consequent_7=$$anchor2=>{var button_1=root_16();button_1.__click=[on_click_1,handleReject,method];append($$anchor2,button_1)};var alternate_7=$$anchor2=>{var button_2=root_17();button_2.__click=[handleApprove,showConfirm];var node_6=child(button_2);{var consequent_8=$$anchor3=>{var text_4=text("Connect");append($$anchor3,text_4)};var alternate_8=($$anchor3,$$elseif)=>{{var consequent_9=$$anchor4=>{var text_5=text("Approve Transaction");append($$anchor4,text_5)};var alternate_9=($$anchor4,$$elseif2)=>{{var consequent_10=$$anchor5=>{var text_6=text("Approve Signing");append($$anchor5,text_6)};var alternate_10=($$anchor5,$$elseif3)=>{{var consequent_11=$$anchor6=>{var text_7=text("Approve Connection");append($$anchor6,text_7)};var alternate_11=($$anchor6,$$elseif4)=>{{var consequent_12=$$anchor7=>{var text_8=text("Revoke Connection");append($$anchor7,text_8)};var alternate_12=($$anchor7,$$elseif5)=>{{var consequent_13=$$anchor8=>{var text_9=text("View Permissions");append($$anchor8,text_9)};var alternate_13=($$anchor8,$$elseif6)=>{{var consequent_14=$$anchor9=>{var text_10=text("Switch Network");append($$anchor9,text_10)};if_block($$anchor8,$$render=>{if(strict_equals(get(method),"wallet_switchEthereumChain"))$$render(consequent_14)},$$elseif6)}};if_block($$anchor7,$$render=>{if(strict_equals(get(method),"wallet_getPermissions"))$$render(consequent_13);else $$render(alternate_13,false)},$$elseif5)}};if_block($$anchor6,$$render=>{if(strict_equals(get(method),"wallet_revokePermissions"))$$render(consequent_12);else $$render(alternate_12,false)},$$elseif4)}};if_block($$anchor5,$$render=>{if(strict_equals(get(method),"wallet_requestPermissions"))$$render(consequent_11);else $$render(alternate_11,false)},$$elseif3)}};if_block($$anchor4,$$render=>{if(strict_equals(get(method),"eth_signTypedData_v4")||strict_equals(get(method),"personal_sign")||strict_equals(get(method),"eth_signTransaction"))$$render(consequent_10);else $$render(alternate_10,false)},$$elseif2)}};if_block($$anchor3,$$render=>{if(strict_equals(get(method),"eth_sendTransaction"))$$render(consequent_9);else $$render(alternate_9,false)},$$elseif)}};if_block(node_6,$$render=>{if(strict_equals(get(method),"eth_requestAccounts"))$$render(consequent_8);else $$render(alternate_8,false)})}reset(button_2);append($$anchor2,button_2)};if_block(node_5,$$render=>{if(strict_equals(get(method),"eth_requestAccounts",false)&&strict_equals(get(method),"eth_sendTransaction",false)&&strict_equals(get(method),"eth_signTypedData_v4",false)&&strict_equals(get(method),"personal_sign",false)&&strict_equals(get(method),"eth_signTransaction",false)&&strict_equals(get(method),"wallet_requestPermissions",false)&&strict_equals(get(method),"wallet_revokePermissions",false)&&strict_equals(get(method),"wallet_getPermissions",false)&&strict_equals(get(method),"wallet_switchEthereumChain",false))$$render(consequent_7);else $$render(alternate_7,false)})}reset(div_10);reset(div_9);reset(div);var node_7=sibling(div,2);Copyright(node_7,{});template_effect(()=>{set_attribute(img,"src",get(domainLogo));set_text(text$1,get(title))});append($$anchor,fragment);var $$pop=pop({...legacy_api()});$$cleanup();return $$pop}delegate(["click"]);export{_page as component};
//# sourceMappingURL=20.C-YjSPjI.js.map
