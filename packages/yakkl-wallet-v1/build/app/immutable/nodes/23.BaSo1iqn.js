import{c as check_target,l as legacy_api}from"../chunks/BXFaAXnq.js";import{p as push,h as tag,i as state,ae as proxy,e as set,o as onMount,f as first_child,c as child,t as template_effect,a as pop,g as get,s as sibling,F as FILENAME,b as strict_equals,$ as $document,r as reset}from"../chunks/BaS8d5lg.js";import{a as add_locations}from"../chunks/3AhEABF_.js";import{s as set_text}from"../chunks/Cmwrv3PW.js";import{i as if_block}from"../chunks/Q1yPWpQ-.js";import{a as append,f as from_html}from"../chunks/Cm3jf07C.js";import{v as validate_store}from"../chunks/Dv9a3G0k.js";import{h as head}from"../chunks/twIkBoiu.js";import{s as set_attribute}from"../chunks/DTBsVM-c.js";import{s as set_class}from"../chunks/DX_EEhpR.js";import{d as delegate}from"../chunks/DiU70Is3.js";import{b as store_set,s as setup_stores,a as store_get}from"../chunks/CViNpZsE.js";import{b as browserSvelte,a as browser_ext}from"../chunks/CgCfpVku.js";import{b as yakklDappConnectRequestStore,l as log,an as DEFAULT_TITLE,o as getYakklAccounts,x as isEncryptedData,z as decryptData,g as getSettings,C as getYakklCurrentlySelected,h as getMiscStore,Y as YAKKL_DAPP,U as ETH_BASE_SCA_GAS_UNITS,X as ETH_BASE_EOA_GAS_UNITS,ao as getYakklConnectedDomains}from"../chunks/Cb2naUpm.js";import{p as page}from"../chunks/eULPtkAc.js";import"../chunks/WDN37msH.js";import{W as WalletManager}from"../chunks/BJK8DTVo.js";import{v as verifySessionToken,b as sessionToken}from"../chunks/CMG1aIle.js";import{C as Confirmation}from"../chunks/BWiVuumU.js";import"../chunks/DwnXGTX-.js";import{F as Failed,c as createPortManagerWithStream}from"../chunks/tXuNREEA.js";import{s as safeLogout}from"../chunks/COpD6KvM.js";import{e as formatEther}from"../chunks/CnIbzB-6.js";import{P as PincodeVerify}from"../chunks/Fc_LhyTR.js";_page[FILENAME]="src/routes/(dapp)/dapp/popups/transactions/+page.svelte";function handleConfirm(_,showConfirm){set(showConfirm,true)}var on_click=(__1,handleReject)=>handleReject();var root_3=add_locations(from_html(`<div class="flex justify-between items-center svelte-kdh5qs"><span class="font-medium svelte-kdh5qs">Data:</span> <span class="text-sm truncate max-w-[200px] svelte-kdh5qs"> </span></div>`),_page[FILENAME],[[405,6,[[406,7],[407,7]]]]);var root_4=add_locations(from_html(`<div class="alert alert-error mt-4 svelte-kdh5qs"><svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6 svelte-kdh5qs" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" class="svelte-kdh5qs"></path></svg> <span class="svelte-kdh5qs">Address not connected to this domain</span></div>`),_page[FILENAME],[[413,5,[[414,6,[[419,8]]],[426,6]]]]);var root_5=add_locations(from_html(`<div class="flex flex-col items-center justify-center p-4 svelte-kdh5qs"><div class="loading loading-spinner loading-lg svelte-kdh5qs"></div> <p class="mt-2 font-bold animate-pulse svelte-kdh5qs">Processing transaction...</p></div>`),_page[FILENAME],[[432,4,[[433,5],[434,5]]]]);var on_click_1=(__2,handleReject)=>handleReject();var root_2=add_locations(from_html(`<div class="flex flex-col h-full max-h-screen overflow-hidden svelte-kdh5qs"><div class="p-4 border-b border-base-300 flex-shrink-0 svelte-kdh5qs"><div class="flex items-center justify-between svelte-kdh5qs"><div class="flex items-center gap-2 min-w-0 svelte-kdh5qs"><img crossorigin="anonymous" alt="Dapp logo" class="w-8 h-8 rounded-full flex-shrink-0 svelte-kdh5qs"/> <span class="font-semibold truncate svelte-kdh5qs"> </span></div> <button class="btn btn-ghost btn-sm flex-shrink-0 svelte-kdh5qs" aria-label="Close"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 svelte-kdh5qs" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" class="svelte-kdh5qs"></path></svg></button></div></div> <div class="flex-1 p-6 overflow-hidden flex flex-col svelte-kdh5qs"><div class="text-center mb-4 flex-shrink-0 svelte-kdh5qs"><h2 class="text-xl font-bold mb-2 svelte-kdh5qs">Transaction Request</h2> <p class="text-base-content/80 svelte-kdh5qs"> </p></div> <div class="overflow-y-auto flex-1 min-h-0 mb-4 svelte-kdh5qs"><div class="bg-base-200 rounded-lg p-4 space-y-3 svelte-kdh5qs"><div class="flex justify-between items-center border-b border-base-300 pb-2 svelte-kdh5qs"><span class="font-medium svelte-kdh5qs">From:</span> <span class="font-mono text-sm svelte-kdh5qs"> </span></div> <div class="flex justify-between items-center border-b border-base-300 pb-2 svelte-kdh5qs"><span class="font-medium svelte-kdh5qs">To:</span> <span class="font-mono text-sm svelte-kdh5qs"> </span></div> <div class="flex justify-between items-center border-b border-base-300 pb-2 svelte-kdh5qs"><span class="font-medium svelte-kdh5qs">Value:</span> <span class="font-bold text-primary svelte-kdh5qs"> </span></div> <div class="flex justify-between items-center border-b border-base-300 pb-2 svelte-kdh5qs"><span class="font-medium svelte-kdh5qs">Gas Limit:</span> <span class="svelte-kdh5qs"> </span></div> <!></div> <!></div> <!></div> <div class="p-4 border-t border-base-300 flex-shrink-0 svelte-kdh5qs"><div class="flex gap-4 justify-end svelte-kdh5qs"><button class="btn btn-outline svelte-kdh5qs">Reject</button> <button class="btn btn-primary svelte-kdh5qs">Approve</button></div></div></div>`),_page[FILENAME],[[345,1,[[347,2,[[348,3,[[349,4,[[350,5],[356,5]]],[358,4,[[363,5,[[369,6]]]]]]]]],[380,2,[[381,3,[[382,4],[383,4]]],[386,3,[[387,4,[[388,5,[[389,6],[390,6]]],[392,5,[[393,6],[394,6]]],[396,5,[[397,6],[398,6]]],[400,5,[[401,6],[402,6]]]]]]]]],[440,2,[[441,3,[[442,4],[443,4]]]]]]]]);var root=add_locations(from_html(`<!> <!> <!> <div><div class="modal-box relative svelte-kdh5qs"><h3 class="text-lg font-bold svelte-kdh5qs">Transaction Submitted!</h3> <p class="py-4 svelte-kdh5qs">Your transaction has been submitted to the blockchain.</p> <p class="text-sm svelte-kdh5qs"> </p> <div class="modal-action svelte-kdh5qs"><button class="btn svelte-kdh5qs">Close</button></div></div></div> <!>`,1),_page[FILENAME],[[333,0,[[334,1,[[335,2],[336,2],[337,2],[338,2,[[339,3]]]]]]]]);function _page($$anchor,$$props){check_target(new.target);push($$props,true,_page);const[$$stores,$$cleanup]=setup_stores();const $sessionToken=()=>(validate_store(sessionToken,"sessionToken"),store_get(sessionToken,"$sessionToken",$$stores));let currentlySelected;let wallet;let yakklMiscStore;let showConfirm=tag(state(false),"showConfirm");let showSuccess=tag(state(false),"showSuccess");let showFailure=tag(state(false),"showFailure");let showSpinner=tag(state(false),"showSpinner");let showPincode=tag(state(false),"showPincode");let errorValue=tag(state("No domain/site name was found. Access to YAKKL® is denied."),"errorValue");let chainId;let domain=tag(state(""),"domain");let domainLogo=tag(state(""),"domainLogo");let domainTitle=tag(state(""),"domainTitle");let title=tag(state(proxy(DEFAULT_TITLE)),"title");let method;let requestId;let message=tag(state(""),"message");let transaction=tag(state(proxy({})),"transaction");let transactionDisplay=tag(state(proxy({})),"transactionDisplay");let gasLimit=tag(state(0n),"gasLimit");let addressApproved=tag(state(false),"addressApproved");let tx=tag(state(null),"tx");let portManager=null;let stream=null;if(browserSvelte){try{requestId=page.url.searchParams.get("requestId");method=page.url.searchParams.get("method")||"eth_sendTransaction";store_set(yakklDappConnectRequestStore,requestId);if(!requestId){set(errorValue,"No request ID was found. Access to YAKKL® is denied.");set(showFailure,true)}}catch(e){log.error("Error parsing URL parameters:",false,e);set(errorValue,"Invalid request parameters. Access to YAKKL® is denied.");set(showFailure,true)}}async function onMessageListener(event){var _a;try{if(strict_equals(event.method,"get_params")){const request=event.result;if(!((_a=request==null?void 0:request.data)==null?void 0:_a.metaData)){await handleReject("Invalid request data. Access to YAKKL® is denied.");return}const requestData=request.data;const metaData=requestData.metaData.metaData;set(domainTitle,metaData.title||"",true);set(domain,metaData.domain||"",true);set(domainLogo,metaData.icon||"/images/failIcon48x48.png",true);set(message,metaData.message||"Transaction request from "+get(domain),true);set(title,get(domainTitle)||get(domain)||DEFAULT_TITLE,true);if(requestData.params&&requestData.params.length>0){set(transaction,requestData.params[0],true);await formatTransactionForDisplay();await verifyAddressConnection()}else{await handleReject("No transaction data found. Access to YAKKL® is denied.")}}}catch(e){log.error("Error processing message:",false,e);await handleReject("An error occurred while processing the request.")}}async function formatTransactionForDisplay(){var _a;set(transactionDisplay,{from:get(transaction).from,to:get(transaction).to,value:get(transaction).quantity?formatEther(get(transaction).quantity.toString())+" ETH":"0 ETH",data:get(transaction).data?`Data: ${get(transaction).data.slice(0,10)}...`:"No data",gasLimit:"Will be calculated",estimatedFee:"Calculating..."},true);if(!get(transaction).gasLimit){const blockchain=wallet==null?void 0:wallet.getBlockchain();if(blockchain==null?void 0:blockchain.isSmartContractSupported()){const isSmartContract=await blockchain.isSmartContract(get(transaction).to);set(gasLimit,isSmartContract?ETH_BASE_SCA_GAS_UNITS:ETH_BASE_EOA_GAS_UNITS,true);if(get(transaction).data){const dataLength=get(transaction).data.length-2;set(gasLimit,BigInt(get(gasLimit))+BigInt(dataLength*68))}}else{set(gasLimit,ETH_BASE_EOA_GAS_UNITS,true)}if((_a=currentlySelected==null?void 0:currentlySelected.shortcuts)==null?void 0:_a.gasLimit){set(gasLimit,currentlySelected.shortcuts.gasLimit,true)}get(transactionDisplay).gasLimit=get(gasLimit).toString()}}async function verifyAddressConnection(){const addressToCheck=get(transaction).from;const connectedDomains=await getYakklConnectedDomains();for(const domainInfo of connectedDomains){if(strict_equals(domainInfo.domain,get(domain))){const connectedAddress=domainInfo.addresses.find(addr=>strict_equals(addr.address.toLowerCase(),addressToCheck.toLowerCase()));if(connectedAddress){set(addressApproved,true);break}}}if(!get(addressApproved)){set(errorValue,`The address ${addressToCheck} is not connected to ${get(domain)}. Please connect the address first.`);set(showFailure,true)}}onMount(async()=>{try{if(browserSvelte){const settings=await getSettings();if(!settings.init||!settings.legal.termsAgreed){set(errorValue,"You must register and agree to the terms of service before using YAKKL®. Click on 'Open Wallet' to register.");set(showFailure,true);return}currentlySelected=await getYakklCurrentlySelected();yakklMiscStore=getMiscStore();chainId=currentlySelected.shortcuts.chainId;wallet=WalletManager.getInstance(["Alchemy"],["Ethereum"],chainId,"pBm4VA9q8Laz9x3bmXTNZ9m-ArxczEWk");const sessionInfo=await browser_ext.runtime.sendMessage({type:"REQUEST_SESSION_PORT",requestId:requestId});if(!(sessionInfo==null?void 0:sessionInfo.success)){log.warn("Failed to verify session port. No response received. Using YAKKL_DAPP.")}portManager=createPortManagerWithStream(sessionInfo.portName||YAKKL_DAPP);portManager.setRequestId(requestId);const success=await portManager.createPort();if(!success){set(errorValue,"Failed to connect to background service.");set(showFailure,true);return}stream=portManager.getStream();if(!stream){set(errorValue,"Communication stream unavailable.");set(showFailure,true);return}stream.on("data",onMessageListener);stream.write({method:"get_params",id:requestId})}}catch(e){log.error("Initialization error:",false,e);set(errorValue,"Failed to initialize transaction approval.");set(showFailure,true)}});async function handleReject(message2="User rejected the request."){try{set(showConfirm,false);set(showFailure,false);set(showSuccess,false);if(stream){stream.write({type:"YAKKL_RESPONSE:EIP6963",jsonrpc:"2.0",id:requestId,error:{code:4001,message:message2}})}}catch(e){log.error("Error sending rejection:",false,e)}finally{await close()}}async function handleApprove(){var _a;try{set(showConfirm,false);if(!verifySessionToken($sessionToken())){await handleReject("Session expired. Please log in again.");return}set(showSpinner,true);const accounts=await getYakklAccounts();const account=accounts.find(acc=>{var _a2;return strict_equals(acc.address.toLowerCase(),(_a2=get(transaction).from)==null?void 0:_a2.toLowerCase())});if(!account){await handleReject("Account not found.");return}if(isEncryptedData(account.data)){account.data=await decryptData(account.data,yakklMiscStore)}if(!account.data.privateKey){await handleReject("Account key not available.");return}get(transaction).gasLimit=get(gasLimit);get(transaction).nonce=-1;get(transaction).type=2;get(transaction).chainId=chainId;set(tx,await wallet.sendTransaction(get(transaction)),true);if((_a=get(tx))==null?void 0:_a.hash){if(stream){const response={type:"YAKKL_RESPONSE:EIP6963",jsonrpc:"2.0",id:requestId,result:get(tx).hash};stream.write(response)}get(tx).wait().then(async()=>{set(showSuccess,true);setTimeout(async()=>{await close()},2e3)}).catch(error=>{set(errorValue,`Transaction failed: ${error.message}`);set(showFailure,true);set(showSpinner,false)})}else{throw new Error("No transaction hash received")}}catch(e){log.error("Transaction error:",false,e);set(errorValue,e instanceof Error?e.message:"Transaction failed",true);set(showFailure,true);set(showSpinner,false)}}async function close(){if(browserSvelte){if(portManager){try{await portManager.waitForIdle(1500);portManager.disconnect()}catch(e){log.warn("Port did not go idle in time",false,e)}}set(showSpinner,false);safeLogout()}}var fragment=root();head($$anchor2=>{template_effect(()=>$document.title=get(title))});var node=first_child(fragment);Failed(node,{title:"Failed!",get content(){return get(errorValue)},onReject:handleReject,get show(){return get(showFailure)},set show($$value){set(showFailure,$$value,true)}});var node_1=sibling(node,2);Confirmation(node_1,{title:"Approve Transaction",message:"Are you sure you want to send this transaction? This action cannot be undone.",onConfirm:handleApprove,get show(){return get(showConfirm)},set show($$value){set(showConfirm,$$value,true)}});var node_2=sibling(node_1,2);PincodeVerify(node_2,{onVerified:handleApprove,get show(){return get(showPincode)},set show($$value){set(showPincode,$$value,true)}});var div=sibling(node_2,2);let classes;var div_1=child(div);var p=sibling(child(div_1),4);var text=child(p);reset(p);var div_2=sibling(p,2);var button=child(div_2);button.__click=close;reset(div_2);reset(div_1);reset(div);var node_3=sibling(div,2);{var consequent_3=$$anchor2=>{var div_3=root_2();var div_4=child(div_3);var div_5=child(div_4);var div_6=child(div_5);var img=child(div_6);var span=sibling(img,2);var text_1=child(span,true);reset(span);reset(div_6);var button_1=sibling(div_6,2);button_1.__click=[on_click,handleReject];reset(div_5);reset(div_4);var div_7=sibling(div_4,2);var div_8=child(div_7);var p_1=sibling(child(div_8),2);var text_2=child(p_1,true);reset(p_1);reset(div_8);var div_9=sibling(div_8,2);var div_10=child(div_9);var div_11=child(div_10);var span_1=sibling(child(div_11),2);var text_3=child(span_1,true);reset(span_1);reset(div_11);var div_12=sibling(div_11,2);var span_2=sibling(child(div_12),2);var text_4=child(span_2,true);reset(span_2);reset(div_12);var div_13=sibling(div_12,2);var span_3=sibling(child(div_13),2);var text_5=child(span_3,true);reset(span_3);reset(div_13);var div_14=sibling(div_13,2);var span_4=sibling(child(div_14),2);var text_6=child(span_4,true);reset(span_4);reset(div_14);var node_4=sibling(div_14,2);{var consequent=$$anchor3=>{var div_15=root_3();var span_5=sibling(child(div_15),2);var text_7=child(span_5,true);reset(span_5);reset(div_15);template_effect(()=>set_text(text_7,get(transactionDisplay).data));append($$anchor3,div_15)};if_block(node_4,$$render=>{if(get(transaction).data)$$render(consequent)})}reset(div_10);var node_5=sibling(div_10,2);{var consequent_1=$$anchor3=>{var div_16=root_4();append($$anchor3,div_16)};if_block(node_5,$$render=>{if(!get(addressApproved))$$render(consequent_1)})}reset(div_9);var node_6=sibling(div_9,2);{var consequent_2=$$anchor3=>{var div_17=root_5();append($$anchor3,div_17)};if_block(node_6,$$render=>{if(get(showSpinner))$$render(consequent_2)})}reset(div_7);var div_18=sibling(div_7,2);var div_19=child(div_18);var button_2=child(div_19);button_2.__click=[on_click_1,handleReject];var button_3=sibling(button_2,2);button_3.__click=[handleConfirm,showConfirm];reset(div_19);reset(div_18);reset(div_3);template_effect(()=>{set_attribute(img,"src",get(domainLogo));set_text(text_1,get(domainTitle)||get(domain));set_text(text_2,get(message));set_text(text_3,get(transactionDisplay).from);set_text(text_4,get(transactionDisplay).to);set_text(text_5,get(transactionDisplay).value);set_text(text_6,get(transactionDisplay).gasLimit);button_3.disabled=!get(addressApproved)||get(showSpinner)});append($$anchor2,div_3)};if_block(node_3,$$render=>{if(!get(showConfirm)&&!get(showSuccess)&&!get(showFailure))$$render(consequent_3)})}template_effect($0=>{var _a;classes=set_class(div,1,"modal svelte-kdh5qs",null,classes,$0);set_text(text,`Transaction Hash: ${((_a=get(tx))==null?void 0:_a.hash)??""}`)},[()=>({"modal-open":get(showSuccess)})]);append($$anchor,fragment);var $$pop=pop({...legacy_api()});$$cleanup();return $$pop}delegate(["click"]);export{_page as component};
//# sourceMappingURL=23.BaSo1iqn.js.map
