{"version":3,"file":"CZAHYQZy.js","sources":["../../../../../../src/lib/managers/providers/price/coingecko/CoingeckoPriceProvider.ts","../../../../../../src/lib/managers/PriceManager.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { fetchJson } from '@ethersproject/web';\nimport type { MarketPriceData, PriceProvider } from '$lib/common/interfaces';\nimport { splitWords } from '$lib/utilities';\nimport { log } from '$lib/managers/Logger';\n\n// Coingecko public API pulls from a number of exchanges.\n// Coingecko does not update their prices as frequently as other providers so it may appear that prices look like an arbitrage opportunity but it may not be.\nexport class CoingeckoPriceProvider implements PriceProvider {\n\tgetAPIKey(): string {\n\t\treturn import.meta.env.VITE_COINGECKO_API_KEY;\n\t}\n\n\tgetName() {\n\t\treturn 'Coingecko';\n\t}\n\n\tasync getMarketPrice(pair: string): Promise<MarketPriceData> {\n\t\ttry {\n\t\t\tif (!pair) {\n\t\t\t\treturn {\n\t\t\t\t\tprovider: this.getName(),\n\t\t\t\t\tprice: 0,\n\t\t\t\t\tlastUpdated: new Date(),\n\t\t\t\t\tstatus: 404,\n\t\t\t\t\tmessage: `Invalid pair - ${pair}`\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tconst [name, currencySymbol] = await this.getProviderPairFormat(pair);\n\t\t\tif (!name || !currencySymbol) {\n\t\t\t\treturn {\n\t\t\t\t\tprovider: this.getName(),\n\t\t\t\t\tprice: 0,\n\t\t\t\t\tlastUpdated: new Date(),\n\t\t\t\t\tstatus: 404,\n\t\t\t\t\tmessage: `Invalid pair - ${pair}`\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tconst json = await fetchJson({\n\t\t\t\turl: `https://pro-api.coingecko.com/api/v3/simple/price?ids=${name}&include_last_updated_at=true&vs_currencies=${currencySymbol}`,\n\t\t\t\theaders: {\n\t\t\t\t\tAccept: 'application/json',\n\t\t\t\t\t'x-cg-pro-api-key': this.getAPIKey()\n\t\t\t\t}\n\t\t\t});\n\t\t\tconst priceData = json[name.toLowerCase()];\n\n\t\t\tif (!priceData || !priceData[currencySymbol.toLowerCase()]) {\n\t\t\t\tthrow new Error('Invalid JSON structure or missing data from Coingecko');\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tprovider: this.getName(),\n\t\t\t\tprice: parseFloat(priceData[currencySymbol.toLowerCase()]),\n\t\t\t\tlastUpdated: new Date(priceData.last_updated_at * 1000),\n\t\t\t\tcurrency: currencySymbol,\n\t\t\t\tstatus: 0,\n\t\t\t\tmessage: 'Success'\n\t\t\t};\n\t\t} catch (e: any) {\n\t\t\tlog.error('CoingeckoPriceProvider - getPrice - error', e);\n\n\t\t\tlet status = 404; // Default status\n\t\t\tlet message = `Error - ${e}`;\n\n\t\t\tif (e.response && e.response.status === 429) {\n\t\t\t\t// Handle 429 Too Many Requests error\n\t\t\t\tstatus = 429;\n\t\t\t\tmessage = 'Too Many Requests - Rate limit exceeded';\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tprovider: this.getName(),\n\t\t\t\tprice: 0,\n\t\t\t\tlastUpdated: new Date(),\n\t\t\t\tstatus,\n\t\t\t\tmessage\n\t\t\t};\n\t\t}\n\t}\n\n\tasync getProviderPairFormat(pair: string): Promise<[string, string]> {\n\t\tlet name: string = '';\n\t\tconst [symbol, currencySymbol] = splitWords(pair, '-');\n\n\t\tif (!symbol || !currencySymbol) {\n\t\t\treturn ['', ''];\n\t\t}\n\n\t\t// symbol to name mapping needs to be updated at times. You can find the list at https://api.coingecko.com/api/v3/coins/list?include_platform=true&status=active\n\t\t// NOTE: This is not a complete list. You may need to add more symbols as needed. Also, the symbol may not match the name exactly.\n\t\tswitch (symbol) {\n\t\t\tcase 'ETH':\n\t\t\tcase 'WETH':\n\t\t\t\tname = 'ethereum';\n\t\t\t\tbreak;\n\t\t\tcase 'BTC':\n\t\t\t\tname = 'bitcoin';\n\t\t\t\tbreak;\n\t\t\tcase 'USDC':\n\t\t\t\tname = 'usd-coin';\n\t\t\t\tbreak;\n\t\t\tcase 'DAI':\n\t\t\t\tname = 'dai';\n\t\t\t\tbreak;\n\t\t\tcase 'USDT':\n\t\t\t\tname = 'tether';\n\t\t\t\tbreak;\n\t\t\tcase 'BUSD':\n\t\t\t\tname = 'binance-usd';\n\t\t\t\tbreak;\n\t\t\tcase 'WBTC':\n\t\t\t\tname = 'wrapped-bitcoin';\n\t\t\t\tbreak;\n\t\t\tcase 'SOL':\n\t\t\t\tname = 'solana';\n\t\t\t\tbreak;\n\t\t\tcase 'MATIC':\n\t\t\t\tname = 'matic-network';\n\t\t\t\tbreak;\n\t\t\tcase 'BNB':\n\t\t\t\tname = 'binance-coin';\n\t\t\t\tbreak;\n\t\t\tcase 'AVAX':\n\t\t\t\tname = 'avalanche-2';\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\t// TBD: Add more symbols as needed. May want to add a mapping file for this that only loads when not found in above list. This will need to be implemented in a dynamically generated function call.\n\t\t\t\tname = symbol.toLowerCase();\n\t\t\t\tbreak;\n\t\t}\n\t\treturn [name, currencySymbol];\n\t}\n}\n","import type { PriceData, PriceProvider, WeightedProvider } from '$lib/common/interfaces';\nimport { CoinbasePriceProvider } from './providers/price/coinbase/CoinbasePriceProvider';\nimport { CoingeckoPriceProvider } from './providers/price/coingecko/CoingeckoPriceProvider';\nimport { log } from '$lib/managers/Logger';\n\n// import { AlchemyPriceProvider } from './providers/price/alchemy/AlchemyPriceProvider';\n// import { KrakenPriceProvider } from './providers/price/kraken/KrakenPriceProvider';\n\nexport class PriceManager {\n\tprivate weightedProviders: WeightedProvider[];\n\tprivate totalWeight: number;\n\tprivate readonly DEFAULT_WEIGHT = 1;\n\n\tconstructor(weightedProviders: WeightedProvider[] = PriceManager.getDefaultProviders()) {\n\t\tif (!weightedProviders || weightedProviders.length === 0) {\n\t\t\tthrow new Error('At least one provider must be specified');\n\t\t}\n\n\t\tthis.weightedProviders = this.normalizeWeights(weightedProviders);\n\t\tthis.totalWeight = this.calculateTotalWeight();\n\t}\n\n\tstatic getDefaultProviders(): WeightedProvider[] {\n\t\treturn [\n\t\t\t// { provider: new AlchemyPriceProvider(), weight: 2 },\n\t\t\t{ provider: new CoinbasePriceProvider(), weight: 8 },\n\t\t\t{ provider: new CoingeckoPriceProvider(), weight: 5 }\n\t\t\t// { provider: new KrakenPriceProvider(), weight: 1 },\n\t\t\t// Add other providers with their weights...\n\t\t];\n\t}\n\n\tprivate normalizeWeights(providers: WeightedProvider[]): WeightedProvider[] {\n\t\tconst allZeroWeights = providers.every((wp) => wp.weight === 0);\n\t\tconst allEqualWeights = providers.every((wp) => wp.weight === providers[0].weight);\n\n\t\tif (allZeroWeights || allEqualWeights) {\n\t\t\t// If all weights are zero or equal, assign default weight to all\n\t\t\treturn providers.map((wp) => ({ ...wp, weight: this.DEFAULT_WEIGHT }));\n\t\t}\n\n\t\t// Replace any zero weights with the smallest non-zero weight\n\t\tconst smallestNonZeroWeight = Math.min(\n\t\t\t...providers.filter((wp) => wp.weight > 0).map((wp) => wp.weight)\n\t\t);\n\t\treturn providers.map((wp) => ({\n\t\t\t...wp,\n\t\t\tweight: wp.weight === 0 ? smallestNonZeroWeight : wp.weight\n\t\t}));\n\t}\n\n\tprivate calculateTotalWeight(): number {\n\t\treturn this.weightedProviders.reduce((sum, wp) => sum + wp.weight, 0);\n\t}\n\n\tpublic getAvailableProviders(): PriceProvider[] {\n\t\treturn this.weightedProviders.map((wp) => wp.provider);\n\t}\n\n\tasync getMarketPrice(pair: string, availableProviders?: PriceProvider[]): Promise<PriceData> {\n\t\tlet provider: PriceProvider | null = null;\n\t\tlet providersToUse: PriceProvider[] = [];\n\n\t\ttry {\n\t\t\tprovidersToUse = availableProviders || this.getAvailableProviders();\n\t\t\tif (providersToUse.length === 0) {\n\t\t\t\tthrow new Error('No providers available to fetch market price');\n\t\t\t}\n\n\t\t\tprovider = this.getWeightedRandomProvider(providersToUse);\n\t\t\tconst price = await provider.getMarketPrice(pair);\n\t\t\treturn price;\n\t\t} catch (error) {\n\t\t\tlog.error(`Error fetching price from ${provider.getName()}:`, false, error);\n\t\t\t// Retry with a different provider\n\t\t\treturn this.getMarketPrice(\n\t\t\t\tpair,\n\t\t\t\tprovidersToUse.filter((p) => p !== provider)\n\t\t\t); // Avoid circular error by excluding failed provider\n\t\t}\n\t}\n\n\tprivate getWeightedRandomProvider(providers: PriceProvider[]): PriceProvider {\n\t\tif (!providers || providers.length === 0) {\n\t\t\tlog.error('No providers available to fetch market price');\n\t\t\tthrow new Error('No providers available to fetch market price');\n\t\t}\n\n\t\tif (providers.length === 1) {\n\t\t\treturn providers[0];\n\t\t}\n\n\t\ttry {\n\t\t\tconst weightedProviders = this.weightedProviders.filter((wp) =>\n\t\t\t\tproviders.includes(wp.provider)\n\t\t\t);\n\t\t\tconst totalWeight = weightedProviders.reduce((sum, wp) => sum + wp.weight, 0);\n\n\t\t\tif (weightedProviders.every((wp) => wp.weight === weightedProviders[0].weight)) {\n\t\t\t\t// If all weights are equal, choose randomly\n\t\t\t\treturn weightedProviders[Math.floor(Math.random() * weightedProviders.length)].provider;\n\t\t\t}\n\n\t\t\tlet random = Math.random() * totalWeight;\n\n\t\t\tfor (const wp of weightedProviders) {\n\t\t\t\tif (random < wp.weight) {\n\t\t\t\t\treturn wp.provider;\n\t\t\t\t}\n\t\t\t\trandom -= wp.weight;\n\t\t\t}\n\n\t\t\t// This should never happen if weights are set correctly\n\t\t\treturn weightedProviders[0].provider;\n\t\t} catch (error) {\n\t\t\tlog.error('Error selecting weighted random provider:', false, error);\n\t\t\tthrow error;\n\t\t}\n\t}\n}\n"],"names":["CoingeckoPriceProvider","getAPIKey","getName","getMarketPrice","pair","provider","this","price","lastUpdated","Date","status","message","name","currencySymbol","getProviderPairFormat","json","fetchJson","url","headers","Accept","priceData","toLowerCase","Error","parseFloat","last_updated_at","currency","e","log","error","response","symbol","splitWords","PriceManager","constructor","weightedProviders","getDefaultProviders","__publicField","length","normalizeWeights","totalWeight","calculateTotalWeight","CoinbasePriceProvider","weight","providers","allZeroWeights","every","wp","allEqualWeights","map","DEFAULT_WEIGHT","smallestNonZeroWeight","Math","min","filter","reduce","sum","getAvailableProviders","availableProviders","providersToUse","getWeightedRandomProvider","p","includes","floor","random"],"mappings":"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"}